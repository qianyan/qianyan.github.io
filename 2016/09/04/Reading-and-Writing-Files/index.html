<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"qianyan.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="读取和写入文件数据一般都是存储在纯文本文件当中，存储的形式多种多样。本文，我会介绍如何在Clojure中读取和写入这些数据。 1. 打开文件新建文件hello.txt，放到resources目录，内容如下： 123hello world!hello lambeta!hello life! 新建4io.clj，输入程序： 123456(ns the-way-to-clojure.4io  (:req">
<meta property="og:type" content="article">
<meta property="og:title" content="Reading and Writing Files">
<meta property="og:url" content="https://qianyan.github.io/2016/09/04/Reading-and-Writing-Files/index.html">
<meta property="og:site_name" content="λ">
<meta property="og:description" content="读取和写入文件数据一般都是存储在纯文本文件当中，存储的形式多种多样。本文，我会介绍如何在Clojure中读取和写入这些数据。 1. 打开文件新建文件hello.txt，放到resources目录，内容如下： 123hello world!hello lambeta!hello life! 新建4io.clj，输入程序： 123456(ns the-way-to-clojure.4io  (:req">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-09-04T02:10:44.000Z">
<meta property="article:modified_time" content="2016-09-07T08:49:21.000Z">
<meta property="article:author" content="lambeta">
<meta property="article:tag" content="file">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://qianyan.github.io/2016/09/04/Reading-and-Writing-Files/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://qianyan.github.io/2016/09/04/Reading-and-Writing-Files/","path":"2016/09/04/Reading-and-Writing-Files/","title":"Reading and Writing Files"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Reading and Writing Files | λ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">λ</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">(conj clojurians me)</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96%E5%92%8C%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6"><span class="nav-number">1.</span> <span class="nav-text">读取和写入文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6"><span class="nav-number">1.1.</span> <span class="nav-text">1. 打开文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96%E6%89%80%E6%9C%89%E8%A1%8C"><span class="nav-number">1.1.1.</span> <span class="nav-text">读取所有行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#with-open%E5%AE%8F"><span class="nav-number">1.1.2.</span> <span class="nav-text">with-open宏</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E7%9A%84%E6%8A%80%E5%B7%A7"><span class="nav-number">1.2.</span> <span class="nav-text">2. 读取文件的技巧</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%AF%BB%E5%8F%96%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6"><span class="nav-number">1.3.</span> <span class="nav-text">3. 读取网络文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6"><span class="nav-number">1.4.</span> <span class="nav-text">4. 写入文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E5%A4%9A%E8%A1%8C%E8%AE%B0%E5%BD%95"><span class="nav-number">1.5.</span> <span class="nav-text">5. 多行记录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-%E6%9C%89%E7%BB%93%E6%9D%9F%E6%A0%87%E8%AF%86"><span class="nav-number">1.5.1.</span> <span class="nav-text">5.1 有结束标识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-%E6%97%A0%E7%BB%93%E6%9D%9F%E6%A0%87%E8%AF%86"><span class="nav-number">1.5.2.</span> <span class="nav-text">5.2 无结束标识</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">lambeta</p>
  <div class="site-description" itemprop="description">Elegance and familiarity are orthogonal</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">76</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2016/09/04/Reading-and-Writing-Files/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lambeta">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="λ">
      <meta itemprop="description" content="Elegance and familiarity are orthogonal">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Reading and Writing Files | λ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Reading and Writing Files
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-09-04 10:10:44" itemprop="dateCreated datePublished" datetime="2016-09-04T10:10:44+08:00">2016-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-07 16:49:21" itemprop="dateModified" datetime="2016-09-07T16:49:21+08:00">2016-09-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Clojure/" itemprop="url" rel="index"><span itemprop="name">Clojure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="读取和写入文件"><a href="#读取和写入文件" class="headerlink" title="读取和写入文件"></a>读取和写入文件</h2><p>数据一般都是存储在纯文本文件当中，存储的形式多种多样。本文，我会介绍如何在Clojure中读取和写入这些数据。</p>
<h3 id="1-打开文件"><a href="#1-打开文件" class="headerlink" title="1. 打开文件"></a>1. 打开文件</h3><p>新建文件<em>hello.txt</em>，放到<em>resources</em>目录，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hello world!</span><br><span class="line">hello lambeta!</span><br><span class="line">hello life!</span><br></pre></td></tr></table></figure>
<p>新建<em>4io.clj</em>，输入程序：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">ns</span></span> the-way-to-clojure.4io</span><br><span class="line">  (<span class="symbol">:require</span> [clojure.java.io <span class="symbol">:as</span> io]</span><br><span class="line">            [clojure.string <span class="symbol">:as</span> str]))</span><br><span class="line"></span><br><span class="line">(<span class="keyword">def</span> <span class="title">data-file</span> (<span class="name">io/resource</span> <span class="string">&quot;hello.txt&quot;</span>))</span><br><span class="line">(<span class="name"><span class="built_in">slurp</span></span> data-file) </span><br></pre></td></tr></table></figure>
<p>运行程序，输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;hello world! \nhello lambeta!\nhello life!\n&quot;</span><br></pre></td></tr></table></figure>
<h4 id="读取所有行"><a href="#读取所有行" class="headerlink" title="读取所有行"></a>读取所有行</h4><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">line-seq</span></span> (<span class="name">io/reader</span> data-file))</span><br><span class="line"><span class="comment">;;=&gt; (&quot;hello world!&quot; &quot;hello lambeta!&quot; &quot;hello life!&quot;)</span></span><br></pre></td></tr></table></figure>
<h4 id="with-open宏"><a href="#with-open宏" class="headerlink" title="with-open宏"></a>with-open宏</h4><p>with-open宏用于自动关闭打开的文件。</p>
<p>1.1 读取一行，如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">  (<span class="name"><span class="built_in">when-let</span></span> [line (<span class="name">.readLine</span> rdr)]</span><br><span class="line">    (<span class="name">println</span> line)))</span><br></pre></td></tr></table></figure>

<p>1.2 读取多行，如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;;; read multiple lines</span></span><br><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">  (<span class="name"><span class="built_in">loop</span></span> [line (<span class="name">.readLine</span> rdr)]</span><br><span class="line">    (<span class="name"><span class="built_in">when</span></span> line</span><br><span class="line">      (<span class="name">println</span> line)</span><br><span class="line">      (<span class="name"><span class="built_in">recur</span></span> (<span class="name">.readLine</span> rdr)))))</span><br></pre></td></tr></table></figure>

<h3 id="2-读取文件的技巧"><a href="#2-读取文件的技巧" class="headerlink" title="2. 读取文件的技巧"></a>2. 读取文件的技巧</h3><p>想想读取文件可能有哪些场景？</p>
<ul>
<li>读取整个文本</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">slurp</span></span> data-file)</span><br></pre></td></tr></table></figure>

<ul>
<li>读取一行</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">  (<span class="name"><span class="built_in">first</span></span> (<span class="name"><span class="built_in">line-seq</span></span> rdr)))</span><br><span class="line"><span class="comment">;; 或者</span></span><br><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">  (<span class="name"><span class="built_in">take</span></span> <span class="number">1</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr)))</span><br><span class="line">-&gt; <span class="string">&quot;hello world!&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>读取前n行</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">  (<span class="name"><span class="built_in">doall</span></span> (<span class="name"><span class="built_in">take</span></span> <span class="number">2</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))))</span><br><span class="line">-&gt; (<span class="string">&quot;hello world!&quot;</span> <span class="string">&quot;hello lambeta!&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这里使用了<code>(doall )</code>方法，如果不用这个方法，在repl中求值的时候会表达式导致抛出<code>Unhandled java.io.IOException  Stream closed</code>异常。究其缘由是<code>(take 2 )</code>返回了一个惰性序列，详细解释参见文末备注。</p>
<ul>
<li>读取前n个字符</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">with-open [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">  (<span class="name"><span class="built_in">loop</span></span> [ch (<span class="name">.read</span> rdr) len <span class="number">20</span>]</span><br><span class="line">    (<span class="name"><span class="built_in">when-not</span></span> (<span class="name"><span class="built_in">or</span></span> (<span class="name"><span class="built_in">=</span></span> <span class="number">-1</span> ch) (<span class="name"><span class="built_in">zero?</span></span> len))</span><br><span class="line">      (<span class="name">println</span> (<span class="name">char</span> ch))</span><br><span class="line">      (<span class="name"><span class="built_in">recur</span></span> (<span class="name">.read</span> rdr) (<span class="name"><span class="built_in">dec</span></span> len)))))</span><br><span class="line">| h</span><br><span class="line">| e</span><br><span class="line">| ...</span><br><span class="line">-&gt; <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<ul>
<li>跳过特定的行</li>
</ul>
<p>在<em>resources</em>目录下，新建<em>records.txt</em>，内容即代码注释所示：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">read-records</span> [input-file]</span><br><span class="line">  <span class="string">&quot;Coloured fox fur production, HOPEDALE, Labrador, 1834-1842</span></span><br><span class="line"><span class="string">  #Source: C. Elton (1942) \&quot;Voles, Mice and Lemmings\&quot;, Oxford Univ. Press</span></span><br><span class="line"><span class="string">  #Table 17, p.265--266</span></span><br><span class="line"><span class="string">  22</span></span><br><span class="line"><span class="string">  29</span></span><br><span class="line"><span class="string">  2</span></span><br><span class="line"><span class="string">  16</span></span><br><span class="line"><span class="string">  12</span></span><br><span class="line"><span class="string">  35</span></span><br><span class="line"><span class="string">  8</span></span><br><span class="line"><span class="string">  83</span></span><br><span class="line"><span class="string">  166&quot;</span></span><br><span class="line">  (<span class="name"><span class="built_in">letfn</span></span> [(<span class="name">skip</span> [lines]</span><br><span class="line">            (<span class="name"><span class="built_in">next</span></span> lines))]</span><br><span class="line">         (<span class="name"><span class="built_in">with-open</span></span> [rdr ((<span class="name"><span class="built_in">comp</span></span> io/reader io/resource) input-file)]</span><br><span class="line">           (<span class="name"><span class="built_in">-&gt;&gt;</span></span></span><br><span class="line">            (<span class="name"><span class="built_in">for</span></span> [line (<span class="name">skip</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))</span><br><span class="line">                  <span class="symbol">:when</span> (<span class="name"><span class="built_in">not</span></span> (<span class="name">.startsWith</span> line <span class="string">&quot;#&quot;</span>))]</span><br><span class="line">              (<span class="name">read-string</span> line))</span><br><span class="line">            (<span class="name"><span class="built_in">apply</span></span> +)))))</span><br><span class="line"></span><br><span class="line">(<span class="name">read-records</span> <span class="string">&quot;records.txt&quot;</span>)</span><br><span class="line">-&gt; <span class="number">373</span></span><br></pre></td></tr></table></figure>

<p>我们在<code>read-records</code>内部新建一个<code>skip</code>方法，顾名思义，跳过第一个元素，然后返回后面的列表。这里旨在跳过文本的声明头。<code>:when (not ...)</code>过滤了文本的注释部分（以#开头的行），并使用<code>read-string</code>转换字符串到数字类型，<code>(for )</code>求值完成后返回只包含数字的列表。最后，我们对列表做了一次累加操作。</p>
<p>我们试试非过滤而是跳过（删除）以”#”开头行的方式获取数字列表，这样更符合要求。重写<em>with-open</em>部分，如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr ((<span class="name"><span class="built_in">comp</span></span> io/reader io/resource) input-file)]</span><br><span class="line">      (<span class="name"><span class="built_in">apply</span></span> +</span><br><span class="line">             (<span class="name"><span class="built_in">let</span></span> [lines (<span class="name">skip</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))]</span><br><span class="line">               (<span class="name"><span class="built_in">-&gt;&gt;</span></span> lines</span><br><span class="line">                    (<span class="name"><span class="built_in">remove</span></span> (<span class="name">set</span> (<span class="name"><span class="built_in">for</span></span> [line lines <span class="symbol">:while</span> (<span class="name">.startsWith</span> line <span class="string">&quot;#&quot;</span>)] line)))</span><br><span class="line">                    (<span class="name"><span class="built_in">map</span></span> read-string)))))</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr ((<span class="name"><span class="built_in">comp</span></span> io/reader io/resource) input-file)]</span><br><span class="line">      (<span class="name"><span class="built_in">apply</span></span> +</span><br><span class="line">             (<span class="name"><span class="built_in">let</span></span> [lines (<span class="name">skip</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))]</span><br><span class="line">               (<span class="name"><span class="built_in">-&gt;&gt;</span></span> lines</span><br><span class="line">                    (<span class="name"><span class="built_in">drop</span></span> (<span class="name"><span class="built_in">count</span></span> (<span class="name"><span class="built_in">for</span></span> [line lines <span class="symbol">:while</span> (<span class="name">.startsWith</span> line <span class="string">&quot;#&quot;</span>)] line)))</span><br><span class="line">                    (<span class="name"><span class="built_in">map</span></span> read-string)))))</span><br></pre></td></tr></table></figure>
<h3 id="3-读取网络文件"><a href="#3-读取网络文件" class="headerlink" title="3. 读取网络文件"></a>3. 读取网络文件</h3><p>通过slurp读取字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(slurp &quot;http://robjhyndman.com/tsdldata/ecology1/hopedale.dat&quot; :encoding &quot;utf-8&quot;)</span><br><span class="line"></span><br><span class="line">-&gt; &quot;Coloured fox fur production, HOPEDALE, Labrador,, 1834-1925\n#Source: C. Elton (1942) \&quot;Voles, Mice and Lemmings\&quot;, Oxford Univ. Press\n#Table 17, p.265--266\n      22   \n...</span><br></pre></td></tr></table></figure>
<p>注意，这个网页上的数据是用UTF-8编码的，所以解码读取时，也应该使用UTF-8。</p>
<h3 id="4-写入文件"><a href="#4-写入文件" class="headerlink" title="4. 写入文件"></a>4. 写入文件</h3><ul>
<li>使用spit方法</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">spit</span> <span class="string">&quot;world.txt&quot;</span> <span class="string">&quot;Hello, lambeta!&quot;</span> <span class="symbol">:append</span> <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<p>运行程序之后，项目的根目录下会生成<em>world.txt</em>文件，内容是<em>Hello, lambeta</em>。spit方法其实就是向Java的BufferedWriter中写入内容。</p>
<ul>
<li>使用clojure.java.io&#x2F;writer</li>
</ul>
<p>我们在项目的根目录新建<em>numbers.txt</em>，内容是多行的数字对，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.3 2.7</span><br><span class="line">10000 1</span><br><span class="line">-1 1</span><br></pre></td></tr></table></figure>

<p>我们需要把每行两个数字，和它们相加的结果写入到<em>sum-of_numbers.txt</em>文件中。也就是注释中的描述。</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">sum-number-pairs</span> [input-file output-file]</span><br><span class="line">  <span class="string">&quot;Read the data from input-file, which contains two floats per line</span></span><br><span class="line"><span class="string">   separated by a space.  Open file named output-file and, for each line in</span></span><br><span class="line"><span class="string">   input-file, write a line to the output file that contains the two floats</span></span><br><span class="line"><span class="string">   from the corresponding line of input-file plus a space and the sum of the</span></span><br><span class="line"><span class="string">   two floats.&quot;</span></span><br><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> input-file) wtr (<span class="name">io/writer</span> output-file <span class="symbol">:append</span> <span class="literal">true</span>)]</span><br><span class="line">    (<span class="name"><span class="built_in">loop</span></span> [line (<span class="name">.readLine</span> rdr)]</span><br><span class="line">      (<span class="name"><span class="built_in">when</span></span> line</span><br><span class="line">        (<span class="name"><span class="built_in">let</span></span> [pair (<span class="name"><span class="built_in">map</span></span> read-string</span><br><span class="line">                        (<span class="name">str/split</span> line <span class="regex">#&quot;\s&quot;</span>))</span><br><span class="line">              first (<span class="name"><span class="built_in">first</span></span> pair)</span><br><span class="line">              second (<span class="name"><span class="built_in">second</span></span> pair)</span><br><span class="line">              sum (<span class="name"><span class="built_in">+</span></span> first second)]</span><br><span class="line">          (<span class="name">.write</span> wtr (<span class="name"><span class="built_in">str</span></span> first <span class="string">&quot; &quot;</span> second <span class="string">&quot; &quot;</span> sum <span class="string">&quot;\n&quot;</span>)))</span><br><span class="line">        (<span class="name"><span class="built_in">recur</span></span> (<span class="name">.readLine</span> rdr))))))</span><br><span class="line"></span><br><span class="line">(<span class="name">sum-number-pairs</span> <span class="string">&quot;numbers.txt&quot;</span> <span class="string">&quot;sum-of-numbers.txt&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>with-open同时打开了一个用于读取、名为<em>input-file</em>的文件以及一个用于写入、名为<em>output-file</em>的文件，写入方式是追加<code>:append true</code>。随后循环读取<em>input-file</em>中的每行内容。若<em>line</em>不是nil（即存在），那么用空格分隔这行内容，得到一个数组，如：”1.3 2.7” -&gt; [“1.3” “2.7”]。此时数组的元素类型还不是数字（Number），我们使用<code>(map read-string )</code>将元素转换为对应的数字类型，如：[“1.3” “2.7”] -&gt; [1.3 2.7]。之后，分别提取数组的第一、二个元素以及两者的和。最后，写入到wtr中。</p>
<hr>
<p><strong>注意</strong>：程序中的<em>str&#x2F;split</em>是通过<code>(:require [clojure.string :as str])</code>方式引入<em>str</em>命名空间的。</p>
<hr>
<p>运行程序之后，<em>sum-of-numbers.txt</em>中的内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.3 2.7 4.0</span><br><span class="line">10000 1 10001</span><br><span class="line">-1 1 0</span><br></pre></td></tr></table></figure>

<h3 id="5-多行记录"><a href="#5-多行记录" class="headerlink" title="5. 多行记录"></a>5. 多行记录</h3><h4 id="5-1-有结束标识"><a href="#5-1-有结束标识" class="headerlink" title="5.1 有结束标识"></a>5.1 有结束标识</h4><p>有时候，记录并不是以一行一行的方式存储在文件当中的，而是以多行数据描述一条记录。比如下面的蛋白质数据：<br><strong>清单 5.1</strong> <em>multimol.pdb</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">COMPND      AMMONIA</span><br><span class="line">ATOM      1  N  0.257  -0.363   0.000</span><br><span class="line">ATOM      2  H  0.257   0.727   0.000</span><br><span class="line">ATOM      3  H  0.771  -0.727   0.890</span><br><span class="line">ATOM      4  H  0.771  -0.727  -0.890</span><br><span class="line">END</span><br><span class="line">COMPND      METHANOL</span><br><span class="line">ATOM      1  C  -0.748  -0.015   0.024</span><br><span class="line">ATOM      2  O  0.558   0.420  -0.278</span><br><span class="line">ATOM      3  H  -1.293  -0.202  -0.901</span><br><span class="line">ATOM      4  H  -1.263   0.754   0.600</span><br><span class="line">ATOM      5  H  -0.699  -0.934   0.609</span><br><span class="line">ATOM      6  H  0.716   1.404   0.137</span><br><span class="line">END</span><br></pre></td></tr></table></figure>
<p>第一行描述的是分子的名字，接下来到END为止的每行代表原子的ID、类型以及在分子中分布的[x y z]坐标。<br>我们需要一个函数，将数据读取出来并且以规定的格式输出，格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">((&quot;AMMONIA&quot; </span><br><span class="line">    (&quot;N&quot; &quot;0.257&quot; &quot;-0.363&quot; &quot;0.000&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;0.257&quot; &quot;0.727&quot; &quot;0.000&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;0.771&quot; &quot;-0.727&quot; &quot;0.890&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;0.771&quot; &quot;-0.727&quot; &quot;-0.890&quot;)) </span><br><span class="line"> (&quot;METHANOL&quot; </span><br><span class="line">    (&quot;C&quot; &quot;-0.748&quot; &quot;-0.015&quot; &quot;0.024&quot;)</span><br><span class="line">    (&quot;O&quot; &quot;0.558&quot; &quot;0.420&quot; &quot;-0.278&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;-1.293&quot; &quot;-0.202&quot; &quot;-0.901&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;-1.263&quot; &quot;0.754&quot; &quot;0.600&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;-0.699&quot; &quot;-0.934&quot; &quot;0.609&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;0.716&quot; &quot;1.404&quot; &quot;0.137&quot;)))</span><br></pre></td></tr></table></figure>
<p>也就是说，我们需要把每条记录读入单个列表中，每个列表由分子的名称和多个<code>(Type X Y Z)</code>的原子列表组成。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(defn read-all-molecules [input-file]</span><br><span class="line">  (map (fn [molecules]</span><br><span class="line">         (let [[_ name] (str/split (first molecules) #&quot;\s+&quot;)</span><br><span class="line">               atoms (map (comp #(drop 2 %) #(str/split % #&quot;\s+&quot;))</span><br><span class="line">                          (rest molecules))]</span><br><span class="line">           (concat [name] atoms)))</span><br><span class="line">       ;; 分割成多条记录</span><br><span class="line">       (remove #(= % [&quot;END&quot;]) </span><br><span class="line">               (partition-by #(= % &quot;END&quot;) (line-seq (io/reader input-file))))))</span><br><span class="line"></span><br><span class="line">(read-all-molecules &quot;multimol.pdb&quot;)</span><br></pre></td></tr></table></figure>
<p><code>(remove #(= % [&quot;END&quot;]) (partition-by #(= % &quot;END&quot;) (line-seq (io/reader input-file))))</code>这行代码做的事情就是把文件读取出来变成一个<code>lazy-seq</code>，然后使用<code>parttition-by</code>以<em>END</em>进行分组，最后使用<code>remove</code>方法剔除掉*[“END”]*这样的分组，得到如下中间结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">((&quot;COMPND      AMMONIA&quot; </span><br><span class="line">  &quot;ATOM      1  N  0.257  -0.363   0.000&quot;</span><br><span class="line">  &quot;ATOM      2  H  0.257   0.727   0.000&quot;</span><br><span class="line">  &quot;ATOM      3  H  0.771  -0.727   0.890&quot;</span><br><span class="line">  &quot;ATOM      4  H  0.771  -0.727  -0.890&quot;) </span><br><span class="line"> (&quot;COMPND      METHANOL&quot; </span><br><span class="line">  &quot;ATOM      1  C  -0.748  -0.015   0.024&quot;</span><br><span class="line">  &quot;ATOM      2  O  0.558   0.420  -0.278&quot;</span><br><span class="line">  &quot;ATOM      3  H  -1.293  -0.202  -0.901&quot; </span><br><span class="line">  &quot;ATOM      4  H  -1.263   0.754   0.600&quot;</span><br><span class="line">  &quot;ATOM      5  H  -0.699  -0.934   0.609&quot; </span><br><span class="line">  &quot;ATOM      6  H  0.716   1.404   0.137&quot;))</span><br></pre></td></tr></table></figure>
<p>这样离我们的目标已经很近了。观察上述结果，不难发现分子的名称处于列表的第一个<code>(first )</code>，而原子列表可以使用<code>(rest )</code>获取。然后，借助<code>(map )</code>函数遍历所有的记录。</p>
<p><code>(let )</code>中的第一个binding是<code>[_ name] (str/split (first molecules) #&quot;\s+&quot;)</code>，首先用<code>(split )</code>函数分割，再使用了解构提取出分子的名称；第二个binding是原子列表的提取，我们在<code>(split )</code>的基础之上，使用<code>(drop 2 )</code>函数剔除了不用的字段，如：ATOM和1。最后使用<code>(concat )</code>函数将名称和原子列表的列表拼接到一起。</p>
<h4 id="5-2-无结束标识"><a href="#5-2-无结束标识" class="headerlink" title="5.2 无结束标识"></a>5.2 无结束标识</h4><p>5.1中的记录项通过<em>END</em>标识分隔，但是事实上这是一个多余的字段，记录项可以更简练，如下：<br><strong>清单 5.2</strong> <em>multimol-without-end-marker.pdb</em></p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">COMPND      AMMONIA</span><br><span class="line">ATOM      <span class="number">1</span>  N  <span class="number">0.257</span>  <span class="number">-0.363</span>   <span class="number">0.000</span></span><br><span class="line">ATOM      <span class="number">2</span>  H  <span class="number">0.257</span>   <span class="number">0.727</span>   <span class="number">0.000</span></span><br><span class="line">ATOM      <span class="number">3</span>  H  <span class="number">0.771</span>  <span class="number">-0.727</span>   <span class="number">0.890</span></span><br><span class="line">ATOM      <span class="number">4</span>  H  <span class="number">0.771</span>  <span class="number">-0.727</span>  <span class="number">-0.890</span></span><br><span class="line">COMPND      METHANOL</span><br><span class="line">ATOM      <span class="number">1</span>  C  <span class="number">-0.748</span>  <span class="number">-0.015</span>   <span class="number">0.024</span></span><br><span class="line">ATOM      <span class="number">2</span>  O  <span class="number">0.558</span>   <span class="number">0.420</span>  <span class="number">-0.278</span></span><br><span class="line">ATOM      <span class="number">3</span>  H  <span class="number">-1.293</span>  <span class="number">-0.202</span>  <span class="number">-0.901</span></span><br><span class="line">ATOM      <span class="number">4</span>  H  <span class="number">-1.263</span>   <span class="number">0.754</span>   <span class="number">0.600</span></span><br><span class="line">ATOM      <span class="number">5</span>  H  <span class="number">-0.699</span>  <span class="number">-0.934</span>   <span class="number">0.609</span></span><br><span class="line">ATOM      <span class="number">6</span>  H  <span class="number">0.716</span>   <span class="number">1.404</span>   <span class="number">0.137</span></span><br></pre></td></tr></table></figure>
<p>现在的问题变成了没有<em>END</em>标识符，如何进行分组？观察不难发现以<em>COMPND</em>开头的数据行可以作为记录的分隔符。<br>使用<code>(partition-by #(.startsWith % &quot;COMPND&quot;) (line-seq (io/reader input-file)))</code>进行分组，得到的结果如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">((<span class="string">&quot;COMPND      AMMONIA&quot;</span>) </span><br><span class="line">  (<span class="string">&quot;ATOM      1  N  0.257  -0.363   0.000&quot;</span> </span><br><span class="line">   <span class="string">&quot;ATOM      2  H  0.257   0.727   0.000&quot;</span> </span><br><span class="line">   <span class="string">&quot;ATOM      3  H  0.771  -0.727   0.890&quot;</span></span><br><span class="line">   <span class="string">&quot;ATOM      4  H  0.771  -0.727  -0.890&quot;</span>) </span><br><span class="line"> (<span class="string">&quot;COMPND      METHANOL&quot;</span>) </span><br><span class="line">  (<span class="string">&quot;ATOM      1  C  -0.748  -0.015   0.024&quot;</span> </span><br><span class="line">   <span class="string">&quot;ATOM      2  O  0.558   0.420  -0.278&quot;</span> </span><br><span class="line">   <span class="string">&quot;ATOM      3  H  -1.293  -0.202  -0.901&quot;</span></span><br><span class="line">   <span class="string">&quot;ATOM      4  H  -1.263   0.754   0.600&quot;</span></span><br><span class="line">   <span class="string">&quot;ATOM      5  H  -0.699  -0.934   0.609&quot;</span></span><br><span class="line">   <span class="string">&quot;ATOM      6  H  0.716   1.404   0.137&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>此时，我们对比5.1中中间结果，会发现它们极为相似。也就是说，我们稍加转换就能让两者一致，而一致的好处就是可以复用原来<code>(map )</code>中的逻辑。</p>
<p>稍稍修改原来的分组逻辑，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(map (fn [[name atoms]] (concat name atoms))</span><br><span class="line">       (partition 2</span><br><span class="line">                  (partition-by</span><br><span class="line">                   #(.startsWith % &quot;COMPND&quot;)</span><br><span class="line">                   (line-seq (io/reader input-file)))))</span><br></pre></td></tr></table></figure>
<p>我们先使用<code>(partition 2 )</code>将第一步得到的列表每隔两个元素划为一组，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(((&quot;COMPND      AMMONIA&quot;) </span><br><span class="line">  (&quot;ATOM      1  N  0.257  -0.363   0.000&quot; </span><br><span class="line">   &quot;ATOM      2  H  0.257   0.727   0.000&quot; </span><br><span class="line">   &quot;ATOM      3  H  0.771  -0.727   0.890&quot;</span><br><span class="line">   &quot;ATOM      4  H  0.771  -0.727  -0.890&quot;)) ; 多出一对括号</span><br><span class="line"> ((&quot;COMPND      METHANOL&quot;) </span><br><span class="line">  (&quot;ATOM      1  C  -0.748  -0.015   0.024&quot; </span><br><span class="line">   &quot;ATOM      2  O  0.558   0.420  -0.278&quot; </span><br><span class="line">   &quot;ATOM      3  H  -1.293  -0.202  -0.901&quot;</span><br><span class="line">   &quot;ATOM      4  H  -1.263   0.754   0.600&quot;</span><br><span class="line">   &quot;ATOM      5  H  -0.699  -0.934   0.609&quot;</span><br><span class="line">   &quot;ATOM      6  H  0.716   1.404   0.137&quot;)))</span><br></pre></td></tr></table></figure>
<p>然后使用<code>(map (fn [[name atoms]] ...)</code>将每组里面的两个列表合成为一个列表，这样就得到和原来5.1一模一样的中间结果。</p>
<p>接下来，我们把转换的逻辑从<code>(read-all-molecules )</code>中提取出来，以便复用。改造如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">read-all-molecules</span> [f input-file]</span><br><span class="line">  (<span class="name"><span class="built_in">let</span></span> [data (<span class="name">f</span> input-file)]</span><br><span class="line">    (<span class="name"><span class="built_in">map</span></span> (<span class="name"><span class="built_in">fn</span></span> [molecules]</span><br><span class="line">           (<span class="name"><span class="built_in">let</span></span> [[_ name] (<span class="name">str/split</span> (<span class="name"><span class="built_in">first</span></span> molecules) <span class="regex">#&quot;\s+&quot;</span>)</span><br><span class="line">                 atoms (<span class="name"><span class="built_in">map</span></span> (<span class="name"><span class="built_in">comp</span></span> #(<span class="name"><span class="built_in">drop</span></span> <span class="number">2</span> %) #(<span class="name">str/split</span> % <span class="regex">#&quot;\s+&quot;</span>))</span><br><span class="line">                            (<span class="name"><span class="built_in">rest</span></span> molecules))]</span><br><span class="line">             (<span class="name"><span class="built_in">concat</span></span> [name] atoms))) data)))</span><br></pre></td></tr></table></figure>
<p>定义转换逻辑，如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">file-without-markers-&gt;multi-records</span> [input-file]</span><br><span class="line">  (<span class="name"><span class="built_in">map</span></span> (<span class="name"><span class="built_in">fn</span></span> [[name atoms]] (<span class="name"><span class="built_in">concat</span></span> name atoms))</span><br><span class="line">       (<span class="name"><span class="built_in">partition</span></span> <span class="number">2</span></span><br><span class="line">                  (<span class="name">partition-by</span></span><br><span class="line">                   #(<span class="name">.startsWith</span> % <span class="string">&quot;COMPND&quot;</span>)</span><br><span class="line">                   (<span class="name"><span class="built_in">line-seq</span></span> (<span class="name">io/reader</span> input-file))))))</span><br></pre></td></tr></table></figure>
<p>最后，我们来调用的改造之后的方法：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">read-all-molecules</span> </span><br><span class="line">        file-without-markers-&gt;multi-records <span class="string">&quot;multimol-without-end-marker.pdb&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>此时，5.1中的转换逻辑也可以提取出一个函数：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">file-&gt;multi-records</span></span><br><span class="line">  (<span class="name"><span class="built_in">remove</span></span> #(<span class="name"><span class="built_in">=</span></span> % [<span class="string">&quot;END&quot;</span>]) </span><br><span class="line">               (<span class="name">partition-by</span> #(<span class="name"><span class="built_in">=</span></span> % <span class="string">&quot;END&quot;</span>) (<span class="name"><span class="built_in">line-seq</span></span> (<span class="name">io/reader</span> input-file)))))</span><br></pre></td></tr></table></figure>
<p>原来的程序就重构成了如下的模样：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">read-all-molecules</span> file-&gt;multi-records <span class="string">&quot;multimol.pdb&quot;</span>)</span><br></pre></td></tr></table></figure>


<hr>
<p><strong>备注</strong></p>
<p>为了清楚定位这个问题，我们需要提前了解两个知识点</p>
<ol>
<li>什么是惰性序列？</li>
<li>惰性序列在repl中什么时候变现（realizes）？</li>
</ol>
<p>惰性序列是用<code>(lazy-seq [&amp; body] )</code>宏创建出来的。<code>lazy-seq</code>仅在需要的时候才会去调用它的body。<br>当repl尝试<code>pretty-print</code>惰性序列的结果时，才会进行变现操作。</p>
<p>有了上面的知识点，我们来考察<code>with-open</code>和<code>(take 2 (line-seq ))</code>的关系。<code>with-open</code>是宏，我们使用<code>clojure.walk/macroexpand-all</code>展开下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">clojure.walk/macroexpand-all</span> </span><br><span class="line">    &#x27;(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">                      (<span class="name"><span class="built_in">take</span></span> <span class="number">2</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))))</span><br><span class="line">                      </span><br><span class="line">-&gt; (<span class="name">let*</span> [rdr (<span class="name">io/reader</span> data-file)] </span><br><span class="line">        (<span class="name"><span class="built_in">try</span></span> (<span class="name"><span class="built_in">do</span></span> </span><br><span class="line">                (<span class="name"><span class="built_in">take</span></span> <span class="number">2</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))) </span><br><span class="line">        (<span class="name">finally</span> (<span class="name"><span class="built_in">.</span></span> rdr clojure.core/close))))                      </span><br></pre></td></tr></table></figure>
<p>使用<code>(doc line-seq)</code>查看文档，得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">clojure.core/line-seq</span><br><span class="line"> [rdr]</span><br><span class="line">Added in 1.0</span><br><span class="line">  Returns the lines of text from rdr as a lazy sequence of strings.</span><br><span class="line">  rdr must implement java.io.BufferedReader.</span><br></pre></td></tr></table></figure>
<p>可以确认<code>line-seq</code>返回一个惰性的字符串序列。<br>再看看<code>(doc take)</code>的文档，得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">clojure.core/take</span><br><span class="line"> [n]</span><br><span class="line"> [n coll]</span><br><span class="line">Added in 1.0</span><br><span class="line">  Returns a lazy sequence of the first n items in coll, or all items if</span><br><span class="line">  there are fewer than n.  Returns a stateful transducer when</span><br><span class="line">  no collection is provided.</span><br></pre></td></tr></table></figure>
<p>所以<code>take</code>返回的也是一个惰性序列，那么<code>(do (take 2 (line-seq rdr)))</code>（等价于<code>(take 2 (line-seq rdr))</code>）整个返回的就是一个惰性序列。</p>
<p>当我们通过repl求值<code>with-open</code>时，它并没有真的变现<code>(take 2 (line-seq rdr))</code>，而是在运行完<code>try...finally</code>之后，直接返回这个惰性序列作为结果。此时，repl开始尝试pretty-print <code>(take 2 (line-seq rdr))</code>，变现发生，但是rdr已经被关闭了，所以抛出<em>Stream closed</em>异常。</p>
<p>到这里，解决了一大半问题，但是还有一个逻辑上解释不过去的点，就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(with-open [rdr (io/reader data-file)]</span><br><span class="line">  (take 1 (line-seq rdr)))</span><br></pre></td></tr></table></figure>
<p>当我们尝试<code>(take 1 )</code>时并不会抛出异常！也就是说<code>(take 1 )</code>和<code>(take 2 )</code>的行为不同，但是<code>(take )</code>明明都是返回惰性序列啊？</p>
<p>带着这个疑惑，看看<code>line-seq</code>的源代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(when-let [line (.readLine rdr)]</span><br><span class="line">    (cons line (lazy-seq (line-seq rdr)))))</span><br></pre></td></tr></table></figure>
<p>是不是有种豁然开朗的感觉？没有也没关系，我来解释一下。<br><code>line-seq</code>的<code>when-let</code>语句并没有包在<code>(lazy-seq )</code>（这点可以和<code>take</code>的源码比较）中，这说明<code>[line (.readline rdr)]</code>是需要立即求值的。也就是说，我们在求值<code>with-open</code>时，rdr中第一行的内容会被<code>(line-seq )</code>给抓住了。那么当<code>try...finally</code>运行结束之后，pretty-print变现惰性序列时，发现第一行根本不需要从rdr中读，当然就不会抛出异常了。</p>
<p>明确这几点之后，我们看看<code>(doall )</code>为何能解决惰性序列延迟求值的问题？<code>(doall )</code>其实强制变现了整个惰性序列（不断调用序列的<code>next</code>方法），所以并不会等到<code>with-open</code>求值完成之后才求值。</p>
<p>换个角度，我们知道之所以抛出异常，是因为repl对返回的惰性序列求值了。那么如果我们不在repl中求值，程序还会抛出异常吗？</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">ns</span></span> the-way-to-clojure.core</span><br><span class="line">  (<span class="symbol">:require</span> [clojure.java.io <span class="symbol">:as</span> io])</span><br><span class="line">  (<span class="symbol">:gen-class</span>))</span><br><span class="line"></span><br><span class="line">(<span class="keyword">defn</span> <span class="title">-main</span> [&amp; args]</span><br><span class="line">  (<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> <span class="string">&quot;hello.txt&quot;</span>)]</span><br><span class="line">    (<span class="name"><span class="built_in">take</span></span> <span class="number">100</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))))</span><br></pre></td></tr></table></figure>
<p>接着，我们使用<code>lein run</code>来运行<code>main</code>方法。程序运行良好，因为根本没有人用到返回的惰性序列。</p>
<p>如果我们加一句打印语句如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(defn -main [&amp; args]</span><br><span class="line">  (println          ; 变现</span><br><span class="line">      (with-open [rdr (io/reader &quot;hello.txt&quot;)]</span><br><span class="line">        (take 100 (line-seq rdr)))))</span><br></pre></td></tr></table></figure>
<p>再用<code>lein run</code>跑一个<code>main</code>方法，异常又不期而遇了。因为此处的<code>println</code>等价于<code>repl</code>的<code>pretty print</code>。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/file/" rel="tag"># file</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2016/06/24/SonarQube-Plugin-Step-by-Step/" rel="prev" title="SonarQube Plugin Step by Step">
                  <i class="fa fa-angle-left"></i> SonarQube Plugin Step by Step
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2016/09/12/Collection-Pipelines-By-TDD/" rel="next" title="Clojure集合管道函数练习">
                  Clojure集合管道函数练习 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">lambeta</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>

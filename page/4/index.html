<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"qianyan.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Senior Consultant | DevOps Master | Blockchain &amp; Web3 Specialist">
<meta property="og:type" content="website">
<meta property="og:title" content="鄢倩">
<meta property="og:url" content="https://qianyan.github.io/page/4/index.html">
<meta property="og:site_name" content="鄢倩">
<meta property="og:description" content="Senior Consultant | DevOps Master | Blockchain &amp; Web3 Specialist">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Ryan Qian">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://qianyan.github.io/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>鄢倩</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">鄢倩</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">(conj clojurians me)</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ryan Qian</p>
  <div class="site-description" itemprop="description">Senior Consultant | DevOps Master | Blockchain & Web3 Specialist</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/qianyan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qianyan" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:qianyan.lambda@gmail.com" title="E-Mail → mailto:qianyan.lambda@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://weibo.com/3672207020" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;3672207020" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://x.com/_qian_yan" title="Twitter → https:&#x2F;&#x2F;x.com&#x2F;_qian_yan" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://lambdaisland.com/blog" title="https:&#x2F;&#x2F;lambdaisland.com&#x2F;blog" rel="noopener" target="_blank">Lambdaisland</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://www.youtube.com/@SystemCrafters" title="https:&#x2F;&#x2F;www.youtube.com&#x2F;@SystemCrafters" rel="noopener" target="_blank">System Crafters</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://aphyr.com/" title="https:&#x2F;&#x2F;aphyr.com" rel="noopener" target="_blank">Aphyr</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://bucharestfp.ro/" title="http:&#x2F;&#x2F;bucharestfp.ro" rel="noopener" target="_blank">Bucharest FP</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://blog.rlmflores.me/" title="http:&#x2F;&#x2F;blog.rlmflores.me&#x2F;" rel="noopener" target="_blank">Rodrigo Flores</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://seancorfield.github.io/" title="https:&#x2F;&#x2F;seancorfield.github.io&#x2F;" rel="noopener" target="_blank">Seancorfield</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2017/03/01/Pipleline-as-Code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/03/01/Pipleline-as-Code/" class="post-title-link" itemprop="url">Pipleline as Code</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2017-03-01 10:19:13 / 修改时间：10:52:12" itemprop="dateCreated datePublished" datetime="2017-03-01T10:19:13+08:00">2017-03-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>2016年11月份的技术雷达中给出了一个简明的定义：流水线即代码 (Pipeline as Code) 通过编码而非配置持续集成&#x2F;持续交付 (CI&#x2F;CD) 运行工具的方式定义部署流水线。<br>其实早在2015年11月份的技术雷达当中就已经有了类似的概念：</p>
<blockquote>
<p>The way to avoid programming in your CI&#x2F;CD tool is to extract the complexities of the build process from the guts of the tool and into a simple script which can be invoked by a single command. This script can then be executed on any developer workstation and therefore eliminates the privileged&#x2F;singular status of the build environment<br>大意是将复杂的构建流程纳入一个简单的脚本文件，然后用一条命令调用。这样，任意的开发者都能在自己的工作区中执行脚本重建一套一模一样的构建环境，从而消除 CI&#x2F;CD 环境由于散乱配置腐化而成的特异性。这么做的原因很好理解，使用 CI&#x2F;CD 工具是为了暴露产品代码中的问题的，如果它们自身已经复杂到不稳定的地步，我们还使用它就是自找麻烦。</p>
</blockquote>
<p>从某种程度上看，实施流水线即代码是不证自明的。在 CI&#x2F;CD 的时间过程中，凡是可以被编码的东西都已经被代码化了，比如：构建、测试、数据库迁移、部署和基础设施&#x2F;环境配置 (Infrastruture as Code) 等。说得烂俗点，流水线已经是 CI&#x2F;CD 实践过程中的“最后一公里”，让流水线变成软件开发中的“一等公民”（即代码）是大势所趋、民心所向。不过，这种论断毕竟欠缺说服力，我们接着从实践的痛点出发总结当前流水线遇到的问题。</p>
<h2 id="实践中的痛点"><a href="#实践中的痛点" class="headerlink" title="实践中的痛点"></a>实践中的痛点</h2><p>我给客户搭建和配置过不少 CI&#x2F;CD 流水线（被同事戏谑地称为“CI&#x2F;CD搭建兽”），最大的痛苦莫过于每次都得从头来过，即便大部分情况下所用的工具和配置都大同小异。其次是手工操作产生的配置漂移 (configuration drift) 。以 Jenkins 为例，先不谈 1.0 版本不支持流水线这一概念的问题，我们为了解决遇到的构建、测试和部署等问题，一般会在多个文本框中粘贴大量 shell&#x2F;batch 脚本；甚至会通过这些文本框安装各种插件或者依赖包、设置环境变量等等。久而久之（实际上不需要多久），这台 Jenkins 服务器就变得不可替代（特异化）了，因为没人清楚到底对它做了哪些更改以及这些更改对承载它的系统产生哪些影响，这时 Jenkins 服务器俨然腐化成了老马所说的雪花服务器 (snowflake server)。雪花服务器有两点显著的特征：</p>
<ol>
<li>特别难以复现</li>
<li>几乎无法理解</li>
</ol>
<p>第一点是由于以往所做的更改并没有被记录下来，所以做过的操作都是七零八落的，没有办法复现同样的操作，也无法复制一个同样的系统。<br>第二点则是由于绝大部分情况下散乱的配置是没有文档描述的，哪部分是重要的已经无从知晓，改动的风险很大。</p>
<p>这些问题会在流水线的演化过程中恶化得越来越严重。一般来讲，除非不再使用，否则流水线不会保持一成不变。具体实施过程中，考虑到项目，尤其是遗留项目当前的特点和团队成员的“产能”，我们会先将构建和部署自动化；部署节奏稳定后，开始将单元测试和代码分析自动化；接着可以指导测试人员将验收测试自动化；然后尝试将发布自动化。在这之后，就要开始持续优化流水线，包括 CI 的速度和稳定性等。换句话说，流水线的演化其实是和项目的当前进展密切相关的，保证这样的对应关系有时是有必要的，比如：在版本控制下，多发布分支所需流水线和主干分支会存在不同。发布分支是主干分支某个时刻分出去的，它需要在那时的流水线上才能正常工作。由于前面所说雪花服务器的特征，重建这样一条流水线并不是一件容易的事情。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/217988-e8d3fcb49a100197.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="演进式的持续集成"></p>
<h2 id="如何解决"><a href="#如何解决" class="headerlink" title="如何解决"></a>如何解决</h2><p>其实，流水线即代码本身已经回答这个问题了。当前实现了这一概念的工具大体遵循了两种模式：</p>
<ol>
<li>版本控制</li>
<li>DSL（领域特定语言）</li>
</ol>
<p>对于特别难以复现、没有保证对应关系的痛点，我们就把流水线写成代码放到版本控制工具中管理起来。这样一来，每一次更改都能被记录下来，而且它会始终和此时的项目进展保持同步。</p>
<p>对于几乎无法理解、没有文档支持的痛点，我们就选用领域特定语言描述整条流水线。举个 Jenkins 2.0 例子，它允许我们在项目的特定目录下放置一个 Jenkinsfile 的文件，内容大致如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">node(&#x27;master&#x27;) &#123;</span><br><span class="line">	stage(&#x27;Checkout&#x27;) &#123;…&#125;</span><br><span class="line">	stage(&#x27;Code Analysis&#x27;) &#123;…&#125;</span><br><span class="line">	stage(&#x27;Unit Test&#x27;) &#123;…&#125;</span><br><span class="line">	stage(&#x27;Packing&#x27;) &#123;…&#125;</span><br><span class="line">	stage(&#x27;Archive&#x27;) &#123;…&#125;</span><br><span class="line">	stage(&#x27;DEV&#x27;) &#123;…&#125;</span><br><span class="line">&#125;</span><br><span class="line">stage(&#x27;SIT&#x27;) &#123;</span><br><span class="line">	timeout(time:4, unit:&#x27;HOURS&#x27;) &#123;</span><br><span class="line">		input &quot;Deploy to SIT?&quot;</span><br><span class="line">	&#125;</span><br><span class="line">	node(&#x27;master&#x27;) &#123;…&#125;</span><br><span class="line">&#125;</span><br><span class="line">stage(&#x27;Acceptance Test&#x27;) &#123;</span><br><span class="line">	node(&#x27;slave&#x27;) &#123;…&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Jenkins 2.0 使用Groovy实现了一套描述流水线的DSL，即便不了解Groovy语言，只要对流水线稍微熟悉，就能按照<a target="_blank" rel="noopener" href="https://github.com/jenkinsci/pipeline-plugin/blob/master/TUTORIAL.md">例子和文档</a>编写出符合要求的代码。</p>
<p>类似的工具还有Concourse.ci、λCD (LambdaCD) 等。<br>Concourse.ci 使用了 yaml 实现了DSL，独立抽象出Resource（外部依赖，如：git repo）、Job（函数， get 和 put Resource ）和 Task（纯函数，必须明确定义 Input 和 Output ）模型。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/217988-250bc1dc50e3bdd8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Concousre.ci"></p>
<p>而 λCD 则使用 Clojure 语言实现了 DSL，抽象出 Pipeline 和 Step 模型，使用了Lisp特有的宏 (macro) 和普通函数，编写起来简单明了。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/217988-8b29a42d225edebf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="λCD"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(def pipeline-def</span><br><span class="line">  `(</span><br><span class="line">    (either</span><br><span class="line">     manualtrigger/wait-for-manual-trigger</span><br><span class="line">     wait-for-repo)</span><br><span class="line"></span><br><span class="line">    (with-workspace</span><br><span class="line">      clone</span><br><span class="line">      (in-parallel</span><br><span class="line">       run-some-tests</span><br><span class="line">       run-smokeing-tests)</span><br><span class="line"></span><br><span class="line">      run-package</span><br><span class="line">      deploy)))</span><br></pre></td></tr></table></figure>
<p>上述的pipeline-def就是这条流水线的定义，极为优雅得是，它的代码和UI事实上构成了一一映射的关系，简单到极致。</p>
<p>值得一提的是，λCD 有别于其它同类型的工具，它本身就是一份用 Clojure 写就的微服务。换句话说，其它的工具可能需要借助基础设施即代码完成自身的安装，但λCD不用，它完全可以采用其它微服务的部署方式，比如用 λCD 部署它自己，类似于编译器的自举 (bootstraping)。这个时候，我们就需要两套 λCD 服务，一套用于部署自身，另一套部署开发中的工程。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/217988-85057d2c87c41ab1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="流水线自举"></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>流水线即代码是个新概念，也就意味着我们还需要花时间去探索与之相关的实践，比如，调试和测试（既然是代码就需要测试）。一旦有了这些实践，我们就可以把流水线本身作为产品放到流水线上运作起来，那时将会看到一种很好玩的现象——旧的流水线会构建并部署新流水线，完成流水线的自举 (pipeline bootstrap) 。此外，当流水线成为代码，它在最终的交付物中必然占据一席之地，其潜在的价值还等待我们挖掘，至少从精益的角度，流水线能做的事情还有很多。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2017/01/01/Emacs-configs-for-a-clojurian/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/01/01/Emacs-configs-for-a-clojurian/" class="post-title-link" itemprop="url">Emacs configs for a clojurian</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-01-01 20:00:24" itemprop="dateCreated datePublished" datetime="2017-01-01T20:00:24+08:00">2017-01-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2017-06-20 11:32:53" itemprop="dateModified" datetime="2017-06-20T11:32:53+08:00">2017-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Clojure/" itemprop="url" rel="index"><span itemprop="name">Clojure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>俗话说，工欲善其事必先利其器，完善开发工具与我而言是一件快乐的事情，分享也是一件令人愉悦的事情，所以我想把学习过程中的点滴记录下，留作备忘。本文不会介绍太多花式或有深度的emacs配置，更多是摸索学习的过程，其中充满了乐趣。</p>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>网络上的*.emacs.d&#x2F;init.el<em>配置数不胜数，各路lisp大神的</em>dot file<em>都已经放在github上了，而且前有牛人撰文推荐学习emacs配置的详实方法，看似确实没有什么必要自己折腾一份配置。这个说法对，也不对。我在转向emacs之前，是一名忠实的vim党，从大学开始就不断折腾vim的配置，还花过一段时间专门学习了</em>vimscript<em>，曾经惊叹于</em>vimscript<em>的动态函数式风格的优美和强大。类似地，</em>.vimrc*配置文件在网络上也多如牛毛，华丽和酷炫的插件极大地提升了vim的操作性。尽管如此，我还是乐于一砖一瓦地打造自己的vim环境，竭力演化它变成我心目中的“编辑器之神”。这个过程一般会充满修改然后重启的重复性机械劳作，偶尔会遭遇无论怎么修改就是不生效、甚至遍寻google也一无所获的挫折，但是我就是无法厌倦它，人天生好奇，探索未知事物本身就充满了乐趣，而且一旦配置奏效，便能获得满满的成就感。新事物对程序员具有极大的吸引力，但是程序员不会止步于使用新事物，而且会在惊奇之余，渴望控制那股背后主导它的力量本身，行使“上帝之力”。</p>
<p>话说回来，为什么我会从vim党摇身一变成为emacs党呢？这就不得不提起Clojure这门lisp方言，出于对lisp和函数式编程的痴迷，我选择了基于JVM的Clojure作为自己的偏好语言，而emacs天生为lisp而生。有了这个充足的理由，我开始收集emacs的cheatsheet并打印出来，天天放在手边翻阅，甚至买了一本英文版的<em>Learning GNU Emacs</em>书籍，只要有机会就打开emacs开始刷4clojure上的编程题。由于emacs对lisp的亲和性，我几乎没花多少时间就掌握住了常用的操作技巧。不过，emacs最负盛名的学习曲线确实让学习者绕过圈子，只要一段时间不用，就会忘记很多基本操作。另外，为了更好地在emacs中编写Clojure，还需要cider-mode和clojure-mode的支持，这时候就不得不编辑<em>init.el</em>文件，本着<em>KISS (keep it simple, stupid)<em>原则，我照着各种插件的说明文档中，把配置项复制粘贴到</em>init.el</em>文件当中，运行起来没有问题就好。随着自定义的内容变多，<em>init.el</em>文件也急剧膨胀起来。膨胀本来算不上问题，但我是个比较有操守的程序员，臃肿的代码是我极力避免的坏味道（bad smell）。所以胸臆之中涌动一股浩然之气，决心学起<em>emacs lisp</em>，把emacs的配置从头来过。</p>
<h2 id="从『头』开始"><a href="#从『头』开始" class="headerlink" title="从『头』开始"></a>从『头』开始</h2><p><em>init.el</em>文件位于*~&#x2F;.emacs.d<em>目录之下，如果没有，自行创建一份即可。<br>首先，我们需要用到emacs的包管理工具</em>package.el*，因为emacs 24及其以上的版本都已经内置，所以无需下载到本地，直接通过<code>require</code>加载到emacs的运行时。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">require</span> &#x27;package)</span><br><span class="line">(<span class="name">setq</span> package-archives &#x27;((<span class="string">&quot;melpa&quot;</span> . <span class="string">&quot;http://melpa.org/packages/&quot;</span>)</span><br><span class="line">						 (<span class="string">&quot;melpa-stable&quot;</span> . <span class="string">&quot;https://stable.melpa.org/packages/&quot;</span>)</span><br><span class="line">						 (<span class="string">&quot;marmalade&quot;</span> . <span class="string">&quot;http://marmalade-repo.org/packages/&quot;</span>)</span><br><span class="line">						 (<span class="string">&quot;elpy&quot;</span> . <span class="string">&quot;http://jorgenschaefer.github.io/packages/&quot;</span>)</span><br><span class="line">						 (<span class="string">&quot;gnu&quot;</span> . <span class="string">&quot;http://elpa.gnu.org/packages/&quot;</span>))</span><br><span class="line">	  package-enable-at-startup <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>
<p>上面的代码涉及到<code>setq</code>（变量赋值）的操作，<code>package-archives</code>，顾名思义，多个包的下载源，我给<code>package-archives</code>设置了5个包源，它们之间服从顺序的优先级，即先从第一个源中下载包，如果没有，到第二个原种寻找，以此类推。此外，这里<code>(&quot;melpa&quot; . &quot;http://melpa.org/packages/&quot;)</code>中的点号（dot）表示法也比较奇怪，其实这是lisp中的<em>Dotted pair</em>表示法，用法和普通的列表类似，但因为是<em>pair</em>的缘故，你可以使用<code>(car )</code>获取<code>&quot;melpa&quot;</code>，<code>(cdr )</code>获取到的却不再是一个列表，而是<code>&quot;http://melpa.org/packages/&quot; </code>这个值本身。</p>
<p>对<em>emacs lisp</em>不熟悉不要紧，先找个教程练习一下它的用法，比如<a target="_blank" rel="noopener" href="https://learnxinyminutes.com/docs/elisp/">learnxinyminutes</a>就非常不错。完成这个教程，大体不会对<em>elisp</em>犯怵了。接下来，只需要使用<code>c-h v</code>和<code>c-h f</code>查看<em>elisp</em>中定义的变量函数就能很快上手自行配置。<br>来个实际的例子，在大牛的配置文件中，经常能看到如下成对的配置：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">setq</span> package-enable-at-startup <span class="literal">nil</span>)</span><br><span class="line">(<span class="name">package-initialize</span>)</span><br></pre></td></tr></table></figure>
<p>开始我觉得这是一对矛盾的配置，<code>package-enable-at-startup</code>设置为nil，暗示emacs启动时不会启用<code>package</code>，而<code>package-initialize</code>明显表明在做<code>package</code>的初始化工作。这种时候，我心中就蹦跶出一句话“世界上本没有矛盾，如果出现了，检查你都有哪些前提条件，就会发现其中一个是错的”。这种非异常的知识点很难通过搜索引擎找到满意的答案，而阅读文档恰恰是最合适的解决方式。emacs对<code>elisp</code>文档的支持非常全面，只需将鼠标移到<code>package-enable-at-startup</code>变量上，按下<code>c-h v</code> (control + h, v) 组合键，就能在其它窗口（window) 看到文档描述：</p>
<blockquote>
<p>Whether to activate installed packages when Emacs starts.<br>If non-nil, packages are activated after reading the init file<br>and before <code>after-init-hook&#39;.  Activation is not done if </code>user-init-file’ is nil (e.g. Emacs was started with “-q”).</p>
</blockquote>
<p>意思是在读入<em>init.el</em>之后，这个变量才会生效。换句话说，在读取<em>init.el</em>的过程中，该变量不论是nil或是non-nil都不会影响<code>package</code>的加载和初始化。所以，这两者之间并没有矛盾。当然，此时你可能会想把<code>package-enable-at-startup</code>设置为nil意欲何为？<a target="_blank" rel="noopener" href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Package-Installation.html">官方文档</a>中有如下的解释：</p>
<blockquote>
<p>This will automatically set package-enable-at-startup to nil, to avoid loading the packages again after processing the init file.</p>
</blockquote>
<p>简单点说，就是防止在<code>package-initialize </code>之后重复加载包，因为可能会影响性能。</p>
<h2 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h2><p>如果把什么东西都揉到<em>init.el</em>文件中，这个文件一定会很快变得臃肿不堪。为了解决这个问题，需要引入模块化的思想——把特定功能的配置放到独立的文件中，然后<code>require</code>进来。按照惯例，我在*~&#x2F;.emacs.d<em>目录下建立一个</em>lisp<em>目录用于存放所有自定义的模块文件，随后在</em>init.el<em>中加入下面这句代码，意在把</em>lisp*目录加到emacs的加载路径列表里。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">add-to-list</span> &#x27;load-path (<span class="name">expand-file-name</span> <span class="string">&quot;lisp&quot;</span> user-emacs-directory))</span><br></pre></td></tr></table></figure>
<p>看似，接下来就可以在每个独立的模块文件中编写各种功能的配置。但是由于<code>package.el</code>功能的局限，我们很快就会遇到包重复安装和配置漂移（configuration drift）的麻烦。<code>package.el</code>提供了<code>package-install-p</code>（p是predicate的意思）和<code>package-install</code>两个配套使用的函数，也就是说一般得先判断包在不在，才决定安不安装。幸运的是，有人已经很好地解决了这部分问题，<a target="_blank" rel="noopener" href="https://github.com/jwiegley/use-package">use-package</a>就是非常好用的包，它将包的配置和包的定义聚合到了一块，并且保证包一定会安装在你的系统当中。<br>在使用<code>use-package</code>之前，我们需要先安装它，如下：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">unless</span> (<span class="name">package-installed-p</span> &#x27;use-package)</span><br><span class="line">  (<span class="name">package-refresh-contents</span>)</span><br><span class="line">  (<span class="name">package-install</span> &#x27;use-package))</span><br><span class="line"></span><br><span class="line">(<span class="name">eval-when-compile</span></span><br><span class="line">  (<span class="name">require</span> &#x27;use-package))</span><br></pre></td></tr></table></figure>
<p>由于<code>use-package</code>本身就是一个包，所以可以使用<code>package-install</code>安装到本地，然后<code>require</code>到emacs的运行时，值得一提的是这个<code>eval-when-compile</code>函数，使用<code>c-h f</code>查看它的定义:</p>
<blockquote>
<p>Like ‘progn’, but evaluates the body at compile time if you’re compiling.<br>Thus, the result of the body appears to the compiler as a quoted constant.<br>In interpreted code, this is entirely equivalent to &#96;progn’.</p>
</blockquote>
<p>初次看到<strong>compile time</strong>，心中难免会有疑问：lisp不是动态语言吗，怎么还需要编译？这种时候，我们就要求助于<em>elisp</em>的文档了。在emacs中按下<code>c-h i</code>获取主话题（topic）的菜单，然后点击<em>Elisp</em>进入它的操作指南。重点查看<em>Evaluation</em>和<em>Byte Compilation</em>两个章节。不难发现lisp的解析器可以读取解析两种类型的lisp代码，一种是适合人类阅读的代码，以<em>el</em>作为后缀；另一种是编译字节码，以<em>elc</em>作为后缀。编译字节码运行速度优于前一种代码，我们可以通过<code>byte-compile-file</code>把前一种代码的文件编译成字节码文件。有趣的是，如果我们使用<em>package</em>来安装包，对应包的目录下都存在配套的<em>el</em>和<em>elc</em>两类文件。<br>在<em>Byte Compilation</em>条目下，有<code>eval-when-compile</code>的完整描述：</p>
<blockquote>
<p>If you’re using another package, but only need macros from it (the byte compiler will expand those), then ‘eval-when-compile’ can be used to load it for compiling, but not executing. For example,</p>
</blockquote>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">eval-when-compile</span></span><br><span class="line">   (<span class="name">require</span> &#x27;my-macro-package))</span><br></pre></td></tr></table></figure>
<p>这里头有三个关键字<strong>load</strong>、<strong>compiling</strong>和<strong>executing</strong>值得留意一下。为了弄懂它们的含义，我们需要了解lisp解析器基本的工作原理：<code>code text -[characters]-&gt; load -[lisp object]-&gt; evaluation/compiling -[bytecode]-&gt; lisp interpretor</code>。换句话说，除非你想编译包含上述代码的文件，否则它的作用和<code>progn</code>一模一样，顺序地求值包含其中的表达式。当你正在编译文件的时候，包中宏就会原地展开，然后被<code>eval-when-compile</code>宏加载进内存并被编译成字节码，供后续解析器执行。</p>
<h2 id="Clojure相关"><a href="#Clojure相关" class="headerlink" title="Clojure相关"></a>Clojure相关</h2><p>载入<em>use-package</em>之后，我需要开始配置自己强大的Clojure开发环境了。首先，引入几个包：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">use-package</span> rainbow-delimiters</span><br><span class="line">  <span class="symbol">:ensure</span> <span class="literal">t</span>)</span><br><span class="line">(<span class="name">use-package</span> clj-refactor</span><br><span class="line">  <span class="symbol">:ensure</span> <span class="literal">t</span>)</span><br><span class="line">(<span class="name">use-package</span> company</span><br><span class="line">  <span class="symbol">:ensure</span> <span class="literal">t</span></span><br><span class="line">  <span class="symbol">:defer</span> <span class="literal">t</span></span><br><span class="line">  <span class="symbol">:config</span> (<span class="name">global-company-mode</span>))</span><br></pre></td></tr></table></figure>
<p><em>rainbow-delimiters</em>能够让括号变得如同彩虹一样绚丽（主要是易于区分forms），<em>clj-refactor</em>是重构Clojure程序的神器，<em>company</em>提供了强大的命令补全提示功能。</p>
<h3 id="clojure-mode"><a href="#clojure-mode" class="headerlink" title="clojure mode"></a>clojure mode</h3><p>接下来，我们在*~&#x2F;.emacs.d&#x2F;lisp<em>目录下新建一个</em>init-clojure.el*文件，内容如下：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">require</span> &#x27;clj-refactor)</span><br><span class="line">(<span class="name">require</span> &#x27;rainbow-delimiters)</span><br><span class="line"></span><br><span class="line">(<span class="name">use-package</span> midje-mode</span><br><span class="line">  <span class="symbol">:ensure</span> <span class="literal">t</span>)</span><br><span class="line"></span><br><span class="line">(<span class="name">defun</span> my-clj-refactor-mode-hook ()</span><br><span class="line">	(<span class="name">clj-refactor-mode</span> <span class="number">1</span>)</span><br><span class="line">	(<span class="name">yas-minor-mode</span> <span class="number">1</span>) <span class="comment">; for adding require/use/import</span></span><br><span class="line">	(<span class="name">cljr-add-keybindings-with-prefix</span> <span class="string">&quot;C-c C-m&quot;</span>))</span><br><span class="line"></span><br><span class="line">(<span class="name">use-package</span> clojure-mode</span><br><span class="line">			 <span class="symbol">:ensure</span> <span class="literal">t</span></span><br><span class="line">			 <span class="symbol">:config</span></span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;clojure-mode-hook #&#x27;rainbow-delimiters-mode)</span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;clojure-mode-hook #&#x27;subword-mode)</span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;clojure-mode-hook #&#x27;midje-mode)</span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;clojure-mode-hook #&#x27;my-clj-refactor-mode-hook)</span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;clojure-mode-hook #&#x27;enable-paredit-mode))</span><br><span class="line"></span><br><span class="line">(<span class="name">provide</span> &#x27;init-clojure)</span><br></pre></td></tr></table></figure>
<p>这里就能看出<em>use-package</em>的好处来了，针对<em>clojure-mode</em>的配置项都统一放到<code>:config</code>中管理起来。配置完毕后，使用<code>(provide &#39;init-clojure)</code>将模块以这样的名字暴露给其它客户端调用。</p>
<h3 id="CIDER-mode"><a href="#CIDER-mode" class="headerlink" title="CIDER mode"></a>CIDER mode</h3><p>有了<em>clojure-mode</em>之后，我们还需要一个Clojure可交互式的开发工具，CIDER便是这么一款工具。同样地，我们在<em>lisp</em>目录下新建一个名为<em>init-clojure-cider.el</em>，内容如下：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">require</span> &#x27;init-clojure)</span><br><span class="line">(<span class="name">require</span> &#x27;company)</span><br><span class="line"></span><br><span class="line">(<span class="name">use-package</span> cider</span><br><span class="line">			 <span class="symbol">:ensure</span> <span class="literal">t</span></span><br><span class="line">			 <span class="symbol">:config</span></span><br><span class="line">			 (<span class="name">setq</span> nrepl-popup-stacktraces <span class="literal">nil</span>)</span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;cider-mode-hook &#x27;eldoc-mode)</span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;cider-mode-hook #&#x27;rainbow-delimiters-mode)</span><br><span class="line">			 <span class="comment">;; Replace return key with newline-and-indent when in cider mode.</span></span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;cider-mode-hook &#x27;(lambda () (local-set-key (kbd <span class="string">&quot;RET&quot;</span>) &#x27;newline-and-indent)))</span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;cider-mode-hook #&#x27;company-mode)</span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;cider-repl-mode-hook &#x27;subword-mode)</span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;cider-repl-mode-hook &#x27;paredit-mode)</span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;cider-repl-mode-hook #&#x27;company-mode)</span><br><span class="line">			 (<span class="name">add-hook</span> &#x27;cider-repl-mode-hook #&#x27;rainbow-delimiters-mode))</span><br><span class="line"></span><br><span class="line">(<span class="name">provide</span> &#x27;init-clojure-cider)</span><br></pre></td></tr></table></figure>
<p>配置的首部，我使用<code>(require &#39;init-clojure)</code>先加载<em>init-clojure</em>，然后对CIDER本身进行一系列的配置。配置的详细信息可以通过CIDER github主页获取到，这里我就不再赘述。</p>
<p>最后，需要在<em>init.el</em>文件中添加入这么一句<code>(require &#39;init-clojure-cider)</code>，重新启动emacs，找到一个Clojure项目，按下<code>C-c M-j</code> (hack-jack-in)，就能获得一个Clojure的交互式开发环境。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>当然，我的emacs配置绝对不止这些，但是其余的过程大体类似。由于emacs速来有伪装成编辑器的操作系统的称号，所以我的探索是无止境的。如果大家对我的配置感兴趣，可以直接去我github上<a target="_blank" rel="noopener" href="https://github.com/qianyan/dotfiles">dotfiles</a>上查看。</p>
<h2 id="—"><a href="#—" class="headerlink" title="—"></a>—</h2><p>参考链接<br>[1] <a target="_blank" rel="noopener" href="https://sriramkswamy.github.io/dotemacs/">sriramkswamy dotemacs</a><br>[2] <a target="_blank" rel="noopener" href="https://github.com/purcell/emacs.d/">purcell emacs.d</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2016/11/04/Generative-Testing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/11/04/Generative-Testing/" class="post-title-link" itemprop="url">Generative Testing</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2016-11-04 07:21:34 / 修改时间：09:13:01" itemprop="dateCreated datePublished" datetime="2016-11-04T07:21:34+08:00">2016-11-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Clojure/" itemprop="url" rel="index"><span itemprop="name">Clojure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>我们为什么要写单元测试？</p>
<p>满足需求是所有软件存在的必要条件，单元测试一定是为它服务的。从这一点出发，我们可以总结出写单元测试的两个动机：驱动（如：TDD）和验证功能实现。另外，软件需求易变的特征决定修改代码成为必然，在这种情况下，单元测试能保护已有的功能不被破坏。</p>
<p>基于以上两点共识，我们看看传统的单元测试有什么特征？</p>
<h2 id="基于用例的测试（By-Example）"><a href="#基于用例的测试（By-Example）" class="headerlink" title="基于用例的测试（By Example）"></a>基于用例的测试（By Example）</h2><p>单元测试最常见的套路就是Given、When、Then三部曲。</p>
<ul>
<li>Given：初始状态或前置条件 </li>
<li>When：行为发生</li>
<li>Then：断言结果</li>
</ul>
<p>编写时，我们会精心准备（Given）一组输入数据，然后在调用行为后，断言返回的结果与预期相符。这种基于用例的测试方式在开发（包括TDD）过程中十分好用。因为它清晰地定义了输入输出，而且大部分情况下体量都很小、容易理解。</p>
<p>但这样的测试方式也有坏处。</p>
<p>第一点在于测试的意图。用例太过具体，我们就很容易忽略自己的测试意图。比如我曾经看过有人在写计算器kata程序的时候，将其中的一个测试命名为<em>return 3 when add 1 and 2</em>，这样的命名其实掩盖了测试用例背后的真实意图——传入两个整型参数，调用add方法之后得到的结果应该是参数之和。我们常说测试即文档，既然是文档就应该明确描述待测方法的行为，而不是陈述一个例子。</p>
<p>第二点在于测试完备性。因为省事省心并且回报率高，我们更乐于写<em>happy path</em>的代码。尽管出于职业道德，我们也会找一个明显的异常路径进行测试，不过这还远远不够。</p>
<p>为了辅助单元测试改善这两点。我这里介绍另一种测试方式——生成式测试（Generative Testing，也称<a target="_blank" rel="noopener" href="https://github.com/fpinscala/fpinscala/wiki/Chapter-8:-Property-based-testing">Property-Based Testing</a>）。这种测试方式会基于输入假设输出，并且生成许多可能的数据验证假设的正确性。</p>
<h2 id="生成式测试"><a href="#生成式测试" class="headerlink" title="生成式测试"></a>生成式测试</h2><p>对于第一个问题，我们换种思路思考一下。假设我们不需要写具体的测试用例，那么掩盖意图的可能性也就没有了。想法很美好，但如何实践Given、When、Then呢？答案是让程序生成并自动验证它们。这也就引出生成式测试的概念——我们先声明传入数据可能的情况，然后使用生成器生成符合入参情况的数据，调用待测方法，最后才进行验证。</p>
<h3 id="Given阶段"><a href="#Given阶段" class="headerlink" title="Given阶段"></a>Given阶段</h3><p>Clojure 1.9（Alpha）新内置的clojure.spec可以很轻松地做到这点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">;; 定义输入参数的可能情况：两个整型参数</span><br><span class="line">(s/def ::add-operators (s/cat :a int? :b int?))</span><br><span class="line">;; 尝试生成数据</span><br><span class="line">(gen/generate (s/gen ::add-operators))</span><br><span class="line"></span><br><span class="line">;; 生成的数据</span><br><span class="line">-&gt; (1 -122)</span><br></pre></td></tr></table></figure>
<p>首先，我们尝试声明两个参数可能出现的情况或者称为规格（specification），即参数a和b都是整数。然后调用生成器产生一对整数。整个分析和构造的过程中，都没有涉及具体的数据，这样会强制我们揣摩输入数据可能的模样，而且也能避免测试意图被掩盖掉——正如前面所说，<em>return 3 when add 1 and 2</em>并不代表什么，<em>return the sum of two integers</em>才具有普遍意义。</p>
<h3 id="Then阶段"><a href="#Then阶段" class="headerlink" title="Then阶段"></a>Then阶段</h3><p>数据是生成了，待测方法也可以调用，但是Then这个断言阶段又让人头疼了，因为我们根本没法预知生成的数据，也就无法知道正确的结果，怎么断言？</p>
<p>拿我们定义的加法运算为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(defn add [a b]</span><br><span class="line">  (+ a b))</span><br></pre></td></tr></table></figure>
<p>我们尝试把断言改成一个全称命题的格式：</p>
<blockquote>
<p>任取两个整数a, b，a和b加起来的结果总是a, b之和。</p>
</blockquote>
<p>借助<a target="_blank" rel="noopener" href="https://github.com/clojure/test.check">test.check</a>，我们在<em>Clojure</em>可以这样表达</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(def test-add</span><br><span class="line">  (prop/for-all [a (gen/int)</span><br><span class="line">                 b (gen/int)]</span><br><span class="line">                (= (add a b) (+ a b))))</span><br></pre></td></tr></table></figure>
<p>等等，我们把add方法的实现<code>(+ a b)</code>写到了断言里，这几乎丧失了单元测试的基本意义。换一种断言方式，我们使用加法的逆运算进行描述：</p>
<blockquote>
<p>任取两个整数，把a和b加起来的结果减去a总会得到b。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(def test-add</span><br><span class="line">  (prop/for-all [a (gen/int)</span><br><span class="line">                 b (gen/int)]</span><br><span class="line">                (= (- (add a b) a) b))))</span><br></pre></td></tr></table></figure>
<p>我们通过程序陈述了一个已知的真命题。变换以后，就可以使用<code>quick-check</code>对多组生成的整数进行测试。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">;; 随机生成100组数据测试add方法</span><br><span class="line">(tc/quick-check 100 test-add)</span><br><span class="line"></span><br><span class="line">;; 测试结果</span><br><span class="line">-&gt; &#123;:result true, :num-tests 100, :seed 1477285296502&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果表明，刚才运行了100组测试，并且都通过了。理论上，程序可以生成无数的测试数据来验证add方法的正确性。即便不能穷尽，我们也获得一组统计上的数字，而不仅仅是几个纯手工挑选的用例。</p>
<p>至于第二个问题，首先得明确测试是无法做到完备的。很多指导方法保证使用较少的用例做到有效覆盖，比如：等价类、边界值、判定表、因果图、pairwise等等。但是在实际使用过程当中，依然存在问题。举个等价类的例子，假如我们有一个接受自然数并直接返回入参的方法<em>identity-nat</em>，那么对于输入参数而言，全体自然数都互为等价类，其中的一个有效等价类可以是自然数1。如果入参被假定在整数的范围，我们很容易找到一个无效等价类，比如-1。</p>
<p>用Clojure测试代码表现出来：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(deftest test-with-identity-nat</span><br><span class="line">  (testing &quot;identity of natural integers&quot;</span><br><span class="line">    (is (= 1 (identity-nat 1))))</span><br><span class="line">  (testing &quot;throw exception for non-natural integers&quot;</span><br><span class="line">    (is (thrown? RuntimeException (identity-nat -1)))))</span><br></pre></td></tr></table></figure>
<p>不过如果有人修改了方法<em>identity-nat</em>的实现，单独处理入参为0的情况，这个测试还是能够照常通过。也就是说，实现发生改变，基于等价类的测试有可能起不到防护作用的。当然你完全可以反驳：规则改变，等价类也得重新定义。道理确实如此，但是反过来想想，我们写测试的目的不正是构建一张安全网吗？我们信任测试能在代码变动时给予警告，但此处它失信了，这就尴尬了。</p>
<p>如果使用生成式测试，我们规定：</p>
<blockquote>
<p>任取一个自然数a，在其上调用f的结果总是a。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(def test-identity-nat</span><br><span class="line"> (prop/for-all [a (s/gen nat-int?)]</span><br><span class="line">               (= a (identity-nat a))))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(tc/quick-check 100 test-identity-nat)</span><br><span class="line"></span><br><span class="line">-&gt; &#123;:result false, :seed 1477362396044, :failing-size 0, :num-tests 1, :fail [0], :shrunk &#123;:total-nodes-visited 0, </span><br><span class="line">         :depth 0, </span><br><span class="line">         :result false, </span><br><span class="line">         :smallest [0]&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>这个测试尝试对100组生成的自然数（nat-int?）进行测试，但首次运行就发现代码发生过变动。失败的数据是0，而且还给出了最小失败集[0]。拿着这个最小失败集，我们就可以快速地重现失败用例，从而修正。</p>
<p>当然也有可能在一次运行中，我们的测试无法发现失败的用例。但是，如果100个测试用例都通过了，至少表明我们程序对于100个随机的自然数都是正确的。和基于用例的测试相比，这就如同编织出一道更加紧密的安全网。网孔越小，漏掉的情况也越少。</p>
<p>Clojure语言之父Rich Hickey推崇*<a target="_blank" rel="noopener" href="https://www.infoq.com/presentations/Simple-Made-Easy">Simple Made Easy</a>*哲学，所以生成式测试在Clojure.spec中有更为简约的表达。以上述为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(s/fdef identity-nat</span><br><span class="line">        :args (s/cat :a nat-int?) ;输入参数的规格</span><br><span class="line">        :ret nat-int?             ;返回结果的规格</span><br><span class="line">        :fn #(= (:ret %) (-&gt; % :args :a))) ;入参和出参之间的约束</span><br><span class="line"></span><br><span class="line">(stest/check `identity-nat)</span><br></pre></td></tr></table></figure>
<p><em>fdef</em>宏定义了方法<em>identity-nat</em>的规格，默认情况下会基于参数的规格生成1000组数据进行生成式测试。除了这一好处，它还提供部分类型检查的功能。</p>
<h2 id="再谈TDD"><a href="#再谈TDD" class="headerlink" title="再谈TDD"></a>再谈TDD</h2><p>TDD（测试驱动开发）是一种驱动代码实现和设计的过程。我们说要先有测试，再去实现；保证实现功能的前提下，重构代码以达到较好的设计。整个过程就好比演绎推理，测试就是其中的证明步骤，而最终实现的功能则是证明的结果。</p>
<p>对于开发人员而言，基于用例的测试方式是友好的，因为它能简单直接地表达实现的功能并保证其正确性。一旦进入红、绿、重构的节（guai）奏（quan），开发人员根本停不下来，进入一种心流状态。只不过问题是，基于用例驱动出来的实现可能并不是<strong>恰好</strong>通过的。我们常常会发现，在写完上组测试用例的实现之后，无需任何改动，下组测试照常能运行通过。换句话说，实现代码可能做了多余的事情而我们却浑然不知。在这种情况下，我们可以利用生成式测试准备大量符合规格的数据探测程序，以此检查程序的健壮性，让缺陷无处遁形。</p>
<p>凡是想到的情况都能测试，但是想不到情况也需要测试。这才是生成式测试的价值所在。有人把TDD概念化为“展示你的功能”（Show your work），而把生成式测试概念化为“检查你的功能“（Check your work），我深以为然。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>回到我们写单元测试的动机上：</p>
<ol>
<li>保证或验证实现功能；</li>
<li>保护已经实现的功能不被破坏。<br>基于用例的单元测试和生成式测试在这两点上是相辅相成的。我们可以借助它们尽可能早地找出缺陷，避免缺陷逃逸到生产环境。</li>
</ol>
<p>ThoughtWorks 2016年11月份的技术雷达把Clojure.spec移到了工具象限的评估环中，这表明这个工具值得作一番探究。当然，除了Clojure，<a target="_blank" rel="noopener" href="http://hypothesis.works/articles/quickcheck-in-every-language/">其它语言</a>都有相应的生成式测试的框架，你不妨在自己的项目中试一试。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2016/09/12/Collection-Pipelines-By-TDD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/09/12/Collection-Pipelines-By-TDD/" class="post-title-link" itemprop="url">Clojure集合管道函数练习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-09-12 09:26:24" itemprop="dateCreated datePublished" datetime="2016-09-12T09:26:24+08:00">2016-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-10-06 10:30:45" itemprop="dateModified" datetime="2016-10-06T10:30:45+08:00">2016-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Clojure/" itemprop="url" rel="index"><span itemprop="name">Clojure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="起源"><a href="#起源" class="headerlink" title="起源"></a>起源</h2><p>TDD讨论组里的<a target="_blank" rel="noopener" href="http://www.jackyshen.com/">申导</a>最近在B站直播了Martin Fowler的经典文章*<a target="_blank" rel="noopener" href="http://www.martinfowler.com/articles/refactoring-pipelines.html">Refactoring with Loops and Collection Pipelines</a><em>中谈到的<strong>利用集合管道对循环进行函数式重构</strong>。视频地址在<a target="_blank" rel="noopener" href="http://www.bilibili.com/mobile/video/av6146294.html">这里</a>，申导的翻译在<a target="_blank" rel="noopener" href="http://www.jackyshen.com/2016/07/04/Refactoring-with-Loops-and-Collection-Pipelines/">这里</a>。组织者<a target="_blank" rel="noopener" href="http://www.seabornlee.cn/">小波（Seaborn Lee）</a>趁机出了一道关于集合管道函数<a target="_blank" rel="noopener" href="https://codingstyle.cn/topics/205">题目</a>。我就想啊，论函数式编程，舍</em>Clojure<em>其谁？而且我在</em>Clojure*很少能写出<code>loop... recur</code>这样偏底层的循环代码。话不多说，撸起袖子开工。</p>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p>一家澡堂有 m 个房间，每个房间有 n 个时段，现在要给用户推荐「最早的可以预约的时段」。</p>
<p>例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">rooms: [</span><br><span class="line">  &#123;</span><br><span class="line">     room_id: 1,</span><br><span class="line">     periods: [</span><br><span class="line">        &#123;</span><br><span class="line">           time: &#x27;17:00-18:00&#x27;,</span><br><span class="line">           status: &#x27;available&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">           time: &#x27;18:00-19:00&#x27;,</span><br><span class="line">           status: &#x27;occupied&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">     ]</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">     room_id: 2,</span><br><span class="line">     periods: [</span><br><span class="line">        &#123;</span><br><span class="line">           time: &#x27;17:00-18:00&#x27;,</span><br><span class="line">           status: &#x27;occupied&#x27;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">           time: &#x27;18:00-19:00&#x27;,</span><br><span class="line">           status: &#x27;available&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">     ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>期望返回：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  room_id: 1,</span><br><span class="line">  time: &#x27;17:00-18:00&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><p>题目很简单，基本思路：首先过滤出每个房间<code>periods</code>中<code>status</code>为<code>available</code>的时间段，然后取第一个也就是最早的时间段（默认为递增排序的），接着将<code>room_id</code>和这个时间段以<strong>期望返回</strong>的形式合并。再然后对所有合并的结果依据时间段进行一次排序（<code>sort</code>），最后取第一个结果即可。</p>
<h2 id="1-Clojure-解法"><a href="#1-Clojure-解法" class="headerlink" title="1. Clojure 解法"></a>1. Clojure 解法</h2><h3 id="转换数据格式"><a href="#转换数据格式" class="headerlink" title="转换数据格式"></a>转换数据格式</h3><p>原题中给的是json的格式，不适合在<em>Clojure</em>中处理，所以我们手工转换成需要的形式，如下：<br><strong>清单1-1</strong> 数据定义</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">def</span> <span class="title">rooms</span></span><br><span class="line">  [&#123;<span class="symbol">:room-id</span> <span class="number">1</span></span><br><span class="line">    <span class="symbol">:periods</span> [&#123;<span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span></span><br><span class="line">               <span class="symbol">:status</span> <span class="symbol">:available</span>&#125;</span><br><span class="line">              &#123;<span class="symbol">:time</span> <span class="string">&quot;18:00-19:00&quot;</span></span><br><span class="line">               <span class="symbol">:status</span> <span class="symbol">:occupied</span>&#125;]&#125;</span><br><span class="line">   &#123;<span class="symbol">:room-id</span> <span class="number">2</span></span><br><span class="line">    <span class="symbol">:periods</span> [&#123;<span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span></span><br><span class="line">               <span class="symbol">:status</span> <span class="symbol">:occupied</span>&#125;</span><br><span class="line">              &#123;<span class="symbol">:time</span> <span class="string">&quot;18:00-19:00&quot;</span></span><br><span class="line">               <span class="symbol">:status</span> <span class="symbol">:available</span>&#125;]&#125;])</span><br></pre></td></tr></table></figure>

<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p><strong>清单1-2</strong> 房间最早可预约时间段</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">the-earliest-available-room</span> [rooms]</span><br><span class="line">  (<span class="name"><span class="built_in">-&gt;&gt;</span></span> rooms</span><br><span class="line">       (<span class="name"><span class="built_in">map</span></span></span><br><span class="line">        (<span class="name"><span class="built_in">juxt</span></span> first (<span class="name"><span class="built_in">fn</span></span> [&#123;<span class="symbol">:keys</span> [periods]&#125;]</span><br><span class="line">                      (<span class="name"><span class="built_in">-&gt;&gt;</span></span> periods</span><br><span class="line">                           (<span class="name"><span class="built_in">filter</span></span> #(<span class="name"><span class="built_in">=</span></span> (<span class="symbol">:status</span> %) <span class="symbol">:available</span>))</span><br><span class="line">                           (<span class="name"><span class="built_in">ffirst</span></span>)))))</span><br><span class="line">       (<span class="name"><span class="built_in">map</span></span> #(<span class="name"><span class="built_in">into</span></span> &#123;&#125; %))</span><br><span class="line">       (<span class="name"><span class="built_in">sort-by</span></span> <span class="symbol">:time</span>)</span><br><span class="line">       (<span class="name"><span class="built_in">first</span></span>)))</span><br><span class="line">       </span><br><span class="line">(<span class="name">the-earliest-available-room</span> rooms)</span><br><span class="line">-&gt; &#123;<span class="symbol">:room-id</span> <span class="number">1</span><span class="punctuation">,</span> <span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码和上面的解析是一一对应的关系。为了让程序清晰，符合管道的用法，这里使用了thread last宏（<code>-&gt;&gt;</code>），它的作用是把前面一个<code>form</code>作为后一个<code>form</code>的最后一个参数。与之呼应的是thread first宏（<code>-&gt;</code>），它的作用类似，不过会传成第一个参数。</p>
<p>我们先看<code>(map (juxt ...) ...)</code>这一段代码。<code>juxt</code>是一个非常有意思的函数，而且超级实用。它的文档描述如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">doc</span> juxt)</span><br><span class="line">-&gt;</span><br><span class="line">clojure.core/juxt</span><br><span class="line"> [f]</span><br><span class="line"> [f g]</span><br><span class="line"> [f g h]</span><br><span class="line"> [f g h &amp; fs]</span><br><span class="line">Added in <span class="number">1.1</span></span><br><span class="line">  Takes a set of functions and returns a fn that is the juxtaposition</span><br><span class="line">  of those fns.  The returned fn takes a variable number of args<span class="punctuation">,</span> and</span><br><span class="line">  returns a vector containing the result of applying each fn to the</span><br><span class="line">  args (<span class="name">left-to-right</span>).</span><br><span class="line">  ((<span class="name"><span class="built_in">juxt</span></span> a b c) x) =&gt; [(<span class="name">a</span> x) (<span class="name">b</span> x) (<span class="name">c</span> x)]</span><br></pre></td></tr></table></figure>
<p>它的神奇之处在于可以对同一个参数应用不同的函数，而且还能将应用的结果全部收集起来。想想题目的解析中提及的以<strong>期望返回</strong>的形式合并，如果我们应用<code>juxt</code>函数，就能得到<code>[(:room-id 1) (:time &quot;17:00-18:00&quot;)]</code>这样的中间结果。</p>
<p><code>(juxt first (fn ...))</code>中<code>first</code>用于提取<code>:room-id</code>，而后面的<code>lambda</code>表达式则用于提取<code>:time</code>。解法很直观，筛选出<code>:status</code>是<code>:available</code>的时间段，然后使用<code>(ffirst)</code>取第一个map的首个entry。如：<code>&#123;:time &quot;17:00-18:00&quot; :status :available&#125;</code>，那么应用<code>(ffirst)</code>的结果就是<code>[:time &quot;17:00-18:00&quot;]</code>。</p>
<p>接下来，又进行了一次map操作，这次的目的是把元组的entries，转换为map。举个例子：<code>[[:room-id 1] [:time &quot;17:00-18:00&quot;]]</code> &#x3D;&gt; <code>&#123;:room-id 1 :time &quot;17:00-18:00&quot;&#125;</code>。转换成map之后，方便以<code>:time</code>对结果进行排序<code>(sort-by :time)</code>，最后取出第一个元素<code>(first)</code>，即我们期望的返回。</p>
<p>写完之后，我很想再写个TDD版本的。话不多说，继续撸袖子。</p>
<h2 id="2-Clojure-TDD-解法"><a href="#2-Clojure-TDD-解法" class="headerlink" title="2. Clojure TDD 解法"></a>2. Clojure TDD 解法</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul>
<li>生成工程</li>
</ul>
<p>进入命令行，输入<code>lein new midje the-earliest-available-period-of-bathroom</code>，leiningen会生成基于<code>midje</code>这个测试框架的工程。</p>
<ul>
<li><p>Git</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">&gt; .gitignore</span><br><span class="line">.lein*</span><br><span class="line">.nrep*</span><br><span class="line">target/</span><br><span class="line">这里ctrl-c退出</span><br><span class="line">git add .</span><br><span class="line">git commit --message &quot;init commit&quot;</span><br></pre></td></tr></table></figure>
<p>我使用了<code>zsh</code>和<code>oh-my-zsh</code>，自带了很多git操作的alias，可以通过<code>alias |grep git</code>查看。后续的git操作都会使用alias。</p>
</li>
<li><p>自动测试</p>
</li>
</ul>
<p>输入<code>lein repl</code>，然后<code>(use &#39;midje.repl)</code>，最后输入<code>(autotest)</code>。这样一旦文件修改保存，测试就会自动触发。</p>
<ul>
<li>Emacs</li>
</ul>
<p>用来写代码的。</p>
<h3 id="Tasking（任务拆分）"><a href="#Tasking（任务拆分）" class="headerlink" title="Tasking（任务拆分）"></a>Tasking（任务拆分）</h3><p>先不急着敲代码，我们先从测试的角度看看完成这个需求需要哪几步？</p>
<ul>
<li><input disabled="" type="checkbox"> 单间澡堂有一个可用时间段</li>
<li><input disabled="" type="checkbox"> 单间澡堂有多个可用时间段</li>
<li><input disabled="" type="checkbox"> 所有澡堂（包含输入为空）没有可用时间段</li>
<li><input disabled="" type="checkbox"> 多间澡堂都有可用时间段</li>
<li><input disabled="" type="checkbox"> 多间澡堂中有的有可用时间段，有的没有可用时间段</li>
</ul>
<h3 id="第1个任务"><a href="#第1个任务" class="headerlink" title="第1个任务"></a>第1个任务</h3><ul>
<li><input disabled="" type="checkbox"> 单间澡堂有一个可用时间段</li>
</ul>
<h4 id="1-写测试"><a href="#1-写测试" class="headerlink" title="1. 写测试"></a>1. 写测试</h4><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">def</span> <span class="title">room-1</span> &#123;<span class="symbol">:room-id</span> <span class="number">1</span></span><br><span class="line">    <span class="symbol">:periods</span> [&#123;<span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span></span><br><span class="line">               <span class="symbol">:status</span> <span class="symbol">:available</span>&#125;</span><br><span class="line">              &#123;<span class="symbol">:time</span> <span class="string">&quot;18:00-19:00&quot;</span></span><br><span class="line">               <span class="symbol">:status</span> <span class="symbol">:occupied</span>&#125;]&#125;)</span><br><span class="line"></span><br><span class="line">(<span class="keyword">def</span> <span class="title">room-2</span> &#123;<span class="symbol">:room-id</span> <span class="number">2</span></span><br><span class="line">             <span class="symbol">:periods</span> [&#123;<span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span></span><br><span class="line">                        <span class="symbol">:status</span> <span class="symbol">:occupied</span>&#125;</span><br><span class="line">                       &#123;<span class="symbol">:time</span> <span class="string">&quot;18:00-19:00&quot;</span></span><br><span class="line">                        <span class="symbol">:status</span> <span class="symbol">:available</span>&#125;]&#125;)</span><br><span class="line">                        </span><br><span class="line">(<span class="name">facts</span> <span class="string">&quot;about `the-earliest-avaible-period-of-bathroom`&quot;</span></span><br><span class="line">  (<span class="name">fact</span> <span class="string">&quot;should recommand if there is only one room with available period&quot;</span></span><br><span class="line">    <span class="comment">;; 1号</span></span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [room-1]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">1</span> <span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span>&#125;)</span><br><span class="line">    <span class="comment">;; 2号</span></span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [room-2]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">2</span> <span class="symbol">:time</span> <span class="string">&quot;18:00-19:00&quot;</span>&#125;))</span><br></pre></td></tr></table></figure>

<h4 id="2-写实现"><a href="#2-写实现" class="headerlink" title="2. 写实现"></a>2. 写实现</h4><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">the-earliest-available-recommand</span> [rooms]</span><br><span class="line">  &#123;<span class="symbol">:room-id</span> <span class="number">1</span> <span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>针对1号测试，这个实现有点“荒诞”，术语<code>hard code</code>说的就是这个，但是眼下足够了。不过此时，应该再写一个类似的测试来去除<code>hard code</code>，即2号测试。<br>相应地，我们要修改实现。</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">defn the-earliest-available-recommand [rooms]</span><br><span class="line">  (<span class="name"><span class="built_in">let</span></span> [&#123;<span class="symbol">:keys</span> [room-id periods]&#125; (<span class="name"><span class="built_in">first</span></span> rooms)</span><br><span class="line">        available-periods (<span class="name"><span class="built_in">filter</span></span> #(#&#123;<span class="symbol">:available</span>&#125; (<span class="symbol">:status</span> %)) periods)]</span><br><span class="line">    (<span class="name"><span class="built_in">merge</span></span> &#123;<span class="symbol">:room-id</span> room-id&#125;</span><br><span class="line">           (<span class="name"><span class="built_in">select-keys</span></span> (<span class="name"><span class="built_in">first</span></span> available-periods) [<span class="symbol">:time</span>]))))</span><br></pre></td></tr></table></figure>

<h4 id="3-关闭并提交"><a href="#3-关闭并提交" class="headerlink" title="3. 关闭并提交"></a>3. 关闭并提交</h4><ul>
<li><input checked="" disabled="" type="checkbox"> 单间澡堂有一个可用时间段</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ga .</span><br><span class="line">gcmsg &quot;one available room&quot;</span><br></pre></td></tr></table></figure>
<h3 id="第2个任务"><a href="#第2个任务" class="headerlink" title="第2个任务"></a>第2个任务</h3><ul>
<li><input disabled="" type="checkbox"> 单间澡堂有多个可用时间段</li>
</ul>
<h4 id="1-写测试-1"><a href="#1-写测试-1" class="headerlink" title="1. 写测试"></a>1. 写测试</h4><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">def</span> <span class="title">room-3</span> &#123;<span class="symbol">:room-id</span> <span class="number">3</span></span><br><span class="line">             <span class="symbol">:periods</span> [&#123;<span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span></span><br><span class="line">                        <span class="symbol">:status</span> <span class="symbol">:occupied</span>&#125;</span><br><span class="line">                       &#123;<span class="symbol">:time</span> <span class="string">&quot;18:00-19:00&quot;</span></span><br><span class="line">                        <span class="symbol">:status</span> <span class="symbol">:available</span>&#125;</span><br><span class="line">                       &#123;<span class="symbol">:time</span> <span class="string">&quot;19:00-20:00&quot;</span></span><br><span class="line">                        <span class="symbol">:status</span> <span class="symbol">:available</span>&#125;]&#125;)</span><br><span class="line">...                        </span><br><span class="line">(<span class="name">fact</span> <span class="string">&quot;should recommand the earliest one if there is only one room with multiple available periods&quot;</span></span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [room-3]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">3</span> <span class="symbol">:time</span> <span class="string">&quot;18:00-19:00&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>保存，发现测试还是跑过了。原因在于我们默认了<code>period</code>是递增排序的。我们看看有没有重构点？实现太简单了暂时找不到，那就欢欢喜喜地跳过实现步骤。</p>
<h4 id="2-关闭并提交"><a href="#2-关闭并提交" class="headerlink" title="2. 关闭并提交"></a>2. 关闭并提交</h4><ul>
<li><input checked="" disabled="" type="checkbox"> 单间澡堂有多个可用时间段<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ga .</span><br><span class="line">gcmsg &quot;one room with multiple available periods&quot;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="第3个任务"><a href="#第3个任务" class="headerlink" title="第3个任务"></a>第3个任务</h3><ul>
<li><input disabled="" type="checkbox"> 所有澡堂（包含输入为空）没有可用时间段</li>
</ul>
<h4 id="1-写测试-2"><a href="#1-写测试-2" class="headerlink" title="1. 写测试"></a>1. 写测试</h4><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">def</span> <span class="title">non-available-room</span> &#123;<span class="symbol">:room-id</span> <span class="number">4</span></span><br><span class="line">             <span class="symbol">:periods</span> [&#123;<span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span></span><br><span class="line">                        <span class="symbol">:status</span> <span class="symbol">:occupied</span>&#125;</span><br><span class="line">                       &#123;<span class="symbol">:time</span> <span class="string">&quot;18:00-19:00&quot;</span></span><br><span class="line">                        <span class="symbol">:status</span> <span class="symbol">:occupied</span>&#125;</span><br><span class="line">                       &#123;<span class="symbol">:time</span> <span class="string">&quot;19:00-20:00&quot;</span></span><br><span class="line">                        <span class="symbol">:status</span> <span class="symbol">:occupied</span>&#125;]&#125;)</span><br><span class="line">                        </span><br><span class="line">(<span class="name">fact</span> <span class="string">&quot;should show `:no-available-room` if there is no available room&quot;</span></span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> []) =&gt; <span class="symbol">:no-available-room</span></span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [non-available-room]) =&gt; <span class="symbol">:no-available-room</span>))                        </span><br></pre></td></tr></table></figure>
<p>这回肯定挂掉。</p>
<h4 id="2-写实现-1"><a href="#2-写实现-1" class="headerlink" title="2. 写实现"></a>2. 写实现</h4><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">the-earliest-available-recommand</span> [rooms]</span><br><span class="line">  (<span class="name"><span class="built_in">let</span></span> [&#123;<span class="symbol">:keys</span> [room-id periods]&#125; (<span class="name"><span class="built_in">first</span></span> rooms)</span><br><span class="line">        available-periods (<span class="name"><span class="built_in">filter</span></span> #(#&#123;<span class="symbol">:available</span>&#125; (<span class="symbol">:status</span> %)) periods)]</span><br><span class="line">    (<span class="name"><span class="built_in">if</span></span> (<span class="name"><span class="built_in">seq</span></span> available-periods)</span><br><span class="line">      (<span class="name"><span class="built_in">merge</span></span> &#123;<span class="symbol">:room-id</span> room-id&#125;</span><br><span class="line">             (<span class="name"><span class="built_in">select-keys</span></span> (<span class="name"><span class="built_in">first</span></span> available-periods) [<span class="symbol">:time</span>]))</span><br><span class="line">      <span class="symbol">:no-available-room</span>)))</span><br></pre></td></tr></table></figure>
<p>这里使用了<em>Clojure</em>中判断集合是否为空较为常用的手法<code>(seq )</code>，如果集合非空，那么返回集合本身；反之，返回nil，nil在逻辑上是false。测试通过。</p>
<h4 id="3-关闭并提交-1"><a href="#3-关闭并提交-1" class="headerlink" title="3. 关闭并提交"></a>3. 关闭并提交</h4><ul>
<li><input checked="" disabled="" type="checkbox"> 所有澡堂（包含输入为空）没有可用时间段</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ga .</span><br><span class="line">gcmsg &quot;no available room&quot;</span><br></pre></td></tr></table></figure>

<h3 id="第4个任务"><a href="#第4个任务" class="headerlink" title="第4个任务"></a>第4个任务</h3><ul>
<li><input disabled="" type="checkbox"> 多间澡堂都有可用时间段</li>
</ul>
<h4 id="1-写测试-3"><a href="#1-写测试-3" class="headerlink" title="1. 写测试"></a>1. 写测试</h4><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">fact</span> <span class="string">&quot;should recommand the earliest if there has more than one room and each has available periods&quot;</span></span><br><span class="line">   (<span class="name">the-earliest-available-recommand</span> [room-1 room-2]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">1</span> <span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span>&#125;</span><br><span class="line">   (<span class="name">the-earliest-available-recommand</span> [room-2 room-1]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">1</span> <span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span>&#125;</span><br><span class="line">   (<span class="name">the-earliest-available-recommand</span> [room-2 room-3]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">2</span> <span class="symbol">:time</span> <span class="string">&quot;18:00-19:00&quot;</span>&#125;</span><br><span class="line">   (<span class="name">the-earliest-available-recommand</span> [room-1 room-2 room-3]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">1</span> <span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="2-写实现-2"><a href="#2-写实现-2" class="headerlink" title="2. 写实现"></a>2. 写实现</h4><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">the-earliest-available-recommand</span> [rooms]</span><br><span class="line">  (<span class="name"><span class="built_in">if</span></span> (<span class="name"><span class="built_in">seq</span></span> rooms)</span><br><span class="line">    (<span class="name"><span class="built_in">first</span></span> (<span class="name"><span class="built_in">sort-by</span></span> <span class="symbol">:time</span></span><br><span class="line">                    (<span class="name"><span class="built_in">map</span></span> (<span class="name"><span class="built_in">fn</span></span> [room]</span><br><span class="line">                           (<span class="name"><span class="built_in">let</span></span> [&#123;<span class="symbol">:keys</span> [room-id periods]&#125; room</span><br><span class="line">                                 available-periods (<span class="name"><span class="built_in">filter</span></span> #(#&#123;<span class="symbol">:available</span>&#125; (<span class="symbol">:status</span> %)) periods)]</span><br><span class="line">                             (<span class="name"><span class="built_in">if</span></span> (<span class="name"><span class="built_in">seq</span></span> available-periods)</span><br><span class="line">                               (<span class="name"><span class="built_in">merge</span></span> &#123;<span class="symbol">:room-id</span> room-id&#125;</span><br><span class="line">                                      (<span class="name"><span class="built_in">select-keys</span></span> (<span class="name"><span class="built_in">first</span></span> available-periods) [<span class="symbol">:time</span>]))</span><br><span class="line">                               <span class="symbol">:no-available-room</span>)))</span><br><span class="line">                         rooms)))</span><br><span class="line">    <span class="symbol">:no-available-room</span>))</span><br></pre></td></tr></table></figure>
<p>到这里，我们开始使用<code>(map )</code>函数处理多个房间的内容。注意，当输入房间是空集合的时候，这里需要相应地做<code>(seq rooms)</code>判空处理，否则会返回nil，而不是我们想要的<code>:no-available-room</code>。</p>
<h4 id="3-关闭并提交-2"><a href="#3-关闭并提交-2" class="headerlink" title="3. 关闭并提交"></a>3. 关闭并提交</h4><ul>
<li><input checked="" disabled="" type="checkbox"> 多间澡堂都有可用时间段</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ga .</span><br><span class="line">gcmsg &quot;more than one room&quot;</span><br></pre></td></tr></table></figure>

<h4 id="4-重构"><a href="#4-重构" class="headerlink" title="4. 重构"></a>4. 重构</h4><p>代码写到这里，再不重构就说不过去了。另外，管道没看到，倒是看到一堆括号。<br>我们使用thread last<code>(-&gt;&gt; )</code>做一次重构：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">the-earliest-available-recommand</span> [rooms]</span><br><span class="line">  (<span class="name"><span class="built_in">if</span></span> (<span class="name"><span class="built_in">seq</span></span> rooms)</span><br><span class="line">    (<span class="name"><span class="built_in">-&gt;&gt;</span></span> rooms</span><br><span class="line">         (<span class="name"><span class="built_in">map</span></span> (<span class="name"><span class="built_in">fn</span></span> [room]</span><br><span class="line">                (<span class="name"><span class="built_in">let</span></span> [&#123;<span class="symbol">:keys</span> [room-id periods]&#125; room</span><br><span class="line">                      available-periods (<span class="name"><span class="built_in">filter</span></span> #(#&#123;<span class="symbol">:available</span>&#125; (<span class="symbol">:status</span> %)) periods)]</span><br><span class="line">                  (<span class="name"><span class="built_in">if</span></span> (<span class="name"><span class="built_in">seq</span></span> available-periods)</span><br><span class="line">                    (<span class="name"><span class="built_in">merge</span></span> &#123;<span class="symbol">:room-id</span> room-id&#125;</span><br><span class="line">                           (<span class="name"><span class="built_in">select-keys</span></span> (<span class="name"><span class="built_in">first</span></span> available-periods) [<span class="symbol">:time</span>]))</span><br><span class="line">                    <span class="symbol">:no-available-room</span>))))</span><br><span class="line">         (<span class="name"><span class="built_in">sort-by</span></span> <span class="symbol">:time</span>)</span><br><span class="line">         first)</span><br><span class="line">    <span class="symbol">:no-available-room</span>))</span><br></pre></td></tr></table></figure>
<p>还行，至少没那么多嵌套了。提交一次。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ga .</span><br><span class="line">gcmsg &quot;[refactor] use macro thread-last -&gt;&gt; to pipe&quot;</span><br></pre></td></tr></table></figure>
<p>继续重构，使用我们的<code>juxt</code>函数。</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">the-earliest-available-recommand</span> [rooms]</span><br><span class="line">  (<span class="name"><span class="built_in">letfn</span></span> [(<span class="name">period</span> [&#123;<span class="symbol">:keys</span> [periods]&#125;]</span><br><span class="line">            (<span class="name"><span class="built_in">-&gt;&gt;</span></span> periods</span><br><span class="line">                 (<span class="name"><span class="built_in">filter</span></span> #(#&#123;<span class="symbol">:available</span>&#125; (<span class="symbol">:status</span> %)))</span><br><span class="line">                 ffirst</span><br><span class="line">                 (#(<span class="name"><span class="built_in">or</span></span> % [<span class="symbol">:time</span> <span class="symbol">::non-available</span>]))))]</span><br><span class="line">    (<span class="name"><span class="built_in">-&gt;&gt;</span></span> rooms</span><br><span class="line">         (<span class="name"><span class="built_in">map</span></span> (<span class="name"><span class="built_in">fn</span></span> [room]</span><br><span class="line">                (<span class="name"><span class="built_in">apply</span></span> conj &#123;&#125; ((<span class="name"><span class="built_in">juxt</span></span> first period) room))))</span><br><span class="line">         (<span class="name"><span class="built_in">remove</span></span> #(#&#123;<span class="symbol">::non-available</span>&#125; (<span class="symbol">:time</span> %)))</span><br><span class="line">         (<span class="name"><span class="built_in">sort-by</span></span> <span class="symbol">:time</span>)</span><br><span class="line">         first</span><br><span class="line">         (#(<span class="name"><span class="built_in">or</span></span> % <span class="symbol">:no-available-room</span>)))))</span><br></pre></td></tr></table></figure>
<p>看上去还行，不过不爽的是<code>(#(or % [:time ::non-available]))</code>。为了迎合<code>(-&gt;&gt; )</code>宏，我们给<code>(or )</code>包了一层。原因是<code>(-&gt;&gt; )</code>会让前面的结果出现在最后一个参数的位置，而我们需要将结果放到<code>(or )</code>的第一个参数的位置。有没有什么好看的解决方法呢？当然有！我们可以使用<code>(-&gt; )</code>来做到这点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(defn the-earliest-available-recommand [rooms]</span><br><span class="line">  (letfn [(period [&#123;:keys [periods]&#125;]</span><br><span class="line">            (-&gt; periods</span><br><span class="line">                (-&gt;&gt; (filter #(#&#123;:available&#125; (:status %)))</span><br><span class="line">                     ffirst)</span><br><span class="line">                (or [:time ::non-available])))]</span><br><span class="line">    (-&gt; rooms</span><br><span class="line">        (-&gt;&gt; (map (fn [room]</span><br><span class="line">                    (apply conj &#123;&#125; ((juxt first period) room))))</span><br><span class="line">             (remove #(#&#123;::non-available&#125; (:time %)))</span><br><span class="line">             (sort-by :time)</span><br><span class="line">             first)</span><br><span class="line">        (or :no-available-room))))</span><br></pre></td></tr></table></figure>
<p>顿时觉得世界干净了不少。再提交一次。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ga .</span><br><span class="line">gcmsg &quot;[refactor] use juxt to extract needed fields&quot;</span><br></pre></td></tr></table></figure>
<h3 id="第5个任务"><a href="#第5个任务" class="headerlink" title="第5个任务"></a>第5个任务</h3><ul>
<li><input disabled="" type="checkbox"> 多间澡堂中有的有可用时间段，有的没有可用时间段</li>
</ul>
<h4 id="1-写测试-4"><a href="#1-写测试-4" class="headerlink" title="1. 写测试"></a>1. 写测试</h4><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">fact</span> <span class="string">&quot;should recommand the earliest available room even if there has non available room&quot;</span></span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [room-1 non-available-room]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">1</span> <span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span>&#125;</span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [room-2 non-available-room]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">2</span> <span class="symbol">:time</span> <span class="string">&quot;18:00-19:00&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>测试直接通过，又可以跳过实现代码了。不过，这也预示着我们的测试是有覆盖的，也需要花时间整理这些测试用例。在那之前，先提交一下。</p>
<h4 id="2-关闭并提交-1"><a href="#2-关闭并提交-1" class="headerlink" title="2. 关闭并提交"></a>2. 关闭并提交</h4><ul>
<li><input checked="" disabled="" type="checkbox"> 多间澡堂中有的有可用时间段，有的没有可用时间段</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ga .</span><br><span class="line">gcmsg &quot;mixed non-available and available rooms&quot;</span><br></pre></td></tr></table></figure>
<h3 id="为第3个任务补上测试用例"><a href="#为第3个任务补上测试用例" class="headerlink" title="为第3个任务补上测试用例"></a>为第3个任务补上测试用例</h3><ul>
<li><input checked="" disabled="" type="checkbox"> 所有（包含多个）澡堂（包含输入为空）没有可用时间段</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">fact</span> <span class="string">&quot;should show `:no-available-room` if there is no available room&quot;</span></span><br><span class="line">   (<span class="name">the-earliest-available-recommand</span> []) =&gt; <span class="symbol">:no-available-room</span></span><br><span class="line">   (<span class="name">the-earliest-available-recommand</span> [non-available-room]) =&gt; <span class="symbol">:no-available-room</span></span><br><span class="line">   (<span class="name">the-earliest-available-recommand</span> [non-available-room non-available-room]) =&gt; <span class="symbol">:no-available-room</span>))</span><br></pre></td></tr></table></figure>
<p>这里的第3个用例包含第2个用例，我们待会整理掉。不过现在先提交一下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ga .</span><br><span class="line">gcmsg &quot;multiple non-available rooms&quot;</span><br></pre></td></tr></table></figure>
<h3 id="整理测试"><a href="#整理测试" class="headerlink" title="整理测试"></a>整理测试</h3><p>在前面进行的任务当中，我们发现有两次没有写实现测试就通过的情况。这说明测试用例是有覆盖的。</p>
<ul>
<li>第2个任务的测试用例其实覆盖了第1个任务的测试用例，所以可以直接删去后者；</li>
<li>第5个任务的测试用例覆盖了第4个任务的部分测试用例，所以可以合并到一起。</li>
</ul>
<p>整理下来，最终的测试变成下面这样：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">facts</span> <span class="string">&quot;about `the-earliest-avaible-period-of-bathroom`&quot;</span></span><br><span class="line">  (<span class="name">fact</span> <span class="string">&quot;should recommand the earliest one if there is only one room with multiple available periods&quot;</span></span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [room-3]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">3</span> <span class="symbol">:time</span> <span class="string">&quot;18:00-19:00&quot;</span>&#125;)</span><br><span class="line">  </span><br><span class="line">  (<span class="name">fact</span> <span class="string">&quot;should show `:no-available-room` if there is no available room&quot;</span></span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> []) =&gt; <span class="symbol">:no-available-room</span></span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [non-available-room non-available-room]) =&gt; <span class="symbol">:no-available-room</span>)</span><br><span class="line"> </span><br><span class="line">  (<span class="name">fact</span> <span class="string">&quot;should recommand the earliest if there has more than one room and each may have available periods&quot;</span></span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [room-1 room-2]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">1</span> <span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span>&#125;</span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [room-2 room-1]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">1</span> <span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span>&#125;</span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [room-2 room-3]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">2</span> <span class="symbol">:time</span> <span class="string">&quot;18:00-19:00&quot;</span>&#125;</span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [room-1 room-2 room-3]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">1</span> <span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span>&#125;</span><br><span class="line">    (<span class="name">the-earliest-available-recommand</span> [room-1 non-available-room]) =&gt; &#123;<span class="symbol">:room-id</span> <span class="number">1</span> <span class="symbol">:time</span> <span class="string">&quot;17:00-18:00&quot;</span>&#125;))</span><br></pre></td></tr></table></figure>
<h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><blockquote>
<p>The final goal of any engineering activity is some type of documentation.</p>
</blockquote>
<p>更新README.md文件，其中描述程序解决的问题以及运行步骤，当然包含设计思路那更好了。提交一下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ga .</span><br><span class="line">gcmsg &quot;update readme&quot;</span><br></pre></td></tr></table></figure>

<h3 id="美化代码"><a href="#美化代码" class="headerlink" title="美化代码"></a>美化代码</h3><blockquote>
<p>代码是诗行 - by lambeta</p>
</blockquote>
<h2 id="什么是好看的代码？除了清晰明了，格式也必须产生美感。顺眼不少，最后提交一下。"><a href="#什么是好看的代码？除了清晰明了，格式也必须产生美感。顺眼不少，最后提交一下。" class="headerlink" title="什么是好看的代码？除了清晰明了，格式也必须产生美感。顺眼不少，最后提交一下。"></a>什么是好看的代码？除了清晰明了，格式也必须产生美感。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">the-earliest-available-recommand</span> [rooms]</span><br><span class="line">  (<span class="name"><span class="built_in">letfn</span></span> [(<span class="name">period</span> [&#123;<span class="symbol">:keys</span> [periods]&#125;]</span><br><span class="line">            (<span class="name"><span class="built_in">-&gt;</span></span> periods</span><br><span class="line">                (<span class="name"><span class="built_in">-&gt;&gt;</span></span> (<span class="name"><span class="built_in">filter</span></span> #(#&#123;<span class="symbol">:available</span>&#125; (<span class="symbol">:status</span> %))))</span><br><span class="line">                (<span class="name"><span class="built_in">ffirst</span></span>) <span class="comment">; 统一套上括号</span></span><br><span class="line">                (<span class="name"><span class="built_in">or</span></span> [<span class="symbol">:time</span> <span class="symbol">::non-available</span>])))]</span><br><span class="line">    (<span class="name"><span class="built_in">-&gt;</span></span> rooms</span><br><span class="line">        (<span class="name"><span class="built_in">-&gt;&gt;</span></span> (<span class="name"><span class="built_in">map</span></span> (<span class="name"><span class="built_in">juxt</span></span> first period))</span><br><span class="line">             (<span class="name"><span class="built_in">map</span></span> #(<span class="name"><span class="built_in">into</span></span> &#123;&#125; %)) <span class="comment">; 合并单独提出来</span></span><br><span class="line">             (<span class="name"><span class="built_in">remove</span></span> #(#&#123;<span class="symbol">::non-available</span>&#125; (<span class="symbol">:time</span> %)))</span><br><span class="line">             (<span class="name"><span class="built_in">sort-by</span></span> <span class="symbol">:time</span>)</span><br><span class="line">             (<span class="name"><span class="built_in">first</span></span>)) <span class="comment">; 统一套上括号</span></span><br><span class="line">        (<span class="name"><span class="built_in">or</span></span> <span class="symbol">:no-available-room</span>))))</span><br></pre></td></tr></table></figure><br>顺眼不少，最后提交一下。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ga .</span><br><span class="line">gcmsg &quot;[refactor] beautify pipe format&quot;</span><br></pre></td></tr></table></figure></h2><p>这篇文章发出来一天，TDD讨论群的一位麦姓朋友@我道：</p>
<blockquote>
<p>core&#x3D;&gt; (first {:a 1 :b 2})<br>[:a 1]<br>core&#x3D;&gt; (first {:b 2 :a 1})<br>[:b 2]<br>@lambeta map的元素应该是无序的，用first来获得key value pair是不可靠的。</p>
</blockquote>
<p>看到这个建议的时候，我心里一阵欣喜——又有一员<em>Clojurians</em>，可以切磋技艺了！冷静下来，发现自己确实忽略了map中的entries可能是无序的。所以我做了如下的验证：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">type</span></span> &#123;&#125;)</span><br><span class="line">-&gt; clojure.lang.PersistentArrayMap</span><br></pre></td></tr></table></figure>
<p>看到<code>PersistentArrayMap</code>的时候，我明白这些entries是保持插入顺序的，也就是说，<code>(first &#123;:a 1 :b 2&#125;)</code>的求值结果一定是<code>[:a 1]</code>。照这个思路，在我的程序当中使用<code>(first )</code>取map的第一个元素并不会出错。不过，本着谨慎的心态，我查了一下clojure的<a target="_blank" rel="noopener" href="https://clojuredocs.org/clojure.core/array-map">array-map</a>，发现一个有趣的例子：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">make-map</span> [count] (<span class="name"><span class="built_in">zipmap</span></span> (<span class="name"><span class="built_in">range</span></span> count) (<span class="name"><span class="built_in">range</span></span> count)))</span><br><span class="line">(<span class="name"><span class="built_in">type</span></span> (<span class="name">make-map</span> <span class="number">9</span>))</span><br><span class="line"><span class="comment">;; =&gt; clojure.lang.PersistentArrayMap</span></span><br><span class="line">(<span class="name"><span class="built_in">type</span></span> (<span class="name">make-map</span> <span class="number">10</span>))</span><br><span class="line"><span class="comment">;; =&gt; clojure.lang.PersistentHashMap</span></span><br></pre></td></tr></table></figure>
<p>这表明当map中的entries数量超过一定数量（不一定是9，例外见：<a target="_blank" rel="noopener" href="http://dev.clojure.org/jira/browse/CLJ-1587">PersistentArrayMap’s assoc doesn’t respect HASHTABLE_THRESHOLD</a>）时，<code>PersistentArrayMap</code>就变成了<code>PersistentHashMap</code>，那也就意味着，<code>(first )</code>取出来的值可能是<em>随机的</em>。举个例子：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">first</span></span> &#123;<span class="number">7</span> <span class="number">7</span><span class="punctuation">,</span> <span class="number">1</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">4</span> <span class="number">4</span><span class="punctuation">,</span> <span class="number">6</span> <span class="number">6</span><span class="punctuation">,</span> <span class="number">3</span> <span class="number">3</span><span class="punctuation">,</span> <span class="number">2</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">9</span> <span class="number">9</span><span class="punctuation">,</span> <span class="number">0</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">8</span> <span class="number">8</span><span class="punctuation">,</span> <span class="number">5</span> <span class="number">5</span>&#125;)</span><br><span class="line">-&gt; [<span class="number">0</span> <span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>返回的结果并不是相当然的<code>[7 7]</code>，而是<code>[0 0]</code>。那么<code>(first )</code>到底干了些什么呢？Cognitect公司的<a target="_blank" rel="noopener" href="https://github.com/puredanger">alexmiller</a>回答我说：<code>(first )</code>会把它的参数强制转换（coerce）成了一个序列，然后取第一个值。我们试着用<code>(seq )</code>转换一下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">type</span></span> &#123; <span class="number">7</span> <span class="number">7</span><span class="punctuation">,</span> <span class="number">1</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">4</span> <span class="number">4</span><span class="punctuation">,</span> <span class="number">6</span> <span class="number">6</span><span class="punctuation">,</span> <span class="number">3</span> <span class="number">3</span><span class="punctuation">,</span> <span class="number">2</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">9</span> <span class="number">9</span><span class="punctuation">,</span> <span class="number">0</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">8</span> <span class="number">8</span><span class="punctuation">,</span> <span class="number">5</span> <span class="number">5</span>&#125;)</span><br><span class="line">-&gt; clojure.lang.PersistentHashMap</span><br><span class="line">(<span class="name"><span class="built_in">seq</span></span> &#123; <span class="number">7</span> <span class="number">7</span><span class="punctuation">,</span> <span class="number">1</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">4</span> <span class="number">4</span><span class="punctuation">,</span> <span class="number">6</span> <span class="number">6</span><span class="punctuation">,</span> <span class="number">3</span> <span class="number">3</span><span class="punctuation">,</span> <span class="number">2</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">9</span> <span class="number">9</span><span class="punctuation">,</span> <span class="number">0</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">8</span> <span class="number">8</span><span class="punctuation">,</span> <span class="number">5</span> <span class="number">5</span>&#125;)</span><br><span class="line">-&gt; ([<span class="number">0</span> <span class="number">0</span>] [<span class="number">7</span> <span class="number">7</span>] [<span class="number">1</span> <span class="number">1</span>] [<span class="number">4</span> <span class="number">4</span>] [<span class="number">6</span> <span class="number">6</span>] [<span class="number">3</span> <span class="number">3</span>] [<span class="number">2</span> <span class="number">2</span>] [<span class="number">9</span> <span class="number">9</span>] [<span class="number">8</span> <span class="number">8</span>])</span><br></pre></td></tr></table></figure>
<p>果然，<code>[0 0]</code>出现在序列的首位。至于为什么是这样的顺序，需要深入<em>Clojure</em>的hash算法和数据结构当中，有时间另起一篇博客解释。我们再试试<code>PersistentArrayMap</code>的情况：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">type</span></span> &#123; <span class="number">7</span> <span class="number">7</span><span class="punctuation">,</span> <span class="number">1</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">4</span> <span class="number">4</span><span class="punctuation">,</span> <span class="number">6</span> <span class="number">6</span><span class="punctuation">,</span> <span class="number">3</span> <span class="number">3</span><span class="punctuation">,</span> <span class="number">2</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">9</span> <span class="number">9</span><span class="punctuation">,</span> <span class="number">0</span> <span class="number">0</span>&#125;)</span><br><span class="line">-&gt; clojure.lang.PersistentArrayMap</span><br><span class="line">(<span class="name"><span class="built_in">seq</span></span> &#123; <span class="number">7</span> <span class="number">7</span><span class="punctuation">,</span> <span class="number">1</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">4</span> <span class="number">4</span><span class="punctuation">,</span> <span class="number">6</span> <span class="number">6</span><span class="punctuation">,</span> <span class="number">3</span> <span class="number">3</span><span class="punctuation">,</span> <span class="number">2</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">9</span> <span class="number">9</span><span class="punctuation">,</span> <span class="number">0</span> <span class="number">0</span>&#125;)</span><br><span class="line">-&gt; ([<span class="number">7</span> <span class="number">7</span>] [<span class="number">1</span> <span class="number">1</span>] [<span class="number">4</span> <span class="number">4</span>] [<span class="number">6</span> <span class="number">6</span>] [<span class="number">3</span> <span class="number">3</span>] [<span class="number">2</span> <span class="number">2</span>] [<span class="number">9</span> <span class="number">9</span>] [<span class="number">0</span> <span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<p>顺序确实和原来的一致。</p>
<p>我们的程序当中是不应该假设map是有序的，所以需要修改实现代码。</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">the-earliest-available-recommand</span> [rooms]</span><br><span class="line">  (<span class="name"><span class="built_in">letfn</span></span> [(<span class="name">period</span> [&#123;<span class="symbol">:keys</span> [periods]&#125;]</span><br><span class="line">            (<span class="name"><span class="built_in">-&gt;</span></span> periods</span><br><span class="line">                (<span class="name"><span class="built_in">-&gt;&gt;</span></span> (<span class="name"><span class="built_in">filter</span></span> (<span class="name"><span class="built_in">comp</span></span> #&#123;<span class="symbol">:available</span>&#125; <span class="symbol">:status</span>)))</span><br><span class="line">                (<span class="name"><span class="built_in">first</span></span>)</span><br><span class="line">                (<span class="name"><span class="built_in">find</span></span> <span class="symbol">:time</span>)))</span><br><span class="line">          (<span class="name">room-id</span> [room]</span><br><span class="line">            (<span class="name"><span class="built_in">find</span></span> room <span class="symbol">:room-id</span>))]</span><br><span class="line">    (<span class="name"><span class="built_in">-&gt;</span></span> rooms</span><br><span class="line">        (<span class="name"><span class="built_in">-&gt;&gt;</span></span> (<span class="name"><span class="built_in">map</span></span> (<span class="name"><span class="built_in">comp</span></span> (<span class="name"><span class="built_in">partial</span></span> into &#123;&#125;) (<span class="name"><span class="built_in">juxt</span></span> room-id period)))</span><br><span class="line">             (<span class="name"><span class="built_in">filter</span></span> <span class="symbol">:time</span>)</span><br><span class="line">             (<span class="name"><span class="built_in">sort-by</span></span> <span class="symbol">:time</span>)</span><br><span class="line">             (<span class="name"><span class="built_in">first</span></span>))</span><br><span class="line">        (<span class="name"><span class="built_in">or</span></span> <span class="symbol">:no-available-room</span>))))</span><br></pre></td></tr></table></figure>
<p><code>(find )</code>函数，用于从map中获取包含该键值的entry，如果找不到，返回nil。这样就避免了潜在无序的entries对程序的干扰。另外，<code>(partial into &#123;&#125;)</code>和<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Currying">Currying</a>很像，它通过接收<code>into</code>函数及其首个参数，构造出一个接收后续参数的函数。当然也可以直接使用<code>#(into &#123;&#125; %)</code>这样的形式。</p>
<p>下面是麦姓朋友的另一种解法，和我的解法思路不完全一样，值得学习借鉴。</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">the-earliest-available-recommand</span> [rooms]</span><br><span class="line">  (<span class="name"><span class="built_in">letfn</span></span> [(<span class="name">earliest-available-time</span> [periods]</span><br><span class="line">            (<span class="name"><span class="built_in">-&gt;&gt;</span></span> periods</span><br><span class="line">                 (<span class="name"><span class="built_in">filter</span></span> (<span class="name"><span class="built_in">comp</span></span> #&#123;<span class="symbol">:available</span>&#125; <span class="symbol">:status</span>))</span><br><span class="line">                 (<span class="name"><span class="built_in">map</span></span> <span class="symbol">:time</span>)</span><br><span class="line">                 (<span class="name"><span class="built_in">sort</span></span>)</span><br><span class="line">                 (<span class="name"><span class="built_in">first</span></span>)))]</span><br><span class="line">    (<span class="name">rename-keys</span></span><br><span class="line">     (<span class="name"><span class="built_in">-&gt;&gt;</span></span> rooms</span><br><span class="line">          (<span class="name"><span class="built_in">map</span></span> #(<span class="name"><span class="built_in">update-in</span></span> % [<span class="symbol">:periods</span>] earliest-available-time))</span><br><span class="line">          (<span class="name"><span class="built_in">filter</span></span> <span class="symbol">:periods</span>)</span><br><span class="line">          (<span class="name"><span class="built_in">sort-by</span></span> <span class="symbol">:periods</span>)</span><br><span class="line">          (<span class="name"><span class="built_in">first</span></span>))</span><br><span class="line">     &#123;<span class="symbol">:periods</span> <span class="symbol">:time</span>&#125;)))</span><br></pre></td></tr></table></figure>
<p>真诚欢迎大家继续点评。</p>
<hr>
<p><a target="_blank" rel="noopener" href="https://github.com/qianyan/kata-bathroom/">本文样例</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2016/09/04/Reading-and-Writing-Files/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/09/04/Reading-and-Writing-Files/" class="post-title-link" itemprop="url">Reading and Writing Files</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-09-04 10:10:44" itemprop="dateCreated datePublished" datetime="2016-09-04T10:10:44+08:00">2016-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-07 16:49:21" itemprop="dateModified" datetime="2016-09-07T16:49:21+08:00">2016-09-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Clojure/" itemprop="url" rel="index"><span itemprop="name">Clojure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="读取和写入文件"><a href="#读取和写入文件" class="headerlink" title="读取和写入文件"></a>读取和写入文件</h2><p>数据一般都是存储在纯文本文件当中，存储的形式多种多样。本文，我会介绍如何在Clojure中读取和写入这些数据。</p>
<h3 id="1-打开文件"><a href="#1-打开文件" class="headerlink" title="1. 打开文件"></a>1. 打开文件</h3><p>新建文件<em>hello.txt</em>，放到<em>resources</em>目录，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hello world!</span><br><span class="line">hello lambeta!</span><br><span class="line">hello life!</span><br></pre></td></tr></table></figure>
<p>新建<em>4io.clj</em>，输入程序：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">ns</span></span> the-way-to-clojure.4io</span><br><span class="line">  (<span class="symbol">:require</span> [clojure.java.io <span class="symbol">:as</span> io]</span><br><span class="line">            [clojure.string <span class="symbol">:as</span> str]))</span><br><span class="line"></span><br><span class="line">(<span class="keyword">def</span> <span class="title">data-file</span> (<span class="name">io/resource</span> <span class="string">&quot;hello.txt&quot;</span>))</span><br><span class="line">(<span class="name"><span class="built_in">slurp</span></span> data-file) </span><br></pre></td></tr></table></figure>
<p>运行程序，输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;hello world! \nhello lambeta!\nhello life!\n&quot;</span><br></pre></td></tr></table></figure>
<h4 id="读取所有行"><a href="#读取所有行" class="headerlink" title="读取所有行"></a>读取所有行</h4><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">line-seq</span></span> (<span class="name">io/reader</span> data-file))</span><br><span class="line"><span class="comment">;;=&gt; (&quot;hello world!&quot; &quot;hello lambeta!&quot; &quot;hello life!&quot;)</span></span><br></pre></td></tr></table></figure>
<h4 id="with-open宏"><a href="#with-open宏" class="headerlink" title="with-open宏"></a>with-open宏</h4><p>with-open宏用于自动关闭打开的文件。</p>
<p>1.1 读取一行，如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">  (<span class="name"><span class="built_in">when-let</span></span> [line (<span class="name">.readLine</span> rdr)]</span><br><span class="line">    (<span class="name">println</span> line)))</span><br></pre></td></tr></table></figure>

<p>1.2 读取多行，如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;;; read multiple lines</span></span><br><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">  (<span class="name"><span class="built_in">loop</span></span> [line (<span class="name">.readLine</span> rdr)]</span><br><span class="line">    (<span class="name"><span class="built_in">when</span></span> line</span><br><span class="line">      (<span class="name">println</span> line)</span><br><span class="line">      (<span class="name"><span class="built_in">recur</span></span> (<span class="name">.readLine</span> rdr)))))</span><br></pre></td></tr></table></figure>

<h3 id="2-读取文件的技巧"><a href="#2-读取文件的技巧" class="headerlink" title="2. 读取文件的技巧"></a>2. 读取文件的技巧</h3><p>想想读取文件可能有哪些场景？</p>
<ul>
<li>读取整个文本</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">slurp</span></span> data-file)</span><br></pre></td></tr></table></figure>

<ul>
<li>读取一行</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">  (<span class="name"><span class="built_in">first</span></span> (<span class="name"><span class="built_in">line-seq</span></span> rdr)))</span><br><span class="line"><span class="comment">;; 或者</span></span><br><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">  (<span class="name"><span class="built_in">take</span></span> <span class="number">1</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr)))</span><br><span class="line">-&gt; <span class="string">&quot;hello world!&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>读取前n行</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">  (<span class="name"><span class="built_in">doall</span></span> (<span class="name"><span class="built_in">take</span></span> <span class="number">2</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))))</span><br><span class="line">-&gt; (<span class="string">&quot;hello world!&quot;</span> <span class="string">&quot;hello lambeta!&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这里使用了<code>(doall )</code>方法，如果不用这个方法，在repl中求值的时候会表达式导致抛出<code>Unhandled java.io.IOException  Stream closed</code>异常。究其缘由是<code>(take 2 )</code>返回了一个惰性序列，详细解释参见文末备注。</p>
<ul>
<li>读取前n个字符</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">with-open [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">  (<span class="name"><span class="built_in">loop</span></span> [ch (<span class="name">.read</span> rdr) len <span class="number">20</span>]</span><br><span class="line">    (<span class="name"><span class="built_in">when-not</span></span> (<span class="name"><span class="built_in">or</span></span> (<span class="name"><span class="built_in">=</span></span> <span class="number">-1</span> ch) (<span class="name"><span class="built_in">zero?</span></span> len))</span><br><span class="line">      (<span class="name">println</span> (<span class="name">char</span> ch))</span><br><span class="line">      (<span class="name"><span class="built_in">recur</span></span> (<span class="name">.read</span> rdr) (<span class="name"><span class="built_in">dec</span></span> len)))))</span><br><span class="line">| h</span><br><span class="line">| e</span><br><span class="line">| ...</span><br><span class="line">-&gt; <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<ul>
<li>跳过特定的行</li>
</ul>
<p>在<em>resources</em>目录下，新建<em>records.txt</em>，内容即代码注释所示：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">read-records</span> [input-file]</span><br><span class="line">  <span class="string">&quot;Coloured fox fur production, HOPEDALE, Labrador, 1834-1842</span></span><br><span class="line"><span class="string">  #Source: C. Elton (1942) \&quot;Voles, Mice and Lemmings\&quot;, Oxford Univ. Press</span></span><br><span class="line"><span class="string">  #Table 17, p.265--266</span></span><br><span class="line"><span class="string">  22</span></span><br><span class="line"><span class="string">  29</span></span><br><span class="line"><span class="string">  2</span></span><br><span class="line"><span class="string">  16</span></span><br><span class="line"><span class="string">  12</span></span><br><span class="line"><span class="string">  35</span></span><br><span class="line"><span class="string">  8</span></span><br><span class="line"><span class="string">  83</span></span><br><span class="line"><span class="string">  166&quot;</span></span><br><span class="line">  (<span class="name"><span class="built_in">letfn</span></span> [(<span class="name">skip</span> [lines]</span><br><span class="line">            (<span class="name"><span class="built_in">next</span></span> lines))]</span><br><span class="line">         (<span class="name"><span class="built_in">with-open</span></span> [rdr ((<span class="name"><span class="built_in">comp</span></span> io/reader io/resource) input-file)]</span><br><span class="line">           (<span class="name"><span class="built_in">-&gt;&gt;</span></span></span><br><span class="line">            (<span class="name"><span class="built_in">for</span></span> [line (<span class="name">skip</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))</span><br><span class="line">                  <span class="symbol">:when</span> (<span class="name"><span class="built_in">not</span></span> (<span class="name">.startsWith</span> line <span class="string">&quot;#&quot;</span>))]</span><br><span class="line">              (<span class="name">read-string</span> line))</span><br><span class="line">            (<span class="name"><span class="built_in">apply</span></span> +)))))</span><br><span class="line"></span><br><span class="line">(<span class="name">read-records</span> <span class="string">&quot;records.txt&quot;</span>)</span><br><span class="line">-&gt; <span class="number">373</span></span><br></pre></td></tr></table></figure>

<p>我们在<code>read-records</code>内部新建一个<code>skip</code>方法，顾名思义，跳过第一个元素，然后返回后面的列表。这里旨在跳过文本的声明头。<code>:when (not ...)</code>过滤了文本的注释部分（以#开头的行），并使用<code>read-string</code>转换字符串到数字类型，<code>(for )</code>求值完成后返回只包含数字的列表。最后，我们对列表做了一次累加操作。</p>
<p>我们试试非过滤而是跳过（删除）以”#”开头行的方式获取数字列表，这样更符合要求。重写<em>with-open</em>部分，如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr ((<span class="name"><span class="built_in">comp</span></span> io/reader io/resource) input-file)]</span><br><span class="line">      (<span class="name"><span class="built_in">apply</span></span> +</span><br><span class="line">             (<span class="name"><span class="built_in">let</span></span> [lines (<span class="name">skip</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))]</span><br><span class="line">               (<span class="name"><span class="built_in">-&gt;&gt;</span></span> lines</span><br><span class="line">                    (<span class="name"><span class="built_in">remove</span></span> (<span class="name">set</span> (<span class="name"><span class="built_in">for</span></span> [line lines <span class="symbol">:while</span> (<span class="name">.startsWith</span> line <span class="string">&quot;#&quot;</span>)] line)))</span><br><span class="line">                    (<span class="name"><span class="built_in">map</span></span> read-string)))))</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr ((<span class="name"><span class="built_in">comp</span></span> io/reader io/resource) input-file)]</span><br><span class="line">      (<span class="name"><span class="built_in">apply</span></span> +</span><br><span class="line">             (<span class="name"><span class="built_in">let</span></span> [lines (<span class="name">skip</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))]</span><br><span class="line">               (<span class="name"><span class="built_in">-&gt;&gt;</span></span> lines</span><br><span class="line">                    (<span class="name"><span class="built_in">drop</span></span> (<span class="name"><span class="built_in">count</span></span> (<span class="name"><span class="built_in">for</span></span> [line lines <span class="symbol">:while</span> (<span class="name">.startsWith</span> line <span class="string">&quot;#&quot;</span>)] line)))</span><br><span class="line">                    (<span class="name"><span class="built_in">map</span></span> read-string)))))</span><br></pre></td></tr></table></figure>
<h3 id="3-读取网络文件"><a href="#3-读取网络文件" class="headerlink" title="3. 读取网络文件"></a>3. 读取网络文件</h3><p>通过slurp读取字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(slurp &quot;http://robjhyndman.com/tsdldata/ecology1/hopedale.dat&quot; :encoding &quot;utf-8&quot;)</span><br><span class="line"></span><br><span class="line">-&gt; &quot;Coloured fox fur production, HOPEDALE, Labrador,, 1834-1925\n#Source: C. Elton (1942) \&quot;Voles, Mice and Lemmings\&quot;, Oxford Univ. Press\n#Table 17, p.265--266\n      22   \n...</span><br></pre></td></tr></table></figure>
<p>注意，这个网页上的数据是用UTF-8编码的，所以解码读取时，也应该使用UTF-8。</p>
<h3 id="4-写入文件"><a href="#4-写入文件" class="headerlink" title="4. 写入文件"></a>4. 写入文件</h3><ul>
<li>使用spit方法</li>
</ul>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">spit</span> <span class="string">&quot;world.txt&quot;</span> <span class="string">&quot;Hello, lambeta!&quot;</span> <span class="symbol">:append</span> <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<p>运行程序之后，项目的根目录下会生成<em>world.txt</em>文件，内容是<em>Hello, lambeta</em>。spit方法其实就是向Java的BufferedWriter中写入内容。</p>
<ul>
<li>使用clojure.java.io&#x2F;writer</li>
</ul>
<p>我们在项目的根目录新建<em>numbers.txt</em>，内容是多行的数字对，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.3 2.7</span><br><span class="line">10000 1</span><br><span class="line">-1 1</span><br></pre></td></tr></table></figure>

<p>我们需要把每行两个数字，和它们相加的结果写入到<em>sum-of_numbers.txt</em>文件中。也就是注释中的描述。</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">sum-number-pairs</span> [input-file output-file]</span><br><span class="line">  <span class="string">&quot;Read the data from input-file, which contains two floats per line</span></span><br><span class="line"><span class="string">   separated by a space.  Open file named output-file and, for each line in</span></span><br><span class="line"><span class="string">   input-file, write a line to the output file that contains the two floats</span></span><br><span class="line"><span class="string">   from the corresponding line of input-file plus a space and the sum of the</span></span><br><span class="line"><span class="string">   two floats.&quot;</span></span><br><span class="line">(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> input-file) wtr (<span class="name">io/writer</span> output-file <span class="symbol">:append</span> <span class="literal">true</span>)]</span><br><span class="line">    (<span class="name"><span class="built_in">loop</span></span> [line (<span class="name">.readLine</span> rdr)]</span><br><span class="line">      (<span class="name"><span class="built_in">when</span></span> line</span><br><span class="line">        (<span class="name"><span class="built_in">let</span></span> [pair (<span class="name"><span class="built_in">map</span></span> read-string</span><br><span class="line">                        (<span class="name">str/split</span> line <span class="regex">#&quot;\s&quot;</span>))</span><br><span class="line">              first (<span class="name"><span class="built_in">first</span></span> pair)</span><br><span class="line">              second (<span class="name"><span class="built_in">second</span></span> pair)</span><br><span class="line">              sum (<span class="name"><span class="built_in">+</span></span> first second)]</span><br><span class="line">          (<span class="name">.write</span> wtr (<span class="name"><span class="built_in">str</span></span> first <span class="string">&quot; &quot;</span> second <span class="string">&quot; &quot;</span> sum <span class="string">&quot;\n&quot;</span>)))</span><br><span class="line">        (<span class="name"><span class="built_in">recur</span></span> (<span class="name">.readLine</span> rdr))))))</span><br><span class="line"></span><br><span class="line">(<span class="name">sum-number-pairs</span> <span class="string">&quot;numbers.txt&quot;</span> <span class="string">&quot;sum-of-numbers.txt&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>with-open同时打开了一个用于读取、名为<em>input-file</em>的文件以及一个用于写入、名为<em>output-file</em>的文件，写入方式是追加<code>:append true</code>。随后循环读取<em>input-file</em>中的每行内容。若<em>line</em>不是nil（即存在），那么用空格分隔这行内容，得到一个数组，如：”1.3 2.7” -&gt; [“1.3” “2.7”]。此时数组的元素类型还不是数字（Number），我们使用<code>(map read-string )</code>将元素转换为对应的数字类型，如：[“1.3” “2.7”] -&gt; [1.3 2.7]。之后，分别提取数组的第一、二个元素以及两者的和。最后，写入到wtr中。</p>
<hr>
<p><strong>注意</strong>：程序中的<em>str&#x2F;split</em>是通过<code>(:require [clojure.string :as str])</code>方式引入<em>str</em>命名空间的。</p>
<hr>
<p>运行程序之后，<em>sum-of-numbers.txt</em>中的内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.3 2.7 4.0</span><br><span class="line">10000 1 10001</span><br><span class="line">-1 1 0</span><br></pre></td></tr></table></figure>

<h3 id="5-多行记录"><a href="#5-多行记录" class="headerlink" title="5. 多行记录"></a>5. 多行记录</h3><h4 id="5-1-有结束标识"><a href="#5-1-有结束标识" class="headerlink" title="5.1 有结束标识"></a>5.1 有结束标识</h4><p>有时候，记录并不是以一行一行的方式存储在文件当中的，而是以多行数据描述一条记录。比如下面的蛋白质数据：<br><strong>清单 5.1</strong> <em>multimol.pdb</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">COMPND      AMMONIA</span><br><span class="line">ATOM      1  N  0.257  -0.363   0.000</span><br><span class="line">ATOM      2  H  0.257   0.727   0.000</span><br><span class="line">ATOM      3  H  0.771  -0.727   0.890</span><br><span class="line">ATOM      4  H  0.771  -0.727  -0.890</span><br><span class="line">END</span><br><span class="line">COMPND      METHANOL</span><br><span class="line">ATOM      1  C  -0.748  -0.015   0.024</span><br><span class="line">ATOM      2  O  0.558   0.420  -0.278</span><br><span class="line">ATOM      3  H  -1.293  -0.202  -0.901</span><br><span class="line">ATOM      4  H  -1.263   0.754   0.600</span><br><span class="line">ATOM      5  H  -0.699  -0.934   0.609</span><br><span class="line">ATOM      6  H  0.716   1.404   0.137</span><br><span class="line">END</span><br></pre></td></tr></table></figure>
<p>第一行描述的是分子的名字，接下来到END为止的每行代表原子的ID、类型以及在分子中分布的[x y z]坐标。<br>我们需要一个函数，将数据读取出来并且以规定的格式输出，格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">((&quot;AMMONIA&quot; </span><br><span class="line">    (&quot;N&quot; &quot;0.257&quot; &quot;-0.363&quot; &quot;0.000&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;0.257&quot; &quot;0.727&quot; &quot;0.000&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;0.771&quot; &quot;-0.727&quot; &quot;0.890&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;0.771&quot; &quot;-0.727&quot; &quot;-0.890&quot;)) </span><br><span class="line"> (&quot;METHANOL&quot; </span><br><span class="line">    (&quot;C&quot; &quot;-0.748&quot; &quot;-0.015&quot; &quot;0.024&quot;)</span><br><span class="line">    (&quot;O&quot; &quot;0.558&quot; &quot;0.420&quot; &quot;-0.278&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;-1.293&quot; &quot;-0.202&quot; &quot;-0.901&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;-1.263&quot; &quot;0.754&quot; &quot;0.600&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;-0.699&quot; &quot;-0.934&quot; &quot;0.609&quot;)</span><br><span class="line">    (&quot;H&quot; &quot;0.716&quot; &quot;1.404&quot; &quot;0.137&quot;)))</span><br></pre></td></tr></table></figure>
<p>也就是说，我们需要把每条记录读入单个列表中，每个列表由分子的名称和多个<code>(Type X Y Z)</code>的原子列表组成。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(defn read-all-molecules [input-file]</span><br><span class="line">  (map (fn [molecules]</span><br><span class="line">         (let [[_ name] (str/split (first molecules) #&quot;\s+&quot;)</span><br><span class="line">               atoms (map (comp #(drop 2 %) #(str/split % #&quot;\s+&quot;))</span><br><span class="line">                          (rest molecules))]</span><br><span class="line">           (concat [name] atoms)))</span><br><span class="line">       ;; 分割成多条记录</span><br><span class="line">       (remove #(= % [&quot;END&quot;]) </span><br><span class="line">               (partition-by #(= % &quot;END&quot;) (line-seq (io/reader input-file))))))</span><br><span class="line"></span><br><span class="line">(read-all-molecules &quot;multimol.pdb&quot;)</span><br></pre></td></tr></table></figure>
<p><code>(remove #(= % [&quot;END&quot;]) (partition-by #(= % &quot;END&quot;) (line-seq (io/reader input-file))))</code>这行代码做的事情就是把文件读取出来变成一个<code>lazy-seq</code>，然后使用<code>parttition-by</code>以<em>END</em>进行分组，最后使用<code>remove</code>方法剔除掉*[“END”]*这样的分组，得到如下中间结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">((&quot;COMPND      AMMONIA&quot; </span><br><span class="line">  &quot;ATOM      1  N  0.257  -0.363   0.000&quot;</span><br><span class="line">  &quot;ATOM      2  H  0.257   0.727   0.000&quot;</span><br><span class="line">  &quot;ATOM      3  H  0.771  -0.727   0.890&quot;</span><br><span class="line">  &quot;ATOM      4  H  0.771  -0.727  -0.890&quot;) </span><br><span class="line"> (&quot;COMPND      METHANOL&quot; </span><br><span class="line">  &quot;ATOM      1  C  -0.748  -0.015   0.024&quot;</span><br><span class="line">  &quot;ATOM      2  O  0.558   0.420  -0.278&quot;</span><br><span class="line">  &quot;ATOM      3  H  -1.293  -0.202  -0.901&quot; </span><br><span class="line">  &quot;ATOM      4  H  -1.263   0.754   0.600&quot;</span><br><span class="line">  &quot;ATOM      5  H  -0.699  -0.934   0.609&quot; </span><br><span class="line">  &quot;ATOM      6  H  0.716   1.404   0.137&quot;))</span><br></pre></td></tr></table></figure>
<p>这样离我们的目标已经很近了。观察上述结果，不难发现分子的名称处于列表的第一个<code>(first )</code>，而原子列表可以使用<code>(rest )</code>获取。然后，借助<code>(map )</code>函数遍历所有的记录。</p>
<p><code>(let )</code>中的第一个binding是<code>[_ name] (str/split (first molecules) #&quot;\s+&quot;)</code>，首先用<code>(split )</code>函数分割，再使用了解构提取出分子的名称；第二个binding是原子列表的提取，我们在<code>(split )</code>的基础之上，使用<code>(drop 2 )</code>函数剔除了不用的字段，如：ATOM和1。最后使用<code>(concat )</code>函数将名称和原子列表的列表拼接到一起。</p>
<h4 id="5-2-无结束标识"><a href="#5-2-无结束标识" class="headerlink" title="5.2 无结束标识"></a>5.2 无结束标识</h4><p>5.1中的记录项通过<em>END</em>标识分隔，但是事实上这是一个多余的字段，记录项可以更简练，如下：<br><strong>清单 5.2</strong> <em>multimol-without-end-marker.pdb</em></p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">COMPND      AMMONIA</span><br><span class="line">ATOM      <span class="number">1</span>  N  <span class="number">0.257</span>  <span class="number">-0.363</span>   <span class="number">0.000</span></span><br><span class="line">ATOM      <span class="number">2</span>  H  <span class="number">0.257</span>   <span class="number">0.727</span>   <span class="number">0.000</span></span><br><span class="line">ATOM      <span class="number">3</span>  H  <span class="number">0.771</span>  <span class="number">-0.727</span>   <span class="number">0.890</span></span><br><span class="line">ATOM      <span class="number">4</span>  H  <span class="number">0.771</span>  <span class="number">-0.727</span>  <span class="number">-0.890</span></span><br><span class="line">COMPND      METHANOL</span><br><span class="line">ATOM      <span class="number">1</span>  C  <span class="number">-0.748</span>  <span class="number">-0.015</span>   <span class="number">0.024</span></span><br><span class="line">ATOM      <span class="number">2</span>  O  <span class="number">0.558</span>   <span class="number">0.420</span>  <span class="number">-0.278</span></span><br><span class="line">ATOM      <span class="number">3</span>  H  <span class="number">-1.293</span>  <span class="number">-0.202</span>  <span class="number">-0.901</span></span><br><span class="line">ATOM      <span class="number">4</span>  H  <span class="number">-1.263</span>   <span class="number">0.754</span>   <span class="number">0.600</span></span><br><span class="line">ATOM      <span class="number">5</span>  H  <span class="number">-0.699</span>  <span class="number">-0.934</span>   <span class="number">0.609</span></span><br><span class="line">ATOM      <span class="number">6</span>  H  <span class="number">0.716</span>   <span class="number">1.404</span>   <span class="number">0.137</span></span><br></pre></td></tr></table></figure>
<p>现在的问题变成了没有<em>END</em>标识符，如何进行分组？观察不难发现以<em>COMPND</em>开头的数据行可以作为记录的分隔符。<br>使用<code>(partition-by #(.startsWith % &quot;COMPND&quot;) (line-seq (io/reader input-file)))</code>进行分组，得到的结果如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">((<span class="string">&quot;COMPND      AMMONIA&quot;</span>) </span><br><span class="line">  (<span class="string">&quot;ATOM      1  N  0.257  -0.363   0.000&quot;</span> </span><br><span class="line">   <span class="string">&quot;ATOM      2  H  0.257   0.727   0.000&quot;</span> </span><br><span class="line">   <span class="string">&quot;ATOM      3  H  0.771  -0.727   0.890&quot;</span></span><br><span class="line">   <span class="string">&quot;ATOM      4  H  0.771  -0.727  -0.890&quot;</span>) </span><br><span class="line"> (<span class="string">&quot;COMPND      METHANOL&quot;</span>) </span><br><span class="line">  (<span class="string">&quot;ATOM      1  C  -0.748  -0.015   0.024&quot;</span> </span><br><span class="line">   <span class="string">&quot;ATOM      2  O  0.558   0.420  -0.278&quot;</span> </span><br><span class="line">   <span class="string">&quot;ATOM      3  H  -1.293  -0.202  -0.901&quot;</span></span><br><span class="line">   <span class="string">&quot;ATOM      4  H  -1.263   0.754   0.600&quot;</span></span><br><span class="line">   <span class="string">&quot;ATOM      5  H  -0.699  -0.934   0.609&quot;</span></span><br><span class="line">   <span class="string">&quot;ATOM      6  H  0.716   1.404   0.137&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>此时，我们对比5.1中中间结果，会发现它们极为相似。也就是说，我们稍加转换就能让两者一致，而一致的好处就是可以复用原来<code>(map )</code>中的逻辑。</p>
<p>稍稍修改原来的分组逻辑，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(map (fn [[name atoms]] (concat name atoms))</span><br><span class="line">       (partition 2</span><br><span class="line">                  (partition-by</span><br><span class="line">                   #(.startsWith % &quot;COMPND&quot;)</span><br><span class="line">                   (line-seq (io/reader input-file)))))</span><br></pre></td></tr></table></figure>
<p>我们先使用<code>(partition 2 )</code>将第一步得到的列表每隔两个元素划为一组，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(((&quot;COMPND      AMMONIA&quot;) </span><br><span class="line">  (&quot;ATOM      1  N  0.257  -0.363   0.000&quot; </span><br><span class="line">   &quot;ATOM      2  H  0.257   0.727   0.000&quot; </span><br><span class="line">   &quot;ATOM      3  H  0.771  -0.727   0.890&quot;</span><br><span class="line">   &quot;ATOM      4  H  0.771  -0.727  -0.890&quot;)) ; 多出一对括号</span><br><span class="line"> ((&quot;COMPND      METHANOL&quot;) </span><br><span class="line">  (&quot;ATOM      1  C  -0.748  -0.015   0.024&quot; </span><br><span class="line">   &quot;ATOM      2  O  0.558   0.420  -0.278&quot; </span><br><span class="line">   &quot;ATOM      3  H  -1.293  -0.202  -0.901&quot;</span><br><span class="line">   &quot;ATOM      4  H  -1.263   0.754   0.600&quot;</span><br><span class="line">   &quot;ATOM      5  H  -0.699  -0.934   0.609&quot;</span><br><span class="line">   &quot;ATOM      6  H  0.716   1.404   0.137&quot;)))</span><br></pre></td></tr></table></figure>
<p>然后使用<code>(map (fn [[name atoms]] ...)</code>将每组里面的两个列表合成为一个列表，这样就得到和原来5.1一模一样的中间结果。</p>
<p>接下来，我们把转换的逻辑从<code>(read-all-molecules )</code>中提取出来，以便复用。改造如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">read-all-molecules</span> [f input-file]</span><br><span class="line">  (<span class="name"><span class="built_in">let</span></span> [data (<span class="name">f</span> input-file)]</span><br><span class="line">    (<span class="name"><span class="built_in">map</span></span> (<span class="name"><span class="built_in">fn</span></span> [molecules]</span><br><span class="line">           (<span class="name"><span class="built_in">let</span></span> [[_ name] (<span class="name">str/split</span> (<span class="name"><span class="built_in">first</span></span> molecules) <span class="regex">#&quot;\s+&quot;</span>)</span><br><span class="line">                 atoms (<span class="name"><span class="built_in">map</span></span> (<span class="name"><span class="built_in">comp</span></span> #(<span class="name"><span class="built_in">drop</span></span> <span class="number">2</span> %) #(<span class="name">str/split</span> % <span class="regex">#&quot;\s+&quot;</span>))</span><br><span class="line">                            (<span class="name"><span class="built_in">rest</span></span> molecules))]</span><br><span class="line">             (<span class="name"><span class="built_in">concat</span></span> [name] atoms))) data)))</span><br></pre></td></tr></table></figure>
<p>定义转换逻辑，如下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">file-without-markers-&gt;multi-records</span> [input-file]</span><br><span class="line">  (<span class="name"><span class="built_in">map</span></span> (<span class="name"><span class="built_in">fn</span></span> [[name atoms]] (<span class="name"><span class="built_in">concat</span></span> name atoms))</span><br><span class="line">       (<span class="name"><span class="built_in">partition</span></span> <span class="number">2</span></span><br><span class="line">                  (<span class="name">partition-by</span></span><br><span class="line">                   #(<span class="name">.startsWith</span> % <span class="string">&quot;COMPND&quot;</span>)</span><br><span class="line">                   (<span class="name"><span class="built_in">line-seq</span></span> (<span class="name">io/reader</span> input-file))))))</span><br></pre></td></tr></table></figure>
<p>最后，我们来调用的改造之后的方法：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">read-all-molecules</span> </span><br><span class="line">        file-without-markers-&gt;multi-records <span class="string">&quot;multimol-without-end-marker.pdb&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>此时，5.1中的转换逻辑也可以提取出一个函数：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">defn</span> <span class="title">file-&gt;multi-records</span></span><br><span class="line">  (<span class="name"><span class="built_in">remove</span></span> #(<span class="name"><span class="built_in">=</span></span> % [<span class="string">&quot;END&quot;</span>]) </span><br><span class="line">               (<span class="name">partition-by</span> #(<span class="name"><span class="built_in">=</span></span> % <span class="string">&quot;END&quot;</span>) (<span class="name"><span class="built_in">line-seq</span></span> (<span class="name">io/reader</span> input-file)))))</span><br></pre></td></tr></table></figure>
<p>原来的程序就重构成了如下的模样：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">read-all-molecules</span> file-&gt;multi-records <span class="string">&quot;multimol.pdb&quot;</span>)</span><br></pre></td></tr></table></figure>


<hr>
<p><strong>备注</strong></p>
<p>为了清楚定位这个问题，我们需要提前了解两个知识点</p>
<ol>
<li>什么是惰性序列？</li>
<li>惰性序列在repl中什么时候变现（realizes）？</li>
</ol>
<p>惰性序列是用<code>(lazy-seq [&amp; body] )</code>宏创建出来的。<code>lazy-seq</code>仅在需要的时候才会去调用它的body。<br>当repl尝试<code>pretty-print</code>惰性序列的结果时，才会进行变现操作。</p>
<p>有了上面的知识点，我们来考察<code>with-open</code>和<code>(take 2 (line-seq ))</code>的关系。<code>with-open</code>是宏，我们使用<code>clojure.walk/macroexpand-all</code>展开下：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">clojure.walk/macroexpand-all</span> </span><br><span class="line">    &#x27;(<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> data-file)]</span><br><span class="line">                      (<span class="name"><span class="built_in">take</span></span> <span class="number">2</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))))</span><br><span class="line">                      </span><br><span class="line">-&gt; (<span class="name">let*</span> [rdr (<span class="name">io/reader</span> data-file)] </span><br><span class="line">        (<span class="name"><span class="built_in">try</span></span> (<span class="name"><span class="built_in">do</span></span> </span><br><span class="line">                (<span class="name"><span class="built_in">take</span></span> <span class="number">2</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))) </span><br><span class="line">        (<span class="name">finally</span> (<span class="name"><span class="built_in">.</span></span> rdr clojure.core/close))))                      </span><br></pre></td></tr></table></figure>
<p>使用<code>(doc line-seq)</code>查看文档，得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">clojure.core/line-seq</span><br><span class="line"> [rdr]</span><br><span class="line">Added in 1.0</span><br><span class="line">  Returns the lines of text from rdr as a lazy sequence of strings.</span><br><span class="line">  rdr must implement java.io.BufferedReader.</span><br></pre></td></tr></table></figure>
<p>可以确认<code>line-seq</code>返回一个惰性的字符串序列。<br>再看看<code>(doc take)</code>的文档，得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">clojure.core/take</span><br><span class="line"> [n]</span><br><span class="line"> [n coll]</span><br><span class="line">Added in 1.0</span><br><span class="line">  Returns a lazy sequence of the first n items in coll, or all items if</span><br><span class="line">  there are fewer than n.  Returns a stateful transducer when</span><br><span class="line">  no collection is provided.</span><br></pre></td></tr></table></figure>
<p>所以<code>take</code>返回的也是一个惰性序列，那么<code>(do (take 2 (line-seq rdr)))</code>（等价于<code>(take 2 (line-seq rdr))</code>）整个返回的就是一个惰性序列。</p>
<p>当我们通过repl求值<code>with-open</code>时，它并没有真的变现<code>(take 2 (line-seq rdr))</code>，而是在运行完<code>try...finally</code>之后，直接返回这个惰性序列作为结果。此时，repl开始尝试pretty-print <code>(take 2 (line-seq rdr))</code>，变现发生，但是rdr已经被关闭了，所以抛出<em>Stream closed</em>异常。</p>
<p>到这里，解决了一大半问题，但是还有一个逻辑上解释不过去的点，就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(with-open [rdr (io/reader data-file)]</span><br><span class="line">  (take 1 (line-seq rdr)))</span><br></pre></td></tr></table></figure>
<p>当我们尝试<code>(take 1 )</code>时并不会抛出异常！也就是说<code>(take 1 )</code>和<code>(take 2 )</code>的行为不同，但是<code>(take )</code>明明都是返回惰性序列啊？</p>
<p>带着这个疑惑，看看<code>line-seq</code>的源代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(when-let [line (.readLine rdr)]</span><br><span class="line">    (cons line (lazy-seq (line-seq rdr)))))</span><br></pre></td></tr></table></figure>
<p>是不是有种豁然开朗的感觉？没有也没关系，我来解释一下。<br><code>line-seq</code>的<code>when-let</code>语句并没有包在<code>(lazy-seq )</code>（这点可以和<code>take</code>的源码比较）中，这说明<code>[line (.readline rdr)]</code>是需要立即求值的。也就是说，我们在求值<code>with-open</code>时，rdr中第一行的内容会被<code>(line-seq )</code>给抓住了。那么当<code>try...finally</code>运行结束之后，pretty-print变现惰性序列时，发现第一行根本不需要从rdr中读，当然就不会抛出异常了。</p>
<p>明确这几点之后，我们看看<code>(doall )</code>为何能解决惰性序列延迟求值的问题？<code>(doall )</code>其实强制变现了整个惰性序列（不断调用序列的<code>next</code>方法），所以并不会等到<code>with-open</code>求值完成之后才求值。</p>
<p>换个角度，我们知道之所以抛出异常，是因为repl对返回的惰性序列求值了。那么如果我们不在repl中求值，程序还会抛出异常吗？</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="built_in">ns</span></span> the-way-to-clojure.core</span><br><span class="line">  (<span class="symbol">:require</span> [clojure.java.io <span class="symbol">:as</span> io])</span><br><span class="line">  (<span class="symbol">:gen-class</span>))</span><br><span class="line"></span><br><span class="line">(<span class="keyword">defn</span> <span class="title">-main</span> [&amp; args]</span><br><span class="line">  (<span class="name"><span class="built_in">with-open</span></span> [rdr (<span class="name">io/reader</span> <span class="string">&quot;hello.txt&quot;</span>)]</span><br><span class="line">    (<span class="name"><span class="built_in">take</span></span> <span class="number">100</span> (<span class="name"><span class="built_in">line-seq</span></span> rdr))))</span><br></pre></td></tr></table></figure>
<p>接着，我们使用<code>lein run</code>来运行<code>main</code>方法。程序运行良好，因为根本没有人用到返回的惰性序列。</p>
<p>如果我们加一句打印语句如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(defn -main [&amp; args]</span><br><span class="line">  (println          ; 变现</span><br><span class="line">      (with-open [rdr (io/reader &quot;hello.txt&quot;)]</span><br><span class="line">        (take 100 (line-seq rdr)))))</span><br></pre></td></tr></table></figure>
<p>再用<code>lein run</code>跑一个<code>main</code>方法，异常又不期而遇了。因为此处的<code>println</code>等价于<code>repl</code>的<code>pretty print</code>。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2016/06/24/SonarQube-Plugin-Step-by-Step/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/06/24/SonarQube-Plugin-Step-by-Step/" class="post-title-link" itemprop="url">SonarQube Plugin Step by Step</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-06-24 00:40:23" itemprop="dateCreated datePublished" datetime="2016-06-24T00:40:23+08:00">2016-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:59:18" itemprop="dateModified" datetime="2016-09-06T22:59:18+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="插件不好写？！"><a href="#插件不好写？！" class="headerlink" title="插件不好写？！"></a>插件不好写？！</h2><p>插件确实不好写，因为插件是插入庞大的系统当中工作的，那也就意味着写插件需要具备一定的领域知识，包括系统架构、扩展点、业务共性及差异、API及其业务模型对应、安装和测试。而对于开发者而言，学习这些知识的代价绝对是昂贵的。<br>在《函数式编程思想》一书中，作者Neal Ford提到开发过程当中的两种抽象方式——composable and contextual abstract. 谈及contextual抽象的时候，他把插件系统列为这一抽象中最经典的例子。</p>
<blockquote>
<p>Plugin-based architectures are excellent examples of the contextual abstraction. The plug-in API provides a plethora of data structures and other useful context that developers inherit from or summon via already existing methods. But to use the API, a developer must understand what that context provides, and that understanding is sometimes expensive. </p>
</blockquote>
<p>大意是开发者能够借助已存在的方法来使用Plugin API中提供的大量数据结构和有用的上下文信息。但是，理解起这些上下文信息有时是很昂贵的。</p>
<p>基于一个共识：开发者的时间都是宝贵的。知道插件难写之后，我的这篇文章才有价值。</p>
<h2 id="理解领域模型"><a href="#理解领域模型" class="headerlink" title="理解领域模型"></a>理解领域模型</h2><p>一说写插件，估计大家都会上官网寻找开发指南或者google大量博客来快速完成开发任务。这里不是说这种方式不好，其实一开始我也是这么做的，但是着手开发以后，很快就遭遇处处掣肘。比如：开发sonar plugin，会用到<em>Profile、Rule、Language</em>和<em>Repository</em>等概念。单从代码层面上看，我们很难理清这些概念所代表的模型和它们之间的<strong>关系</strong>。所以需要从用户的视角来<strong>感受</strong>这些领域知识。</p>
<p>而用户视角大部分情况下就是UI界面。</p>
<h3 id="规则（Rules）"><a href="#规则（Rules）" class="headerlink" title="规则（Rules）"></a>规则（Rules）</h3><p>我们先看看<em>Rules</em>导航栏，左边的单选框是这些规则的过滤条件。<br>说明规则包含或者被包含这些属性之下：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/217988-a6ad47ad581e7fc4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Rules"></p>
<ul>
<li>Language：规则对应的某种编程语言。</li>
<li>Type：规则的类型，比如：缺陷（Bug）、代码坏味道（Code Smell）、易受攻击（Vulnerability）。</li>
<li>Tag：规则设置的标签，易于检索。</li>
<li>Repository：承载特定语言下各种规则的容器；通过它可以通过规则的键值（ruleKey）检索。</li>
<li>Default Severity：触犯规则的严重程度。<ul>
<li>Blocker：最高等级，阻碍的</li>
<li>Critical：高等级，极为严重的</li>
<li>Major：较高等级，主要的；默认级别。</li>
<li>Minor：较低等级</li>
<li>Info：低等级</li>
</ul>
</li>
<li>Status：规则现在的状态，可用、废弃还是实验版（Beta）。</li>
<li>Avaiable Since：什么时候开始可用。</li>
<li>Template：规则模板：比如某些参数可以运行时传入。</li>
<li>Quality Profile：挑选特定语言下各种规则组成的配置；其中可以启用或禁用一部分规则。</li>
</ul>
<h3 id="质量Profile（Quality-Profile）"><a href="#质量Profile（Quality-Profile）" class="headerlink" title="质量Profile（Quality Profile）"></a>质量Profile（Quality Profile）</h3><p>再看看<em>Quality Profiles</em>导航栏，左侧栏显示的是某种语言包含的所有Profiles.</p>
<p><img src="http://upload-images.jianshu.io/upload_images/217988-7b8bbbf54b9462dd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Profiles"></p>
<p>从关系型数据库的角度，Language和Profile是1对多（one-to-many）关系，但是从领域建模的角度，Profile其实和Language是1对1的关系。所以可以是Profile包含Language属性。利用领域建模的思考方式，可以联想到Repository和Rules是1对多的关系，所以Repository包含一个Rules的集合。Repository和Language是1对1的关系，Repository包含Language属性。那么Rules和Profiles的对应关系呢？多对多。但是我们更关心Profile到Rules这一层的关系，所以选择Profile包含一个Rules的集合。</p>
<p>我整理出这样一份对应关系图：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">profile</span><br><span class="line">    - language</span><br><span class="line">    - [rules]</span><br><span class="line">respository</span><br><span class="line">    - lanuage</span><br><span class="line">    - [rules]</span><br></pre></td></tr></table></figure>
<p>现在，缺少Profile和Repository的关系。不过既然有了Rule这一层联系，那么就可以这样考虑，Rule和Repository是1对1的关系（为什么呢？因为每个Rule显然只能存在于一个特定的Repository当中）。所以原图可以修改为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">profile</span><br><span class="line">    - language</span><br><span class="line">    - [rules]</span><br><span class="line">      - rule</span><br><span class="line">        - respository</span><br><span class="line">respository</span><br><span class="line">    - language</span><br><span class="line">    - [rules]</span><br></pre></td></tr></table></figure>
<p>好了。梳理完这些领域知识，我们可以开始依照官方的教程<a target="_blank" rel="noopener" href="http://docs.sonarqube.org/display/DEV/Developing+a+Plugin">Developing a Plugin</a>.</p>
<h2 id="扫描特定领域语言（DSL）的SonarQube插件"><a href="#扫描特定领域语言（DSL）的SonarQube插件" class="headerlink" title="扫描特定领域语言（DSL）的SonarQube插件"></a>扫描特定领域语言（DSL）的SonarQube插件</h2><p>SonarQube 5.6现在只支持Java 8、Maven 3.1以上。当然也支持Gradle。</p>
<h3 id="第一步-创建一个Maven工程"><a href="#第一步-创建一个Maven工程" class="headerlink" title="第一步 创建一个Maven工程"></a>第一步 创建一个Maven工程</h3><p>这里有两种方式。第一种方式就是从头开始写起，包括创建工程；另一种就是拷贝官方的<a target="_blank" rel="noopener" href="https://github.com/SonarSource/sonar-examples">样例程序</a>。我自然是推荐第二种做法，不过这里我从零开始开发。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mvn archetype:create -DgroupId=com.lambeta -DartifactId=sonar-lambeta -DarchetypeArtifactId=maven-archetype-quickstart</span></span><br></pre></td></tr></table></figure>
<p>依照官方文档将pom.xml修改如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lambeta<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sonar-custom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>sonar-plugin<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>sonar-custom<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://www.lambeta.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.sonarsource.sonarqube<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sonar-plugin-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- minimal version of SonarQube to support. Note that the groupId was &quot;org.codehaus.sonar&quot; before version 5.2 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- mandatory scope --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sourceforge.pmd<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pmd-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dom4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dom4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.sonarsource.sonar-packaging-maven-plugin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sonar-packaging-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">extensions</span>&gt;</span>true<span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">pluginClass</span>&gt;</span>com.lambeta.CustomPlugin<span class="tag">&lt;/<span class="name">pluginClass</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">pluginDescription</span>&gt;</span>how to write sonar plugin<span class="tag">&lt;/<span class="name">pluginDescription</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>注意：</strong> pmd-xml、dom4j会在后面的编程当中使用到。</p>
</blockquote>
<p>依据标准的代码结构，新建<em>CustomPlugin.java</em>文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">├── src</span><br><span class="line">│   ├── main</span><br><span class="line">│   │   ├── java</span><br><span class="line">│   │   │   └── com</span><br><span class="line">│   │   │       └── lambeta</span><br><span class="line">│   │   │           ├── CustomPlugin.java</span><br></pre></td></tr></table></figure>
<h3 id="第二步-识别扩展点"><a href="#第二步-识别扩展点" class="headerlink" title="第二步 识别扩展点"></a>第二步 识别扩展点</h3><p>此时，该去查看<a target="_blank" rel="noopener" href="http://docs.sonarqube.org/display/DEV/API+Basics">API Basics</a>了。不过在写代码之前，还得先了解所谓的扩展点（Extension Points）。</p>
<blockquote>
<p>Scanner, which runs the source code analysis<br>Compute Engine, which consolidates the output of scanners, for example by<br>computing 2nd-level measures such as ratings<br>aggregating measures (for example number of lines of code of project &#x3D; sum of lines of code of all files)<br>assigning new issues to developers<br>persisting everything in data stores<br>Web application</p>
</blockquote>
<p>翻译如下</p>
<ul>
<li>扫描器：分析源代码</li>
<li>计算引擎：聚合扫描器的输出。举例：计算第二轮measures，如打分；聚合measures（举例：工程中所有代码的行数 &#x3D; 所有文件的代码行的综合）；给开发者安排新的问题；持久化。</li>
<li>Web应用程序。<br>翻译还不如不翻译！一言不合，去看例子程序…的<a target="_blank" rel="noopener" href="https://github.com/SonarSource/sonar-examples/blob/master/plugins/sonar-example-plugin/src/main/java/org/sonarsource/plugins/example/ExamplePlugin.java">注释</a></li>
</ul>
<p>这三个扩展点，其实对应于API中的三个接口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">扫描器 -&gt; Sensor</span><br><span class="line">计算引擎 -&gt; MeasureComputer</span><br><span class="line">Web应用程序 -&gt; Widget</span><br></pre></td></tr></table></figure>

<h3 id="第三步-定义Sensor（Scanner"><a href="#第三步-定义Sensor（Scanner" class="headerlink" title="第三步 定义Sensor（Scanner)"></a>第三步 定义Sensor（Scanner)</h3><p>基于扫描DSL源码的需求，我们需要扩展Sensor这个接口。新建<em>CustomSensor.java</em>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSensor</span> <span class="keyword">implements</span> <span class="title class_">Sensor</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">describe</span><span class="params">(SensorDescriptor descriptor)</span> </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(SensorContext context)</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>接下来，我们需要定义这门DSL语言的某些属性，以便于识别以及扫描时过滤相关的源文件（通过文件的后缀）。</p>
<h3 id="第四步-定义语言（Language）"><a href="#第四步-定义语言（Language）" class="headerlink" title="第四步 定义语言（Language）"></a>第四步 定义语言（Language）</h3><p>新建<em>CustomLanguage</em>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lambeta;</span><br><span class="line"><span class="keyword">import</span> org.sonar.api.resources.AbstractLanguage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomLanguage</span> <span class="keyword">extends</span> <span class="title class_">AbstractLanguage</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY</span> <span class="operator">=</span> <span class="string">&quot;custom-key&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NAME</span> <span class="operator">=</span> <span class="string">&quot;custom-name&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomLanguage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(KEY, NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] getFileSuffixes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;csm.xml&quot;</span>&#125;; <span class="comment">//custom这门基于xml的内部DSL的文件后缀</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我定义了一门基于xml语法的内部DSL，其文件的后缀是<em>csm.xml</em>。比如：<em>right-syntax.csm.xml</em></p>
<p>Language定义出来了，我们还得定义rule、profile和repository. 回到上文提及的language、rule、profile以及repository的关系图：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">profile</span><br><span class="line">    - language</span><br><span class="line">    - [rules]</span><br><span class="line">      - rule</span><br><span class="line">        - respository</span><br><span class="line">respository</span><br><span class="line">    - language</span><br><span class="line">    - [rules]</span><br></pre></td></tr></table></figure>
<h3 id="第五步-定义规则（Rule）"><a href="#第五步-定义规则（Rule）" class="headerlink" title="第五步 定义规则（Rule）"></a>第五步 定义规则（Rule）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">respository</span><br><span class="line">    - language</span><br><span class="line">    - [rules]</span><br></pre></td></tr></table></figure>
<p>我们需要实现接口<em>RulesDefinition</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lambeta;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.Charsets;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.sonar.api.server.rule.RulesDefinition;</span><br><span class="line"><span class="keyword">import</span> org.sonar.api.server.rule.RulesDefinitionXmlLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomRulesDefinition</span> <span class="keyword">implements</span> <span class="title class_">RulesDefinition</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REPOSITORY_KEY</span> <span class="operator">=</span> <span class="string">&quot;custom-repo&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RulesDefinitionXmlLoader xmlLoader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomRulesDefinition</span><span class="params">(RulesDefinitionXmlLoader xmlLoader)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.xmlLoader = xmlLoader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">define</span><span class="params">(Context context)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">InputStream</span> <span class="variable">stream</span> <span class="operator">=</span> getClass().getResourceAsStream(<span class="string">&quot;/rules.xml&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">NewRepository</span> <span class="variable">repository</span> <span class="operator">=</span> context.createRepository(REPOSITORY_KEY, CustomLanguage.KEY);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                xmlLoader.load(repository, stream, Charsets.UTF_8);</span><br><span class="line">            &#125;</span><br><span class="line">            repository.done();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IOUtils.closeQuietly(stream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们通过context新建出一个repository。respository需要一个唯一key作为其标识（可以通过setName方法设置名称）以及一个language key来关联（从UI上可以看出来）。然后，通过DI进来的<em>RulesDefinitionXmlLoader</em>将<em>rules.xml</em>中定义的rules加载进repository中。最后，调用*reposiotory.done()*宣告加载完成。</p>
<p>定义的<em>rules.xml</em>内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">key</span>&gt;</span>ComponentsMustNotBeFollowedByComponentsRule<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Components标签后不能跟随Components标签规则<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">            &lt;![CDATA[</span><br><span class="line">                Components标签后不能跟随Components标签</span><br><span class="line">            ]]&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">severity</span>&gt;</span>MINOR<span class="tag">&lt;/<span class="name">severity</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cardinality</span>&gt;</span>SINGLE<span class="tag">&lt;/<span class="name">cardinality</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">status</span>&gt;</span>READY<span class="tag">&lt;/<span class="name">status</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tag</span>&gt;</span>custom<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">example</span>&gt;</span></span><br><span class="line">            &lt;![CDATA[</span><br><span class="line">                &lt;components&gt;</span><br><span class="line">                &lt;!-- Error, components must be here! --&gt;</span><br><span class="line">                    &lt;components/&gt;</span><br><span class="line">                &lt;/components&gt;</span><br><span class="line">            ]]&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">example</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rules</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>包含了rule的key和其他相关的属性。它们最终显示在UI上，会是这样：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/217988-91243613d40090e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Rule"></p>
<h3 id="第六步-定义Profile"><a href="#第六步-定义Profile" class="headerlink" title="第六步 定义Profile"></a>第六步 定义Profile</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">profile</span><br><span class="line">    - language</span><br><span class="line">    - [rules]</span><br><span class="line">      - rule</span><br><span class="line">        - respository</span><br></pre></td></tr></table></figure>
<p>我们需要实现接口<em>ProfileDefinition</em>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lambeta;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.sonar.api.profiles.ProfileDefinition;</span><br><span class="line"><span class="keyword">import</span> org.sonar.api.profiles.RulesProfile;</span><br><span class="line"><span class="keyword">import</span> org.sonar.api.profiles.XMLProfileParser;</span><br><span class="line"><span class="keyword">import</span> org.sonar.api.utils.ValidationMessages;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomProfileDefinition</span> <span class="keyword">extends</span> <span class="title class_">ProfileDefinition</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> XMLProfileParser xmlProfileParser;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomProfileDefinition</span><span class="params">(XMLProfileParser xmlProfileParser)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.xmlProfileParser = xmlProfileParser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RulesProfile <span class="title function_">createProfile</span><span class="params">(ValidationMessages validation)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">InputStreamReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(getClass().getResourceAsStream(<span class="string">&quot;/profile.xml&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> xmlProfileParser.parse(reader, validation);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IOUtils.closeQuietly(reader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用DI注入的XMLProfileParser解析<em>profile.xml</em>文件，并生成RulesProfile对象。我们来看看<em>profile.xml</em>的内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">language</span>&gt;</span>custom-key<span class="tag">&lt;/<span class="name">language</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Custom Quality<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">repositoryKey</span>&gt;</span>custom-repo<span class="tag">&lt;/<span class="name">repositoryKey</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>ComponentsMustNotBeFollowedByComponentsRule<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">priority</span>&gt;</span>MAJOR<span class="tag">&lt;/<span class="name">priority</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rules</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里定义一个名为<em>Custom Quality</em>的profile，它关联CustomLanguage的键值：custom-key. 同时包含了多条rules，每条rule拥有自己的标识key以及其所在的repository（事实上，profile会在repository中通过ruleKey来查找rule）。</p>
<p>写到这里，一个DSL的SonarQube Plugin已经几近完善。但是，我们还缺少至关重要的一环——<strong>规则的执行！</strong></p>
<h3 id="第七步-运行PMD扫描代码"><a href="#第七步-运行PMD扫描代码" class="headerlink" title="第七步 运行PMD扫描代码"></a>第七步 运行PMD扫描代码</h3><h4 id="PMD简介"><a href="#PMD简介" class="headerlink" title="PMD简介"></a>PMD简介</h4><p>我们需要一个静态扫描工具来扫描源代码，发现这些代码存在的缺陷和坏味道。PMD就是这么一款好用的工具。</p>
<blockquote>
<p>PMD is a source code analyzer. It finds common programming flaws like unused variables, empty catch blocks, unnecessary object creation, and so forth. It supports Java, JavaScript, PLSQL, Apache Velocity, XML, XSL.</p>
</blockquote>
<p>翻译：<br>PMD是一款源码分析工具。它会发现编程中的普遍缺陷，如未使用的变量、空的catch块、不必要的对象创建等等。它支持分析Java、Javascript、PLSQL、Apache Velocity、XML、XSL语言。</p>
<p>前面提到我定义的是一门基于XML的DSL，那么理所当然，可以借助PMD，扩展XML的扫描规则来满足自己的需求。</p>
<p>PMD在命令行中执行的方式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pmd -d src/ -f xml -R myrule.xml -r dest/report.xml</span><br></pre></td></tr></table></figure>
<ul>
<li>-d 代表要扫描的源码目录</li>
<li>-f 代表报告输出的格式</li>
<li>-R 代表采用哪些规则来扫描源代码</li>
<li>-r 代表报告的输出路径</li>
</ul>
<blockquote>
<p><strong>注意：</strong>这里PMD的规则和SonarQube中的规则其实没有太大关系，属于两种事物。不过，为方便后续提取PMD输出的报告，需要将PMD规则的名字和Sonar规则的键值保持一致。</p>
</blockquote>
<p>我们定义PMD需要使用到的规则集<em>custom-pmd-rules.xml</em>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ruleset</span> <span class="attr">name</span>=<span class="string">&quot;ExamplePmdRuleset&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns</span>=<span class="string">&quot;http://pmd.sourceforge.net/ruleset/2.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://pmd.sourceforge.net/ruleset/2.0.0 http://pmd.sourceforge.net/ruleset_2_0_0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">        Example set of configured PMD rules</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">name</span>=<span class="string">&quot;ComponentsMustNotBeFollowedByComponentsRule&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">message</span>=<span class="string">&quot;Components tags followed by components tag found!&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">language</span>=<span class="string">&quot;xml&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">&quot;net.sourceforge.pmd.lang.rule.XPathRule&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">            Tag components must not be followed by components tag.</span><br><span class="line">        <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">priority</span>&gt;</span>1<span class="tag">&lt;/<span class="name">priority</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;xpath&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>//components/components<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">example</span>&gt;</span></span><br><span class="line">            &lt;![CDATA[</span><br><span class="line">                &lt;components&gt;</span><br><span class="line">                    &lt;components&gt;</span><br><span class="line">                &lt;/components&gt;</span><br><span class="line">            ]]&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">example</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ruleset</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里的类<em>net.sourceforge.pmd.lang.rule.XPathRule</em>来自于我们先前在pom.xml中声明的pmd-xml这个依赖包。它可以让我们通过设置<em>xpath</em>这一属性的值来构建各种不同规则。扫描中XML文件一旦匹配这些xpath规则，就会输出错误报告。</p>
<p>以<em>ComponentsMustNotBeFollowedByComponentsRule</em>这个自定义的规则为例。顾名思义，Components元素下不能再跟着Components元素。它在PMD扫描过程中如果被匹配上，会输出这样的报告：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pmd</span> <span class="attr">version</span>=<span class="string">&quot;5.4.2&quot;</span> <span class="attr">timestamp</span>=<span class="string">&quot;2016-06-23T23:06:04.120&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span> <span class="attr">name</span>=<span class="string">&quot;/Users/qianyan/github/sonar/sonar-custom/src/test/resources/wrong-syntax-but-not-csm.xml&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">violation</span> <span class="attr">beginline</span>=<span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">endline</span>=<span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">begincolumn</span>=<span class="string">&quot;5&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">endcolumn</span>=<span class="string">&quot;17&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">rule</span>=<span class="string">&quot;ComponentsMustNotBeFollowedByComponentsRule&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">ruleset</span>=<span class="string">&quot;ExamplePmdRuleset&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">priority</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">            Components tags followed by components tag found!</span><br><span class="line">        <span class="tag">&lt;/<span class="name">violation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span> <span class="attr">name</span>=<span class="string">&quot;/Users/qianyan/github/sonar/sonar-custom/src/test/resources/wrong-syntax.csm.xml&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">violation</span> <span class="attr">beginline</span>=<span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">endline</span>=<span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">begincolumn</span>=<span class="string">&quot;5&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">endcolumn</span>=<span class="string">&quot;17&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">rule</span>=<span class="string">&quot;ComponentsMustNotBeFollowedByComponentsRule&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">ruleset</span>=<span class="string">&quot;ExamplePmdRuleset&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">priority</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">            Components tags followed by components tag found!</span><br><span class="line">        <span class="tag">&lt;/<span class="name">violation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pmd</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="PMD报告转化为Sonar的Issue"><a href="#PMD报告转化为Sonar的Issue" class="headerlink" title="PMD报告转化为Sonar的Issue"></a>PMD报告转化为Sonar的Issue</h4><p>由于PMD是由Java编写的，所以我们可以在代码中调用PMD这个类<em>net.sourceforge.pmd.PMD</em>根据我们写好的PMD规则，来扫描Sonar指定的目录及其文件。最后，将PMD输出的XML格式的报告转化成Sonar能够理解的Issue。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(SensorContext context)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">reportFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.fileSystem().workDir(), <span class="string">&quot;report.xml&quot;</span>); <span class="comment">// 1</span></span><br><span class="line">        runPMD(context, reportFile); <span class="comment">// 2</span></span><br><span class="line">        convertToIssues(context, doc(reportFile)); <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>指定PMD输出文件的路径；</li>
<li>运行PMD，输出XML格式的报告到1指定的文件当中；</li>
<li>解析报告，并转化为Issue。</li>
</ol>
<p>下面我们一步步来解释对应的代码：</p>
<ul>
<li>runPMD<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">runPMD</span><span class="params">(SensorContext context, File reportFile)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> context.settings().getString(<span class="string">&quot;sonar.sources&quot;</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dir);</span><br><span class="line">    String[] pmdArgs = &#123;</span><br><span class="line">            <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;xml&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-R&quot;</span>, <span class="string">&quot;custom-pmd-rules.xml&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-d&quot;</span>, dir,</span><br><span class="line">            <span class="string">&quot;-r&quot;</span>, reportFile.getAbsolutePath(),</span><br><span class="line">            <span class="string">&quot;-e&quot;</span>, context.settings().getString(<span class="string">&quot;sonar.sourceEncoding&quot;</span>),</span><br><span class="line">            <span class="string">&quot;-language&quot;</span>, <span class="string">&quot;xml&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-version&quot;</span>, <span class="string">&quot;1.0&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(getClass().getClassLoader());</span><br><span class="line">        PMD.run(pmdArgs);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(loader);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
我们通过PMD这个类运行pmdArgs。这里值得注意的是自SonarQube 5.6之后，我们可以通过context.settings()来获取工程的配置了，而不像以前那样依赖注入Settings对象了。</li>
</ul>
<p>至于<code> Thread.currentThread().setContextClassLoader(getClass().getClassLoader());</code>这步操作和Sonar使用独立的classLoader加载自己的类有关。</p>
<ul>
<li>convertToIssues<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">convertToIssues</span><span class="params">(SensorContext context, Document doc)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Element</span> <span class="variable">root</span> <span class="operator">=</span> doc.getRootElement();</span><br><span class="line">    <span class="keyword">final</span> List&lt;Element&gt; files = root.elements(<span class="string">&quot;file&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (Element file : files) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> List&lt;Element&gt; violations = file.elements(<span class="string">&quot;violation&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> file.attributeValue(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FileSystem</span> <span class="variable">fs</span> <span class="operator">=</span> context.fileSystem();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">InputFile</span> <span class="variable">inputFile</span> <span class="operator">=</span> fs.inputFile(fs.predicates().hasAbsolutePath(filePath));</span><br><span class="line">        <span class="keyword">if</span> (inputFile == <span class="literal">null</span>) &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;fs predicates that there is no &#123;&#125;&quot;</span>, filePath);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Element violation : violations) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">rule</span> <span class="operator">=</span> violation.attributeValue(<span class="string">&quot;rule&quot;</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">beginLine</span> <span class="operator">=</span> Integer.parseInt(violation.attributeValue(<span class="string">&quot;beginline&quot;</span>));</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">endLine</span> <span class="operator">=</span> Integer.parseInt(violation.attributeValue(<span class="string">&quot;endline&quot;</span>));</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">beginColumn</span> <span class="operator">=</span> Integer.parseInt(violation.attributeValue(<span class="string">&quot;begincolumn&quot;</span>));</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">endColumn</span> <span class="operator">=</span> Integer.parseInt(violation.attributeValue(<span class="string">&quot;endcolumn&quot;</span>));</span><br><span class="line">            <span class="keyword">final</span> <span class="type">NewIssue</span> <span class="variable">newIssue</span> <span class="operator">=</span> context.newIssue()</span><br><span class="line">                    .forRule(RuleKey.of(CustomRulesDefinition.REPOSITORY_KEY, rule));</span><br><span class="line">            <span class="keyword">final</span> <span class="type">NewIssueLocation</span> <span class="variable">newIssueLocation</span> <span class="operator">=</span> newIssue</span><br><span class="line">                    .newLocation()</span><br><span class="line">                    .on(inputFile)</span><br><span class="line">                    .at(inputFile.newRange(beginLine, beginColumn, endLine, endColumn))</span><br><span class="line">                    .message(violation.getText());</span><br><span class="line">            newIssue.at(newIssueLocation).save();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这里主要是对PMD生成XML报告的解析和转换。比较需要关注是这块代码：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">InputFile</span> <span class="variable">inputFile</span> <span class="operator">=</span> fs.inputFile(fs.predicates().hasAbsolutePath(filePath));</span><br><span class="line"><span class="keyword">if</span> (inputFile == <span class="literal">null</span>) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;fs predicates that there is no &#123;&#125;&quot;</span>, filePath);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
InputFile这是Sonar定义的合法的待扫描文件。举个例子：我们定义了一门基于XML的DSL，其文件的后缀是<em>csm.xml</em>，那么合法的待扫描文件就只能是这个后缀的文件了。像上述PMD输出的那份报告中出现的<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">file</span> <span class="attr">name</span>=<span class="string">&quot;/Users/qianyan/github/sonar/sonar-custom/src/test/resources/wrong-syntax-but-not-csm.xml&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
就是不合法的。这个文件是以xml作为后缀的，PMD肯定可以扫描它，但是对于Sonar而言，它并不是InputFile（如果不作处理，就会返回null），所以我们需要在转换为Issue之前剔除掉。</li>
</ul>
<p>最后，不要忘记保存，<code>newIssue.at(newIssueLocation).save();</code>。</p>
<p>Issue呈现在UI上，是这样的：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/217988-87d84e5cc8a49c37.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Issue"></p>
<h3 id="第八步-注册所有组件"><a href="#第八步-注册所有组件" class="headerlink" title="第八步 注册所有组件"></a>第八步 注册所有组件</h3><p>现在所有的组件已经就绪，是时候将这些组件注册进插件当中了。还记得第一步我们创建的<em>CustomPlugin.java</em>? 所有上述组件，包括Language、Rules、Profiles以及Sensor都得在这个类中进行注册。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lambeta;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.sonar.api.Plugin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomPlugin</span> <span class="keyword">implements</span> <span class="title class_">Plugin</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">define</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        context.addExtension(CustomLanguage.class)</span><br><span class="line">                .addExtension(CustomRulesDefinition.class)</span><br><span class="line">                .addExtension(CustomProfileDefinition.class)</span><br><span class="line">                .addExtension(CustomSensor.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此，这个插件算是写完了。那么接下来的问题就是如何运行它？</p>
<h2 id="使用插件扫描工程"><a href="#使用插件扫描工程" class="headerlink" title="使用插件扫描工程"></a>使用插件扫描工程</h2><h3 id="下载sonarqube-docker镜像"><a href="#下载sonarqube-docker镜像" class="headerlink" title="下载sonarqube docker镜像"></a>下载sonarqube docker镜像</h3><p>最易于调试的地方莫过于本地了。如果机器是Mac，建议使用Kitematic这个Docker的客户端下载sonarqube的官方镜像，同时将映射的Port定在9000端口上，启动该镜像的容器实例。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/217988-2e1f14fff13e1fd7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="sonarqube docker"></p>
<h3 id="构建和Copy插件包"><a href="#构建和Copy插件包" class="headerlink" title="构建和Copy插件包"></a>构建和Copy插件包</h3><p>在插件的工程根目录下，运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package</span><br></pre></td></tr></table></figure>
<p>然后执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp target/sonar-custom-1.0-SNAPSHOT.jar /Users/your-name/Documents/Kitematic/sonarqube/opt/sonarqube/extensions/plugins</span><br></pre></td></tr></table></figure>
<p>如果plugins目录不存在，可以手动创建。执行完命令之后，重启容器。</p>
<h3 id="安装Maven的sonar插件"><a href="#安装Maven的sonar插件" class="headerlink" title="安装Maven的sonar插件"></a>安装Maven的sonar插件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- settings.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/SETTINGS/1.0.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/SETTINGS/1.0.0</span></span></span><br><span class="line"><span class="string"><span class="tag">    https://maven.apache.org/xsd/settings-1.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">localRepository</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interactiveMode</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">usePluginRegistry</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">offline</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginGroups</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginGroup</span>&gt;</span>org.sonarsource.scanner.maven<span class="tag">&lt;/<span class="name">pluginGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginGroups</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>sonar<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- Optional URL to server. Default value is http://localhost:9000 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">sonar.host.url</span>&gt;</span></span><br><span class="line">                  http://192.168.99.100:9000</span><br><span class="line">                <span class="tag">&lt;/<span class="name">sonar.host.url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servers</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrors</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">proxies</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activeProfiles</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>将这个settings.xml的文件放到~&#x2F;.m2下。</p>
<h3 id="运行Maven-sonar-sonar"><a href="#运行Maven-sonar-sonar" class="headerlink" title="运行Maven sonar:sonar"></a>运行Maven sonar:sonar</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn sonar:sonar -Dsonar.sources=src/test/resources/ -Dsonar.language=custom-key -X</span><br></pre></td></tr></table></figure>
<p><em>src&#x2F;test&#x2F;resources</em>目录展开如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">src/test/resources</span><br><span class="line">├── right-syntax.csm.xml</span><br><span class="line">├── wrong-syntax-but-not-csm.xml</span><br><span class="line">└── wrong-syntax.csm.xml</span><br></pre></td></tr></table></figure>
<p>然后，根据输出提示，访问<br><a target="_blank" rel="noopener" href="http://192.168.99.100:9000/dashboard/index/com.lambeta:sonar-custom">http://192.168.99.100:9000/dashboard/index/com.lambeta:sonar-custom</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><img src="http://upload-images.jianshu.io/upload_images/217988-136f034d165b9c38.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Sonar Plugin"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/217988-fd2a3f30fc23d31d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Plugin implements details"></p>
<p>[1] <a target="_blank" rel="noopener" href="http://docs.sonarqube.org/display/DEV/Developing+a+Plugin">官方教程</a><br>[2] <a target="_blank" rel="noopener" href="https://deors.wordpress.com/2014/03/20/sonarqube-plugins-1/">博客</a><br>[3] <a target="_blank" rel="noopener" href="https://github.com/SonarSource/sonar-examples/tree/master/plugins/sonar-example-plugin">官方样例</a><br>[4] <a target="_blank" rel="noopener" href="https://github.com/qianyan/sonar-custom-plugin">本文样例</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2016/05/30/Leiningen-Profile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/05/30/Leiningen-Profile/" class="post-title-link" itemprop="url">Leiningen Profile</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-05-30 21:21:26" itemprop="dateCreated datePublished" datetime="2016-05-30T21:21:26+08:00">2016-05-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-07 06:42:23" itemprop="dateModified" datetime="2016-09-07T06:42:23+08:00">2016-09-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Clojure/" itemprop="url" rel="index"><span itemprop="name">Clojure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="记忆用的Mindmap"><a href="#记忆用的Mindmap" class="headerlink" title="记忆用的Mindmap"></a>记忆用的Mindmap</h2><p><img src="/images/Leiningen-Profiles.png" alt="leingingen profiles"></p>
<h2 id="标准的leiningen的工程目录结构"><a href="#标准的leiningen的工程目录结构" class="headerlink" title="标准的leiningen的工程目录结构"></a>标准的leiningen的工程目录结构</h2><p>当我们使用<em>lein new your-project-name</em>之后，工程目录结构如下：</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2016/05/30/Leiningen-Profile/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2016/05/24/Using-Java1.8-to-Target-Older-JVMs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/05/24/Using-Java1.8-to-Target-Older-JVMs/" class="post-title-link" itemprop="url">高编译低运行错误(ConcurrentHashMap.keySet)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-05-24 23:26:09" itemprop="dateCreated datePublished" datetime="2016-05-24T23:26:09+08:00">2016-05-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-07 16:01:19" itemprop="dateModified" datetime="2016-09-07T16:01:19+08:00">2016-09-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>本地使用maven编译和运行时一切都正常，但是通过ci的方式，编译、打包、发布到部署环境，运行时抛出了一条一眼便知是关于JDK版本的错误。</p>
<p>错误是这个样子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NoSuchMethodError: java.util.concurrent.ConcurrentHashMap.keySet() </span><br><span class="line">Ljava/util/concurrent/ConcurrentHashMap$KeySetView;</span><br></pre></td></tr></table></figure>

<p>报的是的NoSuchMethodError的错误，且是关于java.util.concurrent.ConcurrentHashMap的。所以不难排查出原因是ci使用了JDK 8来进行编译，导致生成的字节码包含了JDK 8更改的新方法keySet——ConcurrentHashMap$KeySetView这个新增内部类作为其返回值的类型。</p>
<p>为了进一步验证部署服务器上的class文件都是JDK 8编译的，我使用javap这个JDK自带的工具做了如下的验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap -v a.class |grep major</span><br></pre></td></tr></table></figure>
<p>返回的结果是</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">major version: 51</span><br></pre></td></tr></table></figure>
<p>问题初露端倪，51对应的JDK版本号应该是1.7（或者7），52才是JDK 8的major版本。这里出现了两个疑惑：</p>
<ul>
<li>为什么ci使用JDK 8编译的class会是JDK 7的编译结果？</li>
<li>既然是JDK 7编译的class文件，那为何会出现JDK 8才有的内部类？</li>
</ul>
<p>先看第一个疑惑。之前说到ci也是通过maven compiler plugin进行编译的，pom.xml中可以配置language level如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这实际对应于javac的-source和-target参数，那么这两个参数具体代表什么呢？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">javac -<span class="built_in">help</span></span></span><br><span class="line">-source &lt;release&gt;          Provide source compatibility with specified release</span><br><span class="line">-target &lt;release&gt;          Generate class files for specific VM version</span><br></pre></td></tr></table></figure>
<p>source参数指的是源代码级别的语法兼容，而target参数指的是生成release版本的兼容性的class文件，不过<strong>只确保目标VM能够加载class文件，却无法保证运行时的正确性</strong>。接下来，我们尝试使用javac加上这些参数来编译源码。</p>
<p>首先我们写一段程序，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.java</span></span><br><span class="line"><span class="keyword">package</span> com.lambeta;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConcurrentHashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>();</span><br><span class="line">        map.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我本机的java版本是1.8，直接使用javac来编译App.java，结果如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">javac App.java</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">javap -v App.class |grep major</span></span><br><span class="line"> major version: 52</span><br></pre></td></tr></table></figure>
<p>如果指定source和target参数，再用javac编译App.java</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java -version</span></span><br><span class="line">java version &quot;1.8.0_45&quot;</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">javac -<span class="built_in">source</span> 7 -target 7 App.java</span></span><br><span class="line">warning: [options] bootstrap class path not set in conjunction with -source 1.7</span><br><span class="line">1 warning</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span></span></span><br><span class="line">App.class App.java</span><br></pre></td></tr></table></figure>
<p>这里有个警告，我们暂时不看。先使用javap反编译App.class，观察major version以及keySet()这个方法的返回值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">javap -v App.class</span></span><br><span class="line">...</span><br><span class="line">major version: 51</span><br><span class="line">...</span><br><span class="line">9: invokevirtual #4                  </span><br><span class="line">// Method java/util/concurrent/ConcurrentHashMap.keySet:()</span><br><span class="line"><span class="meta prompt_">Ljava/util/concurrent/ConcurrentHashMap$</span><span class="language-bash">KeySetView;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这样，第二个疑惑也解开了。可以初步得出一个结论。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>在javac指定了这些参数，降低版本号来编译，会导致生成class文件被标识为较低版本以供指定的JVM加载。<strong>但是</strong>，基于JDK 8的bootstrap class编译而成的keySet()方法，其返回值依旧是JDK 8中ConcurrentHashMap$KeySetView这个新增内部类。运行时，1.7的JVM尝试加载这个class文件，一定找不到KeySetView作为返回值的keySet()方法，出错。</p>
<h2 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h2><p>既然知道错在那里，就比较容易寻找到解决方案了。</p>
<ul>
<li>编译期间，替换掉bootstrap class</li>
<li>使用父类&#x2F;接口替换子类，即ConcurrentMap替换ConcurrentHashMap声明</li>
</ul>
<h3 id="编译期间，替换掉bootstrap-clas"><a href="#编译期间，替换掉bootstrap-clas" class="headerlink" title="编译期间，替换掉bootstrap clas"></a>编译期间，替换掉bootstrap clas</h3><p>javac编译时，可以指定bootclasspath，来替换默认的加载路径，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">javac -bootclasspath /Library/Java/JavaVirtualMachines/jdk1.7.0_60.jdk/Contents/Home/jre/lib/rt.jar \</span><br><span class="line">-source 7 -target 7 App.java</span><br><span class="line">// or</span><br><span class="line">javac -Xbootclasspath:/Library/Java/JavaVirtualMachines/jdk1.7.0_60.jdk/Contents/Home/jre/lib/rt.jar \</span><br><span class="line">-source 7 -target 7 App.java</span><br></pre></td></tr></table></figure>
<p>这时候，再去看看反编译的结果，就会是这样：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">major version: 51</span><br><span class="line">...</span><br><span class="line">9: invokevirtual #4                  </span><br><span class="line">// Method java/util/concurrent/ConcurrentHashMap.keySet:()Ljava/util/Set;</span><br></pre></td></tr></table></figure>
<p>此时major是51(JDK 7），而keySet()的返回值也是JDK 7中的java.util.Set类型了。</p>
<h3 id="使用父类-接口替换子类，即ConcurrentMap替换ConcurrentHashMap声明"><a href="#使用父类-接口替换子类，即ConcurrentMap替换ConcurrentHashMap声明" class="headerlink" title="使用父类&#x2F;接口替换子类，即ConcurrentMap替换ConcurrentHashMap声明"></a>使用父类&#x2F;接口替换子类，即ConcurrentMap替换ConcurrentHashMap声明</h3><p>上一种方案虽然可行，但是却不实用——因为不能要求ci服务器上有两个不同版本的JDK，也不能要求在maven构建时传递与安装路径如此紧耦合的值作为bootclasspath的参数值。所以可以采取将具体实现类的声明替换成为其接口的方式，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lambeta;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ConcurrentMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>();</span><br><span class="line">        map.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样编译好的字节码中就不会有ConcurrentHashMap$KeySetView这样的返回值类型了。在JDK 7上运行时，JVM动态调用的一定是ConcurrentHashMap的keySet():java.util.Set方法了。</p>
<hr>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ul>
<li>保证编译、打包环境和最终部署环境JDK版本的一致性</li>
<li>如果无法保证，就尽量面向接口编程，尤其是JDK中提供的类。原因是接口不易改变，而实现类遵循“宽收严发”原则，方法的入参和出参都是易变的。</li>
</ul>
<hr>
<p>参考链接<br>[1] <a target="_blank" rel="noopener" href="http://vanillajava.blogspot.jp/2012/02/using-java-7-to-target-much-older-jvms.html">Using Java 7 to target much older JVMs</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2016/04/26/Java-Inner-Class-Exception-Handler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/04/26/Java-Inner-Class-Exception-Handler/" class="post-title-link" itemprop="url">内部类的异常处理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-04-26 07:29:50" itemprop="dateCreated datePublished" datetime="2016-04-26T07:29:50+08:00">2016-04-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:41:53" itemprop="dateModified" datetime="2016-09-06T22:41:53+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>最近遇到一个问题，使用Java写某个DSL标记语言X的<em>parser（解析器）Maven</em>插件的时候，对外暴露一个名为<code>Callback</code>的接口和一个待实现的方法*getHTML()*——基于调用处传入的文件名<code>srcX</code>构造出HTML文件的输出路径（其实此处的<code>Callback</code>就是一个闭包，文件名是一个自由变量）。大致代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">parser.parse(srcX, <span class="keyword">new</span> <span class="title class_">Callback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileWriter <span class="title function_">getHTML</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(outputPath(suffix(srcX, <span class="string">&quot;html&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">suffix</span><span class="params">(String filename, String suffix)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> Joiner.on(<span class="string">&quot;.&quot;</span>).join(filename, suffix);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里假设输入和输出根路径地址已知</span></span><br><span class="line"><span class="keyword">private</span> File <span class="title function_">outputPath</span><span class="params">(String file)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">	           file.replace(srcDir.getAbsolutePath(), <span class="comment">//srcDir: File</span></span><br><span class="line">	             outputDir.getAbsolutePath())); <span class="comment">//outputDir: File</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>目前为止还没有任何问题。但若是运行时，这段程序很可能抛出异常<em>java.io.FileNotFoundException: your-file-name (No such file or directory)<em>。原因在于</em>file</em>的路径当中可能存在多级父级目录，例如：<em>outputDir&#x2F;p1&#x2F;p2&#x2F;srcX.html</em>，那么当<em>FileWriter</em>尝试创建<em>srcX.html</em>就会失败。此时最简单的方法就是提前创建好所有的父级目录，于是*outputPath()*方法会变成下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> File <span class="title function_">outputPath</span><span class="params">(String file)</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">outputFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">            file.replace(srcDir.getAbsolutePath(),</span><br><span class="line">                    outputDir.getAbsolutePath()));</span><br><span class="line">    outputFile.getParentFile().mkdirs(); <span class="comment">//创建可能不存在的父级目录</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> outputFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>似乎这段程序可以正常工作了，但是创建文件夹这样的操作是可能失败的。所以我们需要关注是否创建成功，若失败，则写入Log文件当中。修改程序如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> File <span class="title function_">outputPath</span><span class="params">(String file)</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">outputFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">            file.replace(srcDir.getAbsolutePath(),</span><br><span class="line">                    outputDir.getAbsolutePath()));</span><br><span class="line">    <span class="keyword">final</span> <span class="type">File</span> <span class="variable">parentDirs</span> <span class="operator">=</span> outputFile.getParentFile();</span><br><span class="line">    <span class="keyword">if</span> (!parentDirs.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!parentDirs.mkdirs()) &#123;<span class="comment">//创建可能不存在的父级目录</span></span><br><span class="line">            getLog().error(<span class="string">&quot;Cannot create parent dirs for &#123;&#125;&quot;</span>, outputFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> outputFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong><br>这里我们需要先判断父级目录是否存在，即<em>parentDirs.exists()？</em>可是*parentDirs.mkdirs()<em>不是直接返回boolean值来表示是否创建成功吗？是这样么？这儿有</em>mkdirs()*方法的说明：</p>
<blockquote>
<p>public boolean mkdirs()<br>Creates the directory named by this abstract pathname, including any necessary but nonexistent parent directories. Note that if this operation fails it may have succeeded in creating some of the necessary parent directories.<br>Returns:<br>true if and only if the directory was created, along with all necessary parent directories; false otherwise</p>
</blockquote>
<p>也就是说只有当这个目录及其所有的父级目录都被创建时，才返回true，反之返回false。照这个推论，如果所有目录事先已经存在了，这个方法应该也会返回true，毕竟都被创建过了嘛。但是只要稍微看一眼源码，你就会发现事实并非如此：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mkdirs源码</span></span><br><span class="line"><span class="keyword">if</span> (exists()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以这里需要特别强调<strong>was created</strong>是一种操作，如果没有进行这个操作，那就不能算这个方法成功。</p>
<p>前面已经提到过，我需要写一个maven的插件，所以最好在这种导致程序崩溃的地方抛出一个maven中通用的异常<em>MojoExecutionException</em>。这样，更改代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> File <span class="title function_">outputPath</span><span class="params">(String file)</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">outputFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">            file.replace(srcDir.getAbsolutePath(),</span><br><span class="line">                    outputDir.getAbsolutePath()));</span><br><span class="line">    <span class="keyword">final</span> <span class="type">File</span> <span class="variable">parentDirs</span> <span class="operator">=</span> outputFile.getParentFile();</span><br><span class="line">    <span class="keyword">if</span> (!parentDirs.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!parentDirs.mkdirs()) &#123;<span class="comment">//创建可能不存在的父级目录</span></span><br><span class="line">            getLog().error(<span class="string">&quot;Cannot create parent dirs for &#123;&#125;&quot;</span>, outputFile);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MojoExecutionException</span>(<span class="string">&quot;Cannot create parent dirs&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> outputFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时，问题才显出端倪——异常<em>MojoExecutionException</em>是一个受检的异常(checked Exception)，它间接继承自<em>java.lang.Exception</em>。可是我们的<em>getHTML()<em>方法并没有在签名中抛出任何异常，编译无法通过。那唯一的办法就是</em>try…catch</em>了，但是我不应该捕获自己<strong>刚刚</strong>抛出来的异常，否则抛出受检异常的意义何在？</p>
<p>这时，自然而然会想到，将方法签名改成<em>getHTML() throws MojoExecutionException</em>。确实可行，但是并不合适，因为<em>MojoExecutionException</em>只是Maven插件规定的异常，而getHTML()则是一个对外暴露的API，不应该依赖于某个具体的异常。所以我将异常扩大化：<em>getHTML() throws Exception</em>，这样做的好处很明显，坏处也很显眼。</p>
<h3 id="好处"><a href="#好处" class="headerlink" title="好处"></a>好处</h3><ol>
<li>牢记《Unix编程艺术》中的“宽收严发”原则。即子类实现父类、接口的方法，入参可以扩大，出参可以缩小。举个例子：父类、接口有个方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">something</span><span class="params">(HashMap map)</span> <span class="keyword">throws</span> Exception</span><br></pre></td></tr></table></figure>
<p>那么子类实现这个方法可以这样写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">something</span><span class="params">(Map map)</span></span><br><span class="line">                  <span class="keyword">throws</span> ExecutionException, NoSuchMethodException</span><br></pre></td></tr></table></figure>
<p>这里，入参是HashMap，出参是Object和Exception。入参扩大，所以子类出现了Map；出参缩小，所以子类出现了String和ExecutionException和NoSuchMethodException。同理，此处<em>getHTML() throws Exception</em>由子类实现的形式可以是<em>getHTML() throws MojoExecutionException</em>。</p>
<h3 id="坏处"><a href="#坏处" class="headerlink" title="坏处"></a>坏处</h3><ol>
<li>不管getHTML()是否需要抛出异常，你都得在实现代码中抛出异常；</li>
<li>由于对外表现的是抛出较宽泛的Exception，所以丧失了对于具体受检 (checked exception)异常进行检查的好处。</li>
</ol>
<p>这里有个JDK中比较类似的例子，就是关于<code>Runnable</code>和<code>Callable</code>接口的设计问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Callable</span>&lt;V&gt; &#123;</span><br><span class="line">    V <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它们就是两个极端，<code>Runnable</code>必须将受检的异常转换成非受检(unchecked exception)或者发明一种方式来将异常暴露给调用者；<code>Callable</code>就是无论如何都得抛出异常，而且迫使用户去捕获一个较宽泛的异常。</p>
<h2 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h2><p>这个时候，泛型就派上用场了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Callback</span>&lt;E <span class="keyword">extends</span> <span class="title class_">Exception</span>&gt; &#123;</span><br><span class="line">    FileWriter <span class="title function_">getHTML</span><span class="params">()</span> <span class="keyword">throws</span> E;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//interface parser</span></span><br><span class="line"><span class="keyword">public</span> &lt;E <span class="keyword">extends</span> <span class="title class_">Exception</span>&gt; <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">(String srcX, Callback&lt;E&gt; cb)</span> <span class="keyword">throws</span> E;</span><br></pre></td></tr></table></figure>
<p>通过这种方式，我们可以捕获具体的异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    parser.parse(srcX, <span class="keyword">new</span> <span class="title class_">Callback</span>&lt;MojoExecutionException&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> FileWriter <span class="title function_">getHTML</span><span class="params">()</span> <span class="keyword">throws</span> MojoExecutionException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(outputPath(suffix(srcX, <span class="string">&quot;html&quot;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (MojoExecutionException e) &#123;</span><br><span class="line">    getLog().error(<span class="string">&quot;Failed to execute. &#123;&#125;&quot;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用lambda表达式可以简化成下面的模样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    parser.parse(srcX, (Callback&lt;MojoExecutionException&gt;) () -&gt; <span class="keyword">new</span> <span class="title class_">FileWriter</span>(outputPath(suffix(srcX, <span class="string">&quot;html&quot;</span>))));</span><br><span class="line">&#125; <span class="keyword">catch</span> (MojoExecutionException e) &#123;</span><br><span class="line">    getLog().error(<span class="string">&quot;Failed to execute. &#123;&#125;&quot;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们解决了<em>迫使用户去捕获一个较宽泛的异常</em>的问题，但是<em>无论如何都得抛出异常这个问题</em>还是没有得到解决。或许我们需要一个像是<em>throws Nothing</em>一样的语法，表示什么也没有抛出来。我们知道RuntimeException是非受检的异常(unchecked exception)，所以<em>throws RuntimeException</em>就表明这个异常跟没有抛出异常一样，不需要捕获。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">parser.parse(srcX, <span class="keyword">new</span> <span class="title class_">Callback</span>&lt;Nothing&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileWriter <span class="title function_">getHTML</span><span class="params">()</span> <span class="keyword">throws</span> Nothing &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(outputPath(suffix(srcX, <span class="string">&quot;html&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Nothing</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>走到这一步，我们算是较为完全地解决了匿名内部类的异常处理问题。</p>
<h2 id="异常透明化"><a href="#异常透明化" class="headerlink" title="异常透明化"></a>异常透明化</h2><blockquote>
<p>With the throws type parameter on the Block interface, we can now accurately generify over the set of exceptions thrown by the Block; with the generic forEach method, we can mirror the exception behavior of the block in forEach(). This is called exception transparency because now the exception behavior of forEach can match the exception behavior of its block argument. Exception transparency simplifies the construction of library classes that implement idioms like internal iteration of data structures, because it is common that methods that accept function-valued arguments will invoke those functions, meaning that the library method will throw a superset of the exceptions thrown by its function-valued arguments.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Block</span>&lt;T, <span class="keyword">throws</span> E&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(T element)</span> <span class="keyword">throws</span> E;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">NewCollection</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span>&lt;<span class="keyword">throws</span> E&gt; forEach(Block&lt;T, <span class="keyword">throws</span> E&gt; block) <span class="keyword">throws</span> E;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>异常透明化，简单来讲，就是调用者的签名中的异常完全由它的函数值(function-valued)的参数决定，所有这些调用者最终的异常都会是该函数值所注异常的超集。</p>
<p>异常透明化就是用来解决我们常用的通过内部类模拟闭包调用时异常处理的手法了。</p>
<hr>
<p><strong>闭包的定义</strong><br>一个包含了自由变量的开发表达式，和该自由变量的约束环境组合之后，产生了一种封闭的状态。</p>
<hr>
<p>参考链接<br>[1] <a target="_blank" rel="noopener" href="https://blogs.oracle.com/briangoetz/entry/exception_transparency_in_java">Exception Transparency</a><br>[2] <a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/8101575/throwing-checked-exceptions-from-anonymous-inner-classes">Throwing Checked Exceptions from Anonymous Inner Classes</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2016/03/22/Node-js-On-Windows/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/03/22/Node-js-On-Windows/" class="post-title-link" itemprop="url">Node.js on Windows</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-03-22 22:39:24" itemprop="dateCreated datePublished" datetime="2016-03-22T22:39:24+08:00">2016-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:56:31" itemprop="dateModified" datetime="2016-09-06T22:56:31+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="搭建-Node-js-开发环境"><a href="#搭建-Node-js-开发环境" class="headerlink" title="搭建 Node.js 开发环境"></a>搭建 Node.js 开发环境</h2><h3 id="NVM安装"><a href="#NVM安装" class="headerlink" title="NVM安装"></a>NVM安装</h3><p>1. <a target="_blank" rel="noopener" href="https://github.com/coreybutler/nvm/releases">Download nvm-noinstall.zip</a><br>2. Update the system environment variables:<br><em>NVM_HOME</em>, <em>NVM_SYMLINK</em> (C:\Users\Program Files\nodejs <strong>This directory should not exist in previously.</strong>)<br>3. Create <em>settings.txt</em> file</p>
<blockquote>
<p>root: C:\Users\qinayan\bin\nvm<br>path: C:\Program Files\nodejs<br>arch: 64<br>proxy: none</p>
</blockquote>
<p>详情请参考 <a target="_blank" rel="noopener" href="https://github.com/coreybutler/nvm-windows/wiki#manual-installation">如何安装nvm-windows</a><br>另外别忘了在<em>NVM_HOME</em>目录中运行<em>install</em>命令</p>
<h3 id="node-js安装"><a href="#node-js安装" class="headerlink" title="node.js安装"></a>node.js安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">安装特定版本的nodejs</span><br><span class="line">&gt; nvm install 0.12.10</span><br><span class="line">安装最新版本的nodejs</span><br><span class="line">&gt; nvm install latest</span><br><span class="line">查看本地安装了哪些nodejs</span><br><span class="line">&gt; nvm ls</span><br><span class="line"> * 5.7.1 (Currently using 64-bit executable)</span><br><span class="line">   0.12.10</span><br><span class="line">验证安装完成   </span><br><span class="line">&gt; node -v</span><br><span class="line">  v5.7.1</span><br><span class="line">&gt; node</span><br><span class="line">...&gt; console.log(&quot;hello world&quot;);</span><br><span class="line">  hello world</span><br></pre></td></tr></table></figure>
<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>每个文件就是一个模块，文件的路径名就是模块的名字</p>
<h3 id="require"><a href="#require" class="headerlink" title="require"></a>require</h3><p>类似于Java中的<code>import</code>关键字，导入不同的包。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var express = require(&#x27;express&#x27;);</span><br></pre></td></tr></table></figure>
<h3 id="exports"><a href="#exports" class="headerlink" title="exports"></a>exports</h3><p>导出模块的公有方法和属性。可以理解为Java中的<code>public</code>方法和属性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// util.js</span><br><span class="line">exports.greeting = function(name) &#123;</span><br><span class="line">   return &quot;hello, &quot; + name;   </span><br><span class="line">&#125;</span><br><span class="line">// index.js</span><br><span class="line">var greeting = require(&#x27;./util&#x27;).greeting;</span><br><span class="line">console.log(greeting(&quot;lambeta&quot;))</span><br><span class="line">&gt;  hello, lambeta</span><br></pre></td></tr></table></figure>
<h3 id="module"><a href="#module" class="headerlink" title="module"></a>module</h3><p>包含当前模块的一些信息，常用的做法是替换当前模块的导出对象。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// util.js</span><br><span class="line">console.log(module)</span><br><span class="line">&gt;&gt;</span><br><span class="line">Module &#123;</span><br><span class="line">  id: &#x27;.&#x27;,</span><br><span class="line">  exports: &#123; greeting: [Function] &#125;,</span><br><span class="line">  parent: null,</span><br><span class="line">  filename: &#x27;C:\\Users\\qianyan\\Projects\\lesson2\\util.js&#x27;,</span><br><span class="line">  loaded: false,</span><br><span class="line">  children: [],</span><br><span class="line">  paths:</span><br><span class="line">   [ &#x27;C:\\Users\\qianyan\\Projects\\lesson2\\node_modules&#x27;,</span><br><span class="line">     &#x27;C:\\Users\\qianyan\\Projects\\node_modules&#x27;,</span><br><span class="line">     &#x27;C:\\Users\\qianyan\\node_modules&#x27;,</span><br><span class="line">     &#x27;C:\\Users\\node_modules&#x27;,</span><br><span class="line">     &#x27;C:\\node_modules&#x27; ] &#125;</span><br><span class="line"></span><br><span class="line">// replace with obj</span><br><span class="line">module.exports = &#123;greeting: &#123;&#125;&#125;;</span><br><span class="line">&gt;&gt;</span><br><span class="line">Module &#123;</span><br><span class="line">  id: &#x27;.&#x27;,</span><br><span class="line">  exports: &#123; greeting: &#123;&#125; &#125;,</span><br><span class="line">  parent: null,</span><br><span class="line">  filename: &#x27;C:\\Users\\qianyan\\Projects\\lesson2\\util.js&#x27;,</span><br><span class="line">  loaded: false,</span><br><span class="line">  children: [],</span><br><span class="line">  paths:</span><br><span class="line">   [ &#x27;C:\\Users\\qianyan\\Projects\\lesson2\\node_modules&#x27;,</span><br><span class="line">     &#x27;C:\\Users\\qianyan\\Projects\\node_modules&#x27;,</span><br><span class="line">     &#x27;C:\\Users\\qianyan\\node_modules&#x27;,</span><br><span class="line">     &#x27;C:\\Users\\node_modules&#x27;,</span><br><span class="line">     &#x27;C:\\node_modules&#x27; ] &#125;</span><br></pre></td></tr></table></figure>
<h3 id="module-initialize发生的时机"><a href="#module-initialize发生的时机" class="headerlink" title="module initialize发生的时机"></a>module initialize发生的时机</h3><p>模块中的代码只会在首次被使用的时候才会执行一次，同时初始化该模块的导出对象，之后导出对象会被缓存到内存当中，供任意使用。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>NVM是Node Version Manager，管理node的版本的工具。使用NVM，可以保证同一个操作系统下，多个不同版本的node得以共存。</li>
<li>node作为javascript的解析器，可以在终端下进入交互式模式(repl read-eval-print-loop)，很方便快速地反馈我们程序的结果。</li>
<li>nodeJS的模块系统实现了CMD标准，即<a target="_blank" rel="noopener" href="http://wiki.commonjs.org/">CommonJS Module Definition</a>标准；而对于运行在浏览器上的javascript的模块化，因为需要异步加载js文件，所以由require.js实现了AMD (Asynchronous Module Definition)标准</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CMD</span><br><span class="line">require(&#x27;express&#x27;)</span><br><span class="line"></span><br><span class="line">AMD</span><br><span class="line">define(&quot;alpha&quot;, [&quot;require&quot;, &quot;exports&quot;, &quot;beta&quot;],</span><br><span class="line">function (require, exports, beta) &#123;</span><br><span class="line">       exports.verb = function() &#123;</span><br><span class="line">           return beta.verb();</span><br><span class="line">           //Or:</span><br><span class="line">           return require(&quot;beta&quot;).verb();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>是否可以使用<code>require(&#39;./data.json&#39;</code>)将json文件引入到我们的程序当中呢？</li>
<li>有两个js文件同时引入了<code>data.json</code>，先执行a.js，后执行b.js。下面的程序会输出什么？<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//data.json</span><br><span class="line">&#123;&quot;hello&quot;: &quot;world&quot;&#125;</span><br><span class="line"></span><br><span class="line">//a.js</span><br><span class="line">var data = require(&#x27;./data.json&#x27;);</span><br><span class="line">data = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">//b.js</span><br><span class="line">var data = require(&#x27;./data.json&#x27;);</span><br><span class="line">console.log(data)</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="代码组织"><a href="#代码组织" class="headerlink" title="代码组织"></a>代码组织</h2><h3 id="模块解析路径"><a href="#模块解析路径" class="headerlink" title="模块解析路径"></a>模块解析路径</h3><h4 id="node-modules"><a href="#node-modules" class="headerlink" title="node_modules"></a>node_modules</h4><p>不想直接require文件路径名，因为这样一旦所依赖的文件路径发生变化，牵扯的文件会很多。所以我们需要一个约定的根目录。这个根目录就是<code>node_modules</code><br>以这个文件的路径为例：<code>C:\\Users\\qianyan\\Projects\\lesson2\\util.js</code>，node搜索的路径如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">paths:</span><br><span class="line">  [ &#x27;C:\\Users\\qianyan\\Projects\\lesson2\\node_modules&#x27;,</span><br><span class="line">    &#x27;C:\\Users\\qianyan\\Projects\\node_modules&#x27;,</span><br><span class="line">    &#x27;C:\\Users\\qianyan\\node_modules&#x27;,</span><br><span class="line">    &#x27;C:\\Users\\node_modules&#x27;,</span><br><span class="line">    &#x27;C:\\node_modules&#x27; ]</span><br></pre></td></tr></table></figure>
<h4 id="NODE-PATH"><a href="#NODE-PATH" class="headerlink" title="NODE_PATH"></a>NODE_PATH</h4><p>我们知道java中依赖包的搜索路径是通过classpath这个JVM的参数控制的。其实node也有这样的变量提供支持。这个变量就是<code>NODE_PATH</code><br>windows下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cmd</span><br><span class="line">set NODE_PATH=&quot;your_path&quot;</span><br><span class="line">powershell</span><br><span class="line">env:NODE_PATH=&quot;your_path&quot;</span><br></pre></td></tr></table></figure>
<p>NODE_PATH中的路径被遍历是发生在从项目的根位置递归搜寻 node_modules 目录，直到文件系统根目录的node_modules，如果还没有查找到指定模块的话，就会去 NODE_PATH中注册的路径中查找。</p>
<h4 id="内置模块"><a href="#内置模块" class="headerlink" title="内置模块"></a>内置模块</h4><p>如<code>fs</code>, <code>http</code>等，不做路径解析就直接使用其导出对象<code>require(&#39;fs&#39;)</code>, <code>require(&#39;http&#39;)</code></p>
<h3 id="Package（包）"><a href="#Package（包）" class="headerlink" title="Package（包）"></a>Package（包）</h3><p>包就是封装多个子模块，同时提供入口的大模块。这个大模块的功能是内聚的。举个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\USERS\QIANYAN\PROJECTS\LESSON2</span><br><span class="line">└───plane</span><br><span class="line">        body.js</span><br><span class="line">        engine.js</span><br><span class="line">        main.js</span><br><span class="line">        wing.js</span><br></pre></td></tr></table></figure>
<p>其中plane目录定义了一个包，其中包含了4个子模块。<code>main.js</code>作为入口模块，如下：</p>
<figure class="highlight javascript"><figcaption><span>main.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> engine = <span class="built_in">require</span>(<span class="string">&#x27;./engine&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> wing = <span class="built_in">require</span>(<span class="string">&#x27;./wing&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> body = <span class="built_in">require</span>(<span class="string">&#x27;./body&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">plane</span> = &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;747&quot;</span>,</span><br><span class="line">    <span class="attr">engine</span>: engine,</span><br><span class="line">    <span class="attr">wing</span>: wing,</span><br><span class="line">    <span class="attr">body</span>: body</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他模块需要使用plane这个包时，得使用<code>require(&#39;./plane/main&#39;)</code>才行。不过，这里有两种方法可以省去写文件名<code>main</code>。</p>
<h4 id="1-index-js"><a href="#1-index-js" class="headerlink" title="1. index.js"></a>1. index.js</h4><p>这里有个约定，如果将main.js重命名成index.js，那么就不需要写出文件名字，直接<code>require(&#39;./plane&#39;)</code>就可以了。</p>
<p>这样模块显得更内聚，和Clojure中的<code>(use namespace)</code>的用法类似。以下两条语句等价。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./plane/main&#x27;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./plane&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="2-package-json"><a href="#2-package-json" class="headerlink" title="2. package.json"></a>2. package.json</h4><p>如果想自定义入口模块的文件名和存放位置，就需要在包目录下包含一个package.json文件，并在其中指定入口模块的路径。上例中的模块可以重构如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">C:\USERS\QIANYAN\PROJECTS\LESSON2\PLANE</span><br><span class="line">│   package.json //包描述文件</span><br><span class="line">│</span><br><span class="line">├───doc //文档</span><br><span class="line">├───lib //API文件</span><br><span class="line">│       body.js</span><br><span class="line">│       engine.js</span><br><span class="line">│       main.js</span><br><span class="line">│       wing.js</span><br><span class="line">│</span><br><span class="line">└───tests //测试文件</span><br></pre></td></tr></table></figure>
<p>其中package.json内容如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;plane&quot;</span>,</span><br><span class="line">    <span class="string">&quot;main&quot;</span>: <span class="string">&quot;./lib/main.js&quot;</span> <span class="comment">//这里入口文件的名字可以按自己的喜好更改</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如此一来，就同样可以使用require(‘.&#x2F;lib&#x2F;plane’)的方式加载模块。NodeJS会根据包目录下的package.json找到入口模块所在位置。</p>
<hr>
<h3 id="命令行程序"><a href="#命令行程序" class="headerlink" title="命令行程序"></a>命令行程序</h3><p>node.js的程序是跑在命令行之中的，命令行程序长得类似<code>cmd --name=value</code>这样的形式。</p>
<h4 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h4><p>在windows下创建一个<code>greeting</code>程序的目录，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\USERS\QIANYAN\PROJECTS\LESSON2\GREETING</span><br><span class="line">│   package.json</span><br><span class="line">│   README.md</span><br><span class="line">│</span><br><span class="line">├───bin</span><br><span class="line">│       greeting.cmd</span><br><span class="line">│</span><br><span class="line">├───doc</span><br><span class="line">├───lib</span><br><span class="line">│       index.js</span><br><span class="line">│</span><br><span class="line">├───node_modules</span><br><span class="line">└───tests</span><br></pre></td></tr></table></figure>
<p>package.json的内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;greeting&quot;,</span><br><span class="line">  &quot;version&quot;: &quot;1.0.0&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;say hi to everyone&quot;,</span><br><span class="line">  &quot;main&quot;: &quot;lib/index.js&quot;,</span><br><span class="line">  &quot;directories&quot;: &#123;</span><br><span class="line">    &quot;doc&quot;: &quot;doc&quot;,</span><br><span class="line">    &quot;test&quot;: &quot;tests&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;bin&quot;: &#123;</span><br><span class="line">    &quot;greeting&quot;: &quot;bin/greeting.cmd&quot;  </span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;test&quot;: &quot;node test&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;author&quot;: &quot;lambeta&quot;,</span><br><span class="line">  &quot;license&quot;: &quot;MIT&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在windows下，如果我们想要实现<em>cmd –name&#x3D;value</em>的效果，就必须使用cmd后缀的文件，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//greeting.cmd</span><br><span class="line">@node &quot;lib/index.js&quot; %*</span><br></pre></td></tr></table></figure>
<p>我们实现一个接受人的名字作为参数的命令行程序<em>lib&#x2F;index.js</em>，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello,&#x27;</span>, process.<span class="property">argv</span>[<span class="number">2</span>]);</span><br></pre></td></tr></table></figure>
<p>到这里，可以直接这样运行<code>./bin/greeting.cmd lambeta</code>，输出<code>hello, lambeta</code>。不过，还是没有预期的样子。</p>
<h4 id="npm-link"><a href="#npm-link" class="headerlink" title="npm link"></a>npm link</h4><p>我们再运行一条npm的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; npm link</span><br><span class="line">C:\Program Files\nodejs\greeting -&gt; C:\Program Files\nodejs\node_modules\greeting\bin\greeting.cmd</span><br><span class="line">C:\Program Files\nodejs\node_modules\greeting -&gt; C:\Users\qianyan\Projects\lesson2\greeting</span><br></pre></td></tr></table></figure>
<p>这条命令帮助我们设置两个软链接。第一个链接使得我们可以直接运行<em>greeting lambeta</em>；第二个则在全局范围内，其他的模块得以引入greeting这个包。<br>此时，我们可以直接使用<em>greeting lambeta</em>来运行程序了</p>
<h4 id="依赖第三方库"><a href="#依赖第三方库" class="headerlink" title="依赖第三方库"></a>依赖第三方库</h4><p>为了实现真正的<em>cmd –name&#x3D;value</em>，我们使用一个第三方库<code>yargs</code>。</p>
<ol>
<li>安装yargs: <em>npm install yargs –save</em></li>
<li>修改index.js文件如下<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> argv = <span class="built_in">require</span>(<span class="string">&#x27;yargs&#x27;</span>).<span class="property">argv</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello,&#x27;</span>, argv.<span class="property">name</span>);</span><br></pre></td></tr></table></figure></li>
<li>运行<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; greeting --name=lambeta</span><br><span class="line">  hello, lambeta</span><br></pre></td></tr></table></figure></li>
</ol>
<p>最后再来看看一个完整的node.js的整体结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\USERS\QIANYAN\PROJECTS\LESSON2\GREETING</span><br><span class="line">│   package.json //包描述文件</span><br><span class="line">│   README.md    //说明文件</span><br><span class="line">│</span><br><span class="line">├───bin</span><br><span class="line">│       greeting.cmd //命令行相关代码</span><br><span class="line">│</span><br><span class="line">├───doc   //文档</span><br><span class="line">├───lib   //API代码</span><br><span class="line">│       index.js</span><br><span class="line">│</span><br><span class="line">├───node_modules //第三方依赖</span><br><span class="line">└───tests //测试</span><br></pre></td></tr></table></figure>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><ul>
<li>按照标准目录结构</li>
<li>分模块管理项目</li>
<li>使用NPM管理第三方模块和命令行程序</li>
<li>使用package.json描述项目信息和依赖</li>
</ul>
<h2 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h2><ul>
<li>下载一个第三方命令行程序到本地<code>npm install es-checker</code>，不要使用<code>-g</code>参数，如何运行起来这个程序？</li>
<li>了解一下<a target="_blank" rel="noopener" href="https://docs.npmjs.com/misc/scripts">npm scripts</a>，在上题的基础上，添加包含下面的内容的package.json，运行<code>npm test</code>。思考这样做是否可行？<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//package.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;scripts&quot;: &#123;</span><br><span class="line">        &quot;test&quot;: &quot;es-checker&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h2><p>前置条件：<a target="_blank" rel="noopener" href="https://zealdocs.org/">安装Windows上的离线文档工具</a></p>
<h3 id="文件操作相关的API"><a href="#文件操作相关的API" class="headerlink" title="文件操作相关的API"></a>文件操作相关的API</h3><h4 id="buffer对象（数据块）"><a href="#buffer对象（数据块）" class="headerlink" title="buffer对象（数据块）"></a>buffer对象（数据块）</h4><p>Javascript语言本身只支持字符串操作，没有提供针对二进制数据流的操作。NodeJS提供了一个与<code>String</code>对等的全局对象<code>Buffer</code>. Buffer和整数的数组很类似，但是它是固定长度，一旦创建就不能修改。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var bin = new Buffer(&#x27;hello&#x27;, &#x27;utf8&#x27;);// &lt;Buffer 68 65 6c 6c 6f&gt;</span><br><span class="line">bin.toString(); //&#x27;hello&#x27;</span><br><span class="line">var bin = new Buffer([ 0x68, 0x65, 0x6c, 0x6c, 0x6f ]);</span><br><span class="line">bin.toString(); //&#x27;hello&#x27;</span><br><span class="line"></span><br><span class="line">var bin = new Buffer([ 0x68, 0x65, 0x6c, 0x6c, 0x6f ]);</span><br><span class="line">var dump = new Buffer(bin.length);</span><br><span class="line">bin.copy(dump);</span><br></pre></td></tr></table></figure>
<h4 id="stream模块（数据流）"><a href="#stream模块（数据流）" class="headerlink" title="stream模块（数据流）"></a>stream模块（数据流）</h4><p>Stream是一个抽象的接口，所有的stream都是EventEmitter的实例。<br>当内存中无法一次装下需要处理的数据时，或者一边读取一边处理更加高效时，我们就需要用到数据流。NodeJS中通过各种Stream来提供对数据流的操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&#x27;fs&#x27;);</span><br><span class="line">var readStream = fs.createReadStream(&#x27;README.md&#x27;); //readStream是EventEmitter的实例。</span><br><span class="line"></span><br><span class="line">readStream.on(&#x27;data&#x27;, function(chunk) &#123;</span><br><span class="line">   console.log(chunk.toString());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">readStream.on(&#x27;end&#x27;, function() &#123;</span><br><span class="line">   console.log(&#x27;end.&#x27;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="fs模块"><a href="#fs模块" class="headerlink" title="fs模块"></a>fs模块</h4><p>NodeJS通过<code>fs</code>内置模块提供对文件的操作。<code>fs</code>模块提供的API基本可以分为以下三类：</p>
<ul>
<li><p>文件属性读写。<br>其中常用的有fs.stat、fs.chmod、fs.chown等等。</p>
</li>
<li><p>文件内容读写。<br>其中常用的有fs.readFile、fs.readdir、fs.writeFile、fs.mkdir等等。</p>
</li>
<li><p>底层文件操作。<br>其中常用的有fs.open、fs.read、fs.write、fs.close等等。</p>
</li>
</ul>
<p>我们可以通过<code>require(&#39;fs&#39;)</code>来引用这个模块，而且该模块下的每个方法都有同步和异步的形式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// read sync</span><br><span class="line">var file = fs.readFileSync(process.cwd() + &#x27;/README.md&#x27;, &#x27;utf8&#x27;);</span><br><span class="line">console.log(file);</span><br><span class="line"></span><br><span class="line">// read async</span><br><span class="line">fs.readFile(process.cwd() + &#x27;/README.md&#x27;, &#x27;utf8&#x27;, function (err, data) &#123;</span><br><span class="line">    if(err) &#123;</span><br><span class="line">        console.log(err);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    console.log(data)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>一段遍历当前目录的程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&#x27;fs&#x27;);</span><br><span class="line">var p = require(&#x27;path&#x27;);</span><br><span class="line"></span><br><span class="line">function recursiveRead(path) &#123;</span><br><span class="line">    if(fs.statSync(path).isFile()) &#123;</span><br><span class="line">        console.log(&quot;File:&quot;, path);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        fs.readdir(path, function(err, files) &#123;</span><br><span class="line">            if(err) &#123;</span><br><span class="line">                console.log(err);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            files.forEach(function(file) &#123;</span><br><span class="line">                var absPath = p.join(path, file);</span><br><span class="line">                if(fs.statSync(absPath).isFile()) &#123;</span><br><span class="line">                    console.log(&quot;File:&quot;, absPath);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    console.log(&quot;Directory:&quot;, absPath);</span><br><span class="line">                    recursiveRead(absPath);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">recursiveRead(__dirname); //全局的对象__dirname，当前脚本执行的目录。</span><br></pre></td></tr></table></figure>

<h4 id="path模块"><a href="#path模块" class="headerlink" title="path模块"></a>path模块</h4><p>和<code>java</code>类似，NodeJS提供path来简化对文件路径的操作。</p>
<ul>
<li>path.normalize<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var path = require(&#x27;path&#x27;);</span><br><span class="line">path.normalize(&#x27;foo/bar/..&#x27;); // &#x27;foo&#x27;</span><br></pre></td></tr></table></figure></li>
<li>path.join &amp; path.sep<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path.join(&#x27;foo&#x27;, &#x27;/bar/&#x27;, &#x27;/baz&#x27;, &#x27;par/&#x27;) // &#x27;foo\\bar\\baz\\par\\&#x27;</span><br><span class="line">path.sep // &#x27;\\&#x27;</span><br></pre></td></tr></table></figure></li>
<li>path.extname<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path.extname(&#x27;node.js&#x27;) //&#x27;.js&#x27;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h2><ul>
<li><code>Buffer</code>提供了NodeJS操作二进制的机制；</li>
<li><code>Stream</code>是一个抽象的接口，每种stream都是EventEmitter的实例。当我们在读取大文件时，可以使用数据流一边读取，一边处理；</li>
<li><code>fs</code>提供了文件属性读写，内容读写以及底层文件操作。</li>
<li>不要使用字符串拼接，使用<code>path</code>简化操作</li>
</ul>
<h2 id="问题-2"><a href="#问题-2" class="headerlink" title="问题"></a>问题</h2><ul>
<li>使用<code>fs</code>的API创建一个copy的函数；</li>
<li>NodeJS对文本编码的处理；</li>
<li>使用第三方包<code>findit</code>重写遍历当前目录的程序。</li>
</ul>
<hr>
<h2 id="网络操作"><a href="#网络操作" class="headerlink" title="网络操作"></a>网络操作</h2><h3 id="简单的HTTP服务器"><a href="#简单的HTTP服务器" class="headerlink" title="简单的HTTP服务器"></a>简单的HTTP服务器</h3><p>使用<code>http</code>实现一个简单的HTTP服务器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var http = require(&#x27;http&#x27;);</span><br><span class="line">http.createServer(function(req, res) &#123;</span><br><span class="line">    res.writeHead(200, &#123;&#x27;Content-type&#x27;: &#x27;text/plain&#x27;&#125;);</span><br><span class="line">    res.end(&#x27;Hello Node.js&#x27;);</span><br><span class="line">&#125;).listen(12306);</span><br></pre></td></tr></table></figure>
<h3 id="http模块"><a href="#http模块" class="headerlink" title="http模块"></a>http模块</h3><p>http模块提供两种使用方式：</p>
<ul>
<li>作为服务端使用时，创建一个HTTP服务器，监听HTTP客户端请求并返回响应；</li>
<li>作为客户端使用时，发起一个HTTP客户端请求，获取服务端响应。</li>
</ul>
<p>先创建一个HTTP服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//http-server.js</span><br><span class="line">var http = require(&#x27;http&#x27;);</span><br><span class="line"></span><br><span class="line">http.createServer(function(req, res) &#123;</span><br><span class="line">   var body = [];</span><br><span class="line">   res.writeHead(200, &#123;&#x27;Content-type&#x27;: &#x27;text/plain&#x27;&#125;);</span><br><span class="line"></span><br><span class="line">   req.on(&#x27;data&#x27;, function(chunk) &#123;</span><br><span class="line">      res.write(chunk);</span><br><span class="line">      body.push(chunk);</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   req.on(&#x27;end&#x27;, function() &#123;</span><br><span class="line">      body = Buffer.concat(body);</span><br><span class="line">      console.log(body.toString());</span><br><span class="line">      res.end();</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;).listen(12306);</span><br></pre></td></tr></table></figure>
<p>再创建一个HTTP客户端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//http-client.js</span><br><span class="line">var http = require(&#x27;http&#x27;);</span><br><span class="line">var options = &#123;hostname: &#x27;localhost&#x27;,</span><br><span class="line">    port: 12306,</span><br><span class="line">    method: &#x27;POST&#x27;,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        &#x27;Content-type&#x27;: &#x27;text/plain&#x27;</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">var req = http.request(options, function(res) &#123;</span><br><span class="line">    res.on(&#x27;data&#x27;, function(chunk) &#123;</span><br><span class="line">       console.log(&#x27;res:&#x27;, chunk.toString());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.write(&#x27;hello world&#x27;);</span><br><span class="line">req.end();</span><br></pre></td></tr></table></figure>
<h3 id="url模块"><a href="#url模块" class="headerlink" title="url模块"></a>url模块</h3><ul>
<li>parse<br>使用url解析成URL对象<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; url.parse(&#x27;http://user:pass@host.com:8080/p/a/t/h?query=string#hash</span><br><span class="line">Url &#123;</span><br><span class="line">  protocol: &#x27;http:&#x27;,</span><br><span class="line">  slashes: true,</span><br><span class="line">  auth: &#x27;user:pass&#x27;,</span><br><span class="line">  host: &#x27;host.com:8080&#x27;,</span><br><span class="line">  port: &#x27;8080&#x27;,</span><br><span class="line">  hostname: &#x27;host.com&#x27;,</span><br><span class="line">  hash: &#x27;#hash&#x27;,</span><br><span class="line">  search: &#x27;?query=string&#x27;,</span><br><span class="line">  query: &#x27;query=string&#x27;,</span><br><span class="line">  pathname: &#x27;/p/a/t/h&#x27;,</span><br><span class="line">  path: &#x27;/p/a/t/h?query=string&#x27;,</span><br><span class="line">  href: &#x27;http://user:pass@host.com:8080/p/a/t/h?query=string#hash&#x27; &#125;</span><br></pre></td></tr></table></figure></li>
<li>format<br>format方法允许将一个URL对象转换为URL字符串<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; url.format(&#123;</span><br><span class="line">     protocol: &#x27;http:&#x27;,</span><br><span class="line">     host: &#x27;www.example.com&#x27;,</span><br><span class="line">     pathname: &#x27;/p/a/t/h&#x27;,</span><br><span class="line">     search: &#x27;query=string&#x27;</span><br><span class="line"> &#125;);</span><br><span class="line">//&#x27;http://www.example.com/p/a/t/h?query=string&#x27;</span><br></pre></td></tr></table></figure></li>
<li>resolve<br>resolve方法拼接两个URL<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; url.resolve(&#x27;http://www.baid.com/path&#x27;, &#x27;../www.google.com&#x27;)</span><br><span class="line">&#x27;http://www.baid.com/www.google.com&#x27;</span><br><span class="line">&gt; url.resolve(&#x27;http://example.com/one&#x27;, &#x27;/two&#x27;)</span><br><span class="line">&#x27;http://example.com/two&#x27;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="querystring"><a href="#querystring" class="headerlink" title="querystring"></a>querystring</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; querystring.parse(&#x27;foo=bar&amp;baz=qux&amp;baz=quux&amp;corge&#x27;);</span><br><span class="line">&#123; foo: &#x27;bar&#x27;, baz: [ &#x27;qux&#x27;, &#x27;quux&#x27; ], corge: &#x27;&#x27; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h2><ul>
<li>http模块支持服务端模式和客户端模式两种使用方式；</li>
<li>request和response对象除了用于读写头数据外，可以当作数据流来操作；</li>
<li>url.parse方法加上request.url属性是处理HTTP请求时的固定搭配。</li>
</ul>
<h2 id="问题-3"><a href="#问题-3" class="headerlink" title="问题"></a>问题</h2><ul>
<li>http模块和https模块的区别？</li>
<li>如何创建一个https服务器？</li>
</ul>
<hr>
<h2 id="进程操作"><a href="#进程操作" class="headerlink" title="进程操作"></a>进程操作</h2><h3 id="API一览"><a href="#API一览" class="headerlink" title="API一览"></a>API一览</h3><h4 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h4><p><code>process</code>是一个全局的对象，可以在node环境中随处访问。并且它是EventEmitter的实例。<br>一个进程对象里头到底包含些什么属性？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pid</span><br><span class="line">stdio</span><br><span class="line">argv</span><br><span class="line">env</span><br></pre></td></tr></table></figure>
<p>只在POSIX平台支持的函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getuid</span><br><span class="line">getgid</span><br><span class="line">geteuid</span><br><span class="line">getegid</span><br></pre></td></tr></table></figure>
<p>进程ID、标准输入输出以及错误流、启动进程的参数、运行环境、运行时权限。</p>
<h5 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h5><ul>
<li><p>获取命令行参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// index.js</span><br><span class="line">console.log(process.argv);</span><br><span class="line"></span><br><span class="line">&gt; node index.js hello</span><br><span class="line">[ &#x27;C:\\Program Files\\nodejs\\node.exe&#x27;, //node的执行路径</span><br><span class="line">  &#x27;C:\\Users\\qianyan\\Projects\\lesson5\\index.js&#x27;, //文件路径</span><br><span class="line">  &#x27;hello&#x27; ] //参数</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>一般获取参数的写法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process.argv.splice(2)</span><br></pre></td></tr></table></figure></li>
<li><p>退出程序<br>类似Java中的<code>System.exit(1)</code>，当我们捕获一个异常，同时觉得程序需要立即停止时，就执行<code>process.exit(1)</code>来表示非正常退出。</p>
</li>
<li><p>控制输入和输出<br><code>stdin</code>是只读流，而<code>stdout</code>和<code>stderr</code>都是只写流。<code>console.log</code>等价于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">console.log = (msg) =&gt; &#123;</span><br><span class="line">  process.stdout.write(`$&#123;msg&#125;\n`);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="Child-Process"><a href="#Child-Process" class="headerlink" title="Child Process"></a>Child Process</h4><p><code>child_process</code>是一个内置模块，可以创建和控制子进程。该模块的主要功能都是<code>child_process.spawn()</code>函数提供的。其余诸如<code>exec</code>, <code>fork</code>, <code>execFile</code>等都是对<code>spawn()</code>进行的封装。</p>
<h5 id="应用场景-1"><a href="#应用场景-1" class="headerlink" title="应用场景"></a>应用场景</h5><ul>
<li>创建子进程</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//(command[, args][, options])</span></span><br><span class="line"><span class="keyword">const</span> spawn = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="property">spawn</span>;</span><br><span class="line"><span class="keyword">const</span> echo = <span class="title function_">spawn</span>(<span class="string">&#x27;cmd&#x27;</span>, [<span class="string">&#x27;/c&#x27;</span>, <span class="string">&#x27;env&#x27;</span>], &#123;<span class="attr">env</span>: process.<span class="property">env</span>&#125;);<span class="comment">//尝试设置&#123;env: &#123;&#125;&#125;，观察结果。</span></span><br><span class="line"></span><br><span class="line">echo.<span class="property">stdout</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`stdout: <span class="subst">$&#123;data&#125;</span>`</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>第一参数是可执行文件的路径，第二参数是数组对应可执行文件接收的参数，第三参数用于配置子进程运行的环境和行为。</p>
<ul>
<li>进程间通信<br>如果父子进程都是Node.js的进程，那么就可以通过IPC通道通信。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//parent.js</span></span><br><span class="line"><span class="keyword">const</span> spawn = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="property">spawn</span>;</span><br><span class="line"><span class="keyword">const</span> child = <span class="title function_">spawn</span>(<span class="string">&#x27;node&#x27;</span>, [<span class="string">&#x27;child.js&#x27;</span>], &#123;</span><br><span class="line">    <span class="attr">stdio</span>: [process.<span class="property">stdin</span>, process.<span class="property">stdout</span>, process.<span class="property">stderr</span>, <span class="string">&#x27;ipc&#x27;</span>]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">child.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">msg</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;parent:&#x27;</span>, msg);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">child.<span class="title function_">send</span>(&#123;<span class="attr">hello</span>: <span class="string">&#x27;world&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//child.js</span></span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">msg</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;child:&#x27;</span>, msg);</span><br><span class="line">    msg.<span class="property">hello</span> = msg.<span class="property">hello</span>.<span class="title function_">toUpperCase</span>();</span><br><span class="line">    process.<span class="title function_">send</span>(msg);</span><br><span class="line">&#125;)</span><br><span class="line">=&gt;</span><br><span class="line"><span class="attr">child</span>: &#123; <span class="attr">hello</span>: <span class="string">&#x27;world&#x27;</span> &#125;</span><br><span class="line"><span class="attr">parent</span>: &#123; <span class="attr">hello</span>: <span class="string">&#x27;WORLD&#x27;</span> &#125;</span><br></pre></td></tr></table></figure>
<p>父进程在创建子进程的时候，使用了<code>options.stdio</code>的<code>ipc</code>额外开辟了一条通道，之后开始监听子进程的<code>message</code>事件来接收子进程的消息，同时通过<code>send</code>方法给子进程发送消息。子进程则通过<code>process</code>对象监听来自父进程的消息，并通过<code>process.send</code>方法向父进程发送消息。</p>
<h4 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h4><p>单个实例的Node.js运行在单独的进程当中。但是我们有时候可能需要利用多核处理器的优势，在每个单独的核上跑一个Node.js的进程。<br><code>Cluster</code>就是创造出来简化多进程服务程序开发的，让每一个核上面运行一个工作进程，并统一通过主进程监听端口和分发请求。</p>
<h5 id="应用场景-2"><a href="#应用场景-2" class="headerlink" title="应用场景"></a>应用场景</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cluster = <span class="built_in">require</span>(<span class="string">&#x27;cluster&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> numCPUs = <span class="built_in">require</span>(<span class="string">&#x27;os&#x27;</span>).<span class="title function_">cpus</span>().<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cluster.<span class="property">isMaster</span>) &#123;</span><br><span class="line">  <span class="comment">// Fork workers.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; numCPUs; i++) &#123;</span><br><span class="line">    cluster.<span class="title function_">fork</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cluster.<span class="title function_">on</span>(<span class="string">&#x27;exit&#x27;</span>, <span class="function">(<span class="params">worker, code, signal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`worker <span class="subst">$&#123;worker.process.pid&#125;</span> died`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// Workers can share any TCP connection</span></span><br><span class="line">  <span class="comment">// In this case it is an HTTP server</span></span><br><span class="line">  http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">writeHead</span>(<span class="number">200</span>);</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;hello world\n&#x27;</span>);</span><br><span class="line">  &#125;).<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br><span class="line">&#125;</span><br><span class="line">=&gt;</span><br><span class="line"><span class="variable constant_">NODE_DEBUG</span>=cluster node server.<span class="property">js</span></span><br><span class="line">isMaster</span><br><span class="line">worker</span><br><span class="line">worker</span><br><span class="line">worker</span><br><span class="line">worker</span><br><span class="line">worker</span><br><span class="line">worker</span><br><span class="line">worker</span><br><span class="line">worker</span><br></pre></td></tr></table></figure>
<p>该模块很简单地创建多个共享一个服务端口的子进程，而这些子进程是通过IPC和Master，也即父进程进行信息交互的，可应用于负载均衡。</p>
<h2 id="小结-4"><a href="#小结-4" class="headerlink" title="小结"></a>小结</h2><ul>
<li>使用<code>process</code>对象管理进程</li>
<li>使用<code>child_process</code>对象管理子进程，其最主要的方法就是<code>spawn</code></li>
</ul>
<h2 id="问题-4"><a href="#问题-4" class="headerlink" title="问题"></a>问题</h2><hr>
<h2 id="异步编程"><a href="#异步编程" class="headerlink" title="异步编程"></a>异步编程</h2><p>NodeJS最大的卖点——事件机制和异步IO，开发者需要按照异步的方式去组织代码。</p>
<h3 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h3><p>异步编程的直接体现就是回调函数，但是不是有回调函数，就是异步编程呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sum</span>(<span class="params">arr, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        sum = sum + arr[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">callback</span>(sum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">sum</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>], <span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line">=&gt;</span><br><span class="line"><span class="number">15</span></span><br></pre></td></tr></table></figure>
<p>显然，这个<code>callback</code>还是顺序（同步）执行的。我们知道，JS本身是单线程的，所以不具备多线程并发执行的特点，那么异步从何体现呢？<br>我们再看一段程序：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;world&quot;</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">=&gt;</span><br><span class="line">hello</span><br><span class="line">world</span><br></pre></td></tr></table></figure>
<p>上面的例子先打印出“hello”，然后打印出“world”。看上去好像是<code>setTimeout()</code>另外启动了一个“平行线程”，等待了1秒钟之后，调用回调函数打印“world”。<br>JS中提供了两大类异步函数，一种是计时函数，如：<code>setTimeout</code>和<code>setInterval</code>。另外一类是I&#x2F;O异步函数，如：<code>fs.readFile</code>。</p>
<p>但是JS是单线程的。也就是说如果“主”线程一直处于忙碌状态，即使“平行”线程完成工作，通知“主”线程调用它的回调函数，也会等到“主”线程空闲了才能真正去调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;waiting time: &quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>() - t);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">new</span> <span class="title class_">Date</span>() - start &lt; <span class="number">1000</span>);</span><br><span class="line">=&gt;</span><br><span class="line">waiting <span class="attr">time</span>: <span class="number">1094</span> <span class="comment">//大于我们设置的1000毫秒</span></span><br></pre></td></tr></table></figure>

<h3 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h3><p>我们分别使用同步和异步实现一个函数，判断当前目录下的文件是否都是File，最终程序返回一个布尔值的数组，如：<code>[true, false]</code><br>当前目录文件结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|_async.js</span><br><span class="line">|_sync.js</span><br><span class="line">|_ dir/</span><br></pre></td></tr></table></figure>
<h4 id="比较中学习"><a href="#比较中学习" class="headerlink" title="比较中学习"></a>比较中学习</h4><ul>
<li>同步方式下</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dirs = fs.<span class="title function_">readdirSync</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> areFiles = dirs.<span class="title function_">map</span>(<span class="function">(<span class="params">dirName</span>) =&gt;</span> &#123;    </span><br><span class="line">    <span class="keyword">return</span> fs.<span class="title function_">statSync</span>(path.<span class="title function_">join</span>(<span class="string">&#x27;.&#x27;</span>, dirName)).<span class="title function_">isFile</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(areFiles);</span><br><span class="line">=&gt; [<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">true</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>异步方式下<br><em>失败的尝试</em></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">readdir</span>(<span class="string">&#x27;.&#x27;</span>, <span class="function">(<span class="params">err, dirs</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> areFiles = [];</span><br><span class="line"></span><br><span class="line">    dirs.<span class="title function_">forEach</span>(<span class="function">(<span class="params">dirName</span>) =&gt;</span> &#123;  </span><br><span class="line">        fs.<span class="title function_">stat</span>(path.<span class="title function_">join</span>(<span class="string">&#x27;.&#x27;</span>, dirName), <span class="function">(<span class="params">err, stat</span>) =&gt;</span> &#123;</span><br><span class="line">            areFiles.<span class="title function_">push</span>(stat.<span class="title function_">isFile</span>());</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(areFiles);</span><br><span class="line">&#125;);</span><br><span class="line">=&gt; [] <span class="comment">//思考为何是空数组？</span></span><br></pre></td></tr></table></figure>
<p><em>成功的尝试</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">readdir</span>(<span class="string">&#x27;.&#x27;</span>, <span class="function">(<span class="params">err, dirs</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> areFiles = [];</span><br><span class="line"></span><br><span class="line">    dirs.<span class="title function_">forEach</span>(<span class="function">(<span class="params">dirName</span>) =&gt;</span> &#123;  </span><br><span class="line">        fs.<span class="title function_">stat</span>(path.<span class="title function_">join</span>(<span class="string">&#x27;.&#x27;</span>, dirName), <span class="function">(<span class="params">err, stat</span>) =&gt;</span> &#123;</span><br><span class="line">            areFiles.<span class="title function_">push</span>(stat.<span class="title function_">isFile</span>());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(areFiles.<span class="property">length</span> == dirs.<span class="property">length</span>) &#123; <span class="comment">//使用标志来位判断所有的回调都已经调用完毕</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(areFiles);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">=&gt;[ <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">false</span> ] or [<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">true</span>]</span><br></pre></td></tr></table></figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ol>
<li>同步方法顺序取返回值，而异步方法总是在回调函数的取返回值</li>
<li>循环遍历中调用同步方法很容易，但是同样地在异步方法中，需要使用<strong>标志位</strong>来判断是否所有回调函数都已经调用完毕</li>
<li>异步函数的执行回调是无序的</li>
</ol>
<h3 id="数组的串行处理"><a href="#数组的串行处理" class="headerlink" title="数组的串行处理"></a>数组的串行处理</h3><p>我们看到上个例子里的异步的写法，最后的返回结果其实是无序的。使用标志位只能保证数组中的所有数据对应的回调函数都得以执行，但不能保证哪个回调函数先返回。要想顺序执行，那么必须是一个回调函数中包含另一个回调函数。拿上面的例子尝试：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">readdir</span>(<span class="string">&#x27;.&#x27;</span>, <span class="function">(<span class="params">err, dirs</span>) =&gt;</span> &#123;</span><br><span class="line">    (<span class="keyword">function</span> <span class="title function_">iterate</span>(<span class="params">index, areFiles, callback</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(index &lt; dirs.<span class="property">length</span>) &#123;</span><br><span class="line">            fs.<span class="title function_">stat</span>(path.<span class="title function_">join</span>(<span class="string">&#x27;.&#x27;</span>, dirs[index]), <span class="function">(<span class="params">err, stat</span>) =&gt;</span> &#123;</span><br><span class="line">                areFiles.<span class="title function_">push</span>(stat.<span class="title function_">isFile</span>());</span><br><span class="line">                <span class="title function_">iterate</span>(index + <span class="number">1</span>, areFiles, callback);</span><br><span class="line">            &#125;);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="title function_">callback</span>(areFiles);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;(<span class="number">0</span>, [], <span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">    &#125;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="在场景中学习"><a href="#在场景中学习" class="headerlink" title="在场景中学习"></a>在场景中学习</h4><p>假如我们有这样一个场景：有一系列的HTTP请求的URL构成的数组和一个初始值。这些HTTP请求是有依赖的，后一个的执行必须依赖前一个HTTP请求的响应。如果只是两个请求，我们可以很轻松地写出这样的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> urls = [<span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;www.baidu.com&#x27;</span>]; <span class="comment">//多个urls的数组</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> req = http.<span class="title function_">request</span>(<span class="title function_">optionsWithHostname</span>(urls[<span class="number">0</span>]), <span class="function">(<span class="params">res</span>) =&gt;</span> &#123; <span class="comment">//第一次请求</span></span><br><span class="line">    res.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> req2 = http.<span class="title function_">request</span>(<span class="title function_">optionsWithHostname</span>(urls[<span class="number">1</span>]), <span class="function">(<span class="params">res2</span>) =&gt;</span> &#123;  <span class="comment">//第二次请求</span></span><br><span class="line">            res2.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">chunk2</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">//dosometing here...</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        req2.<span class="title function_">write</span>(chunk.<span class="title function_">toString</span>() + <span class="string">&#x27;agian&#x27;</span>);</span><br><span class="line">        req2.<span class="title function_">end</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.<span class="title function_">write</span>(<span class="string">&#x27;hello world&#x27;</span>);</span><br><span class="line">req.<span class="title function_">end</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">optionsWithHostname</span>(<span class="params">hostname</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">hostname</span>: hostname,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">12306</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Content-type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span></span><br><span class="line">    &#125;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但如果是十个或者更多，这样的写法就不好使了。</p>
<p>我们知道异步函数必须在回调中才能使用其返回值，这样会很容易写出类似于<code>&gt;</code>形状的回调套回调的写法。而递归的写法也正好符合这样的形状，所以尝试一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> urls = [<span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;www.baidu.com&#x27;</span>]; <span class="comment">//多个urls的数组</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span> <span class="title function_">next</span>(<span class="params">i, len, initValue, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; len) &#123;</span><br><span class="line">    <span class="comment">// 将http请求过程简化成了async</span></span><br><span class="line">        <span class="title function_">async</span>(urls[i], <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">            <span class="title function_">next</span>(i + <span class="number">1</span>, len, value, callback);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">callback</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;(<span class="number">0</span>, urls.<span class="property">length</span>, <span class="string">&#x27;hello world&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">   <span class="comment">//dosomething here...</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><ul>
<li>在异步函数想要保证执行的顺序，就必须一个回调套一个回调</li>
<li>可以利用递归的写法，在保证执行顺序的同时，处理系列或者不定长度的数据</li>
</ul>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><h4 id="在比较中学习"><a href="#在比较中学习" class="headerlink" title="在比较中学习"></a>在比较中学习</h4><ul>
<li>同步方式下</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//try ... catch ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    x.<span class="title function_">func</span>();</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;I catch you &quot;</span>, err);</span><br><span class="line">&#125;</span><br><span class="line">=&gt; I <span class="keyword">catch</span> you  [<span class="title class_">ReferenceError</span>: x is not defined]</span><br></pre></td></tr></table></figure>

<ul>
<li>异步方式下</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        x.<span class="title function_">func</span>();</span><br><span class="line">    &#125;, <span class="number">0</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;I catch you &quot;</span>, err);</span><br><span class="line">&#125;</span><br><span class="line">=&gt; <span class="attr">C</span>:\<span class="title class_">Users</span>\qianyan\<span class="title class_">Projects</span>\lesson6\exception\<span class="keyword">async</span>.<span class="property">js</span>:<span class="number">5</span></span><br><span class="line">        x.<span class="title function_">func</span>();</span><br><span class="line">        ^</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReferenceError</span>: x is not defined</span><br><span class="line">    at <span class="literal">null</span>.<span class="property">_onTimeout</span> (<span class="attr">C</span>:\<span class="title class_">Users</span>\qianyan\<span class="title class_">Projects</span>\lesson6\exception\<span class="keyword">async</span>.<span class="property">js</span>:<span class="number">5</span>:<span class="number">9</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到，同步方式下异常会沿着代码执行路径一直冒泡，直到遇到第一个try语句时被捕获住。但由于异步函数会打断代码执行路径，异步函数执行过程中以及执行之后产生的异常冒泡到执行路径被打断的位置时，如果一直没有遇到try语句，就作为一个全局异常抛出。</p>
<p>解决方式就是在异常被作为全局异常抛出之前，try-catch住，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        x.<span class="title function_">func</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;I catch you &quot;</span>, err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line">=&gt; I <span class="keyword">catch</span> you  [<span class="title class_">ReferenceError</span>: x is not defined]</span><br></pre></td></tr></table></figure>
<p>这样异常又被捕获了。不妨，对<code>setTimetout</code>做一次封装</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">wrapSetTimeout</span>(<span class="params">fn, callback</span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title function_">callback</span>(<span class="literal">null</span>, <span class="title function_">fn</span>());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="title function_">callback</span>(err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">wrapSetTimeout</span>(<span class="function">() =&gt;</span> &#123;x.<span class="title function_">func</span>()&#125;, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(err) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;I catch you again&quot;</span>, err);</span><br><span class="line">&#125;)</span><br><span class="line">=&gt;I <span class="keyword">catch</span> you again [<span class="title class_">ReferenceError</span>: x is not defined</span><br></pre></td></tr></table></figure>
<p>Node.js的整个异步函数的异常设计都是如此，callback的首个参数都是err。</p>
<h4 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h4><ul>
<li><em>try-catch</em>在同步方式下很有效，但在异步方式下做不到</li>
<li><em>callback</em>首个参数是err，是因为大多数API都遵循了一致的风格</li>
</ul>
<h2 id="小结-5"><a href="#小结-5" class="headerlink" title="小结"></a>小结</h2><ul>
<li>不掌握异步编程就不算学会NodeJS</li>
<li>异步编程依托于回调来实现，而使用回调不一定就是异步编程</li>
<li>异步编程下的函数间数据传递、数组遍历和异常处理与同步编程有很大差别</li>
</ul>
<hr>
<p>参考链接<br>[1] <a target="_blank" rel="noopener" href="https://nqdeng.github.io/7-days-nodejs/">七天学会NodeJS</a><br>[2] <a target="_blank" rel="noopener" href="http://es6.ruanyifeng.com/">ECMAScript 6入门 - 阮一峰</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Ryan Qian</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>






  <script src="/js/third-party/addtoany.js"></script>

  





</body>
</html>

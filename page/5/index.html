<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"qianyan.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Elegance and familiarity are orthogonal">
<meta property="og:type" content="website">
<meta property="og:title" content="λ">
<meta property="og:url" content="https://qianyan.github.io/page/5/index.html">
<meta property="og:site_name" content="λ">
<meta property="og:description" content="Elegance and familiarity are orthogonal">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="lambeta">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://qianyan.github.io/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>λ</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">λ</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">(conj clojurians me)</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">lambeta</p>
  <div class="site-description" itemprop="description">Elegance and familiarity are orthogonal</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/qianyan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qianyan" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:qianyan.lambda@gmail.com" title="E-Mail → mailto:qianyan.lambda@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://weibo.com/3672207020" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;3672207020" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://x.com/_qian_yan" title="Twitter → https:&#x2F;&#x2F;x.com&#x2F;_qian_yan" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="http://blog.jayfields.com/" title="http:&#x2F;&#x2F;blog.jayfields.com&#x2F;" rel="noopener" target="_blank">Jay Fields</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://aphyr.com/" title="https:&#x2F;&#x2F;aphyr.com" rel="noopener" target="_blank">Aphyr</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://bucharestfp.ro/" title="http:&#x2F;&#x2F;bucharestfp.ro" rel="noopener" target="_blank">Bucharest FP</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://www.yinwang.org/" title="http:&#x2F;&#x2F;www.yinwang.org" rel="noopener" target="_blank">Wangyin</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://blog.rlmflores.me/" title="http:&#x2F;&#x2F;blog.rlmflores.me&#x2F;" rel="noopener" target="_blank">Rodrigo Flores</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://seancorfield.github.io/" title="https:&#x2F;&#x2F;seancorfield.github.io&#x2F;" rel="noopener" target="_blank">Seancorfield</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/07/26/aggregation-composition-IoC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lambeta">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="λ">
      <meta itemprop="description" content="Elegance and familiarity are orthogonal">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | λ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/07/26/aggregation-composition-IoC/" class="post-title-link" itemprop="url">聚合，组合与IoC</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-07-26 22:12:44" itemprop="dateCreated datePublished" datetime="2015-07-26T22:12:44+08:00">2015-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:58:50" itemprop="dateModified" datetime="2016-09-06T22:58:50+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="为什么我们说多用组合，少用继承？"><a href="#为什么我们说多用组合，少用继承？" class="headerlink" title="为什么我们说多用组合，少用继承？"></a>为什么我们说多用组合，少用继承？</h4><hr>
<p>继承具有强耦合(strog coupling)特点。根据里氏替换原则(Liskov Substitution Principle LSP)，基类出现的地方，子类一定能透明地替代。本质上来讲，LSP的这种特性致使基类具有很强的病毒蔓延性(invasive)，因为如何基类设计的不好，会侵蚀所有的子类。举个例子，基类是鸟，同时具有<code>fly</code>这样的方法，子类中如果有鸵鸟或企鹅，就必须继承<code>fly</code>方法，然而这显然是没有意义的。</p>
<p>继承因为强耦合，所以不好测试。举个例子，有一个<code>RemoteXMLFile&lt;Res&gt;</code>基类，它内部有个<code>Res to()</code>方法，旨在把远程的XML文件转换成具体的Response。在我们准备测试<code>to</code>方法的转换逻辑的时候，每个对应子类的测试类里都不得不准备丑陋冗余的<code>XML</code>字面值字符串，尤其是在Java里。之所以这样，是因为无法隔离出一个专门读取<code>XML</code>的抽象屏障，然后使用Mock隔离这层抽象。</p>
<p>组合的好处自然是松耦合(loose coupling)。如果严格遵循依赖倒置原则(Dependency Inversion Principle),那么类本身一定是高能聚，类之间是松耦合的。除此之外，测试起来，各层之间的逻辑清晰明了，易于隔离开来做单元测试(Unit test)。</p>
<h4 id="谈谈聚合和组合的区别"><a href="#谈谈聚合和组合的区别" class="headerlink" title="谈谈聚合和组合的区别"></a>谈谈聚合和组合的区别</h4><hr>
<p>UML里有很多表示关联的线段，有两个关系十分相近，它们是聚合(aggregation)和组合(composition)</p>
<blockquote>
<p>聚合：表示两个对象之间是整体和部分的弱（弱拥有）关系，部分的生命周期可以超越整体。如电脑和鼠标。</p>
</blockquote>
<blockquote>
<p>组合：表示两个对象之间是整体和部分的强（强拥有）关系，部分的生命周期不能超越整体，或者说不能脱离整体而存在。组合关系的“部分”，是不能在整体之间进行共享的。</p>
</blockquote>
<p>以上是网络上的标准解释，应该是没错。但是实践中依然让人困惑不已。汽车和引擎，这个还比较好理解，汽车报废了，引擎还是可以换给别的汽车用的嘛。这就实现了整体之间的共享——聚合无疑。但是值得注意的一点是：从未说过部分的生命周期小于整体，也就是一定是大于或者等于整体的生命周期的。所以千万别和别人争论，引擎报废了，汽车就没用了，因为在程序中一定是某个第三方供应商维护引擎的生命周期，所以引擎和汽车没有相互维持对方生命周期的联系。</p>
<p>但是比较困惑就是这个生命周期理论！IoC容器提供给我们使用的注入方法无非3种，接口注入、构造函数注入、setter方法注入。每一种无不是聚合，因为产生和管理对象的控制权移交到IoC容器了。那我们口口声声的说组合优于继承其实一直都是聚合优于继承。</p>
<p>那是不是说，有了IoC之后，组合就应该消失呢，当然不是的。例如，某个场景里，一个类确实需要分离出一部分职责交给另外一个类，比如Builder，这部分构建实例的职责就可以通过<code>new Builder()</code>的方式组合应用起来。</p>
<figure class="highlight java"><figcaption><span>Builder_Pattern</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="title function_">builder</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Builder</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> Builder &#123;</span><br><span class="line">		<span class="keyword">private</span> String name;</span><br><span class="line">		<span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> Builder <span class="title function_">withName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">			<span class="built_in">this</span>.name = name;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> Builder <span class="title function_">withAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">			<span class="built_in">this</span>.age = age;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> Person <span class="title function_">build</span><span class="params">()</span>&#123;</span><br><span class="line">			<span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">			person.name = name;</span><br><span class="line">			person.age = age;</span><br><span class="line">			<span class="keyword">return</span> person;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> Person.builder().withName(<span class="string">&#x27;Ryan&#x27;</span>).withAge(<span class="number">18</span>).build();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><hr>
<ul>
<li>组合优于继承</li>
<li>因为IoC的存在，上句话得改成聚合优于继承</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/07/18/ThoughtWorks-training/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lambeta">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="λ">
      <meta itemprop="description" content="Elegance and familiarity are orthogonal">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | λ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/07/18/ThoughtWorks-training/" class="post-title-link" itemprop="url">ThoughtWorks training</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-07-18 22:58:17" itemprop="dateCreated datePublished" datetime="2015-07-18T22:58:17+08:00">2015-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-07 06:42:46" itemprop="dateModified" datetime="2016-09-07T06:42:46+08:00">2016-09-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%94%9F%E6%B4%BB/" itemprop="url" rel="index"><span itemprop="name">生活</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ThoughtWorks培训"><a href="#ThoughtWorks培训" class="headerlink" title="ThoughtWorks培训"></a>ThoughtWorks培训</h2><p>在过去的几年里，为了进一步提升ThoughtWorks在业界的影响力，扩张无疑是最为有效的策略。但是，以提供知识流程外包（KPO）作为主要业务的ThoughtWorks，人员的成长变成了业务增长的主要瓶颈。构建“学习型组织”，减少从0(新人)到1(能够提供专业服务)经历的时间变得迫在眉睫。</p>
<h3 id="现状和思考"><a href="#现状和思考" class="headerlink" title="现状和思考"></a>现状和思考</h3><p>对于培训，公司投入了大量的人力物力，我们仍然在思考和摸索什么是最有效的培训方式。如何快速培养一名合格的TWer？在当前招聘策略下，这是一个严峻的问题。由什么来指导我们做“正确“的培训，培训什么、怎么培训以及能不能达到我们的预期这些都尚未可知。</p>
<p>培训是需要反馈周期的，假设首次教学目的(收集受众能力metrics，得出初步结论)，导入教学形式(是讲理论，做实践还是改变习惯)并对当前的产出做出量化评估(学员能力分级)。形成教学目的&gt;教学形式&gt;量化评估&gt;修改当前教学目的&#x2F;下次教学目的的闭环，逐步提高培训的质量和效率。</p>
<p>以学前班的郑大夜校为例，我们已经实践了很多期。不否认地，很多毕业生从中获益颇丰，入了ThoughtWorks的门坎。但是，我们也不得不正视每期结束后褒贬不一的反馈。我们不妨试着剖析反馈背后的问题，从一个个点切入，顺藤摸瓜，反观教学的形式、目的和整个郑大夜校编排的合理性。</p>
<p>首先我们回顾一下本期郑大夜校的阶段安排</p>
<blockquote>
<p>阶段一（毕业到年前）：<br>静态语言阶段</p>
</blockquote>
<blockquote>
<p>阶段二（年后到入职前）：<br>动态语言阶段</p>
</blockquote>
<blockquote>
<p>阶段三（入职后一个月内）：<br>工程实践阶段</p>
</blockquote>
<p>第一阶段主要囊括了Java语言，面向对象编程，设计原则和模式等内容，采取了讲师讲解，学生提问交流和练习的方式；</p>
<p>第二阶段预计采用Javascript语言，应用动态语言的特性重新实现第一阶段的练习。但是事实上，由于培训人员变动等原因，该阶段没有遵循预期计划，而是直接进入了阶段三。</p>
<p>第三阶段，毕业生应用我们平时工作的流程和使用的工具，参与实现一个公司内部的固定资产管理系统，用XR的话来说就是将思想上的东西应用落地。</p>
<p>经过两期的培训，通过毕业生自己的在retro上的反馈以及各位mentor的观察，大体上可以看出毕业生对于第一阶段的培训内容和形式还是很认可的。比较有趣的是培训中就已经有人明确告诉我他自己越来越不会写代码了，这并不是说他能力不行，反而恰恰说明他正在提升，也证实我们培训的目的达到了——对于整个软件行业以及自身能力有清晰的认识。但是必须承认这个例子不是普遍现象，思想上的东西不是一蹴而就的，而且也不能轻松量化以待检验，至少基于当前的教学形式还做不到。</p>
<p>对于第二阶段的培训，学生普通反映引入的工具和框架过多，再加上课程安排松散，每个迭代的目的不甚明确，严重拖延了项目的进度，结果距离完成的目标尚远。而从mentor的角度，理论到实践的落地过程预估得还是过于乐观，不过这个罅隙在和senior dev的结对过程中得到了有效的弥合。</p>
<p>那么问题是我们现在的问题是什么？</p>
<p>在回答这个问题之前，我们先问自己一个问题：</p>
<h4 id="公司想要把毕业生培养成什么人？"><a href="#公司想要把毕业生培养成什么人？" class="headerlink" title="公司想要把毕业生培养成什么人？"></a>公司想要把毕业生培养成什么人？</h4><p>如果答案是一群高级技工。那么我觉得郑大夜校可以不存在，直接找一群senior dev和这些新人pair，手把手教授过程和工具，模仿着码代码。因为基于我们的培训结果，这样的效果是最快最直接的。</p>
<p>若答案是对技术有兴趣、有想法和自主学习的geek。我们就要真的从毕业生角度出发，明确他们缺少什么能力以及如何弥补这些短板。</p>
<p>那么我就以答案二为假设，结合本期培训，展开问题的论述：</p>
<h3 id="第一阶段"><a href="#第一阶段" class="headerlink" title="第一阶段"></a>第一阶段</h3><hr>
<p>验证理解是否到位最好的方式是做练习。问题是一些学生没能完成课上的配套练习，课后也未必补上。这点与课程设置缺少检验环节必然相关，但归根结底是学生缺乏主动性。那什么叫做有主动性？同样是布置POS机的作业，有学生在每一次培训后都会持续改进自己的程序，将新的知识点实现一遍。没人强制这么做，但他做了就是主动。</p>
<p>问题一来了，学生缺乏主动性。该如何解决这一问题？</p>
<blockquote>
<p>第一，我不认为学生缺少学习的动力，那么可能的原因是没有明确的期望和目标。期望和目标应当来自于未来的雇主。<a target="_blank" rel="noopener" href="http://mindhacks.cn/2011/11/04/how-to-interview-a-person-for-two-years/">这里</a>有详细的论述，我就不再赘述。</p>
<p>第二，组内职责轮换。基于本期分组教学的模式，我们已经尝试分派一些职责，效果良好。职责轮换可以让学生因感受到压力而成长。</p>
<p>第三，建立惩罚制度。对于mentor而言，我们并没有有力的手段给予学生压力，我们至多会告诫说若表现不好，会影响其过试用期，但是，这样的压力距离太远。所以建议提前建立因技能等评估维度（后面会详细讨论）严重不足而拒绝offer的制度。</p>
</blockquote>
<p>以上解决问题的建议是基于现有的教学形式提出的。经过和DW的讨论，这一问题或许反映了原有的教学形式本身就存在漏洞。</p>
<blockquote>
<p>我们依旧遵循大学的填鸭式教学模式。要知道没有哪个行业像IT行业这样特殊：没有什么东西不能够（应该）在互联网上学到的。我们何妨换个思路，将以前的课上讲授，课后练习，下次课上检验的方式改变成提前提供课题和所用教学资源，课前学生自己学习，课上解惑的模式。这样可以最大化调动学生自主学习能力，而且学生带着问题上课的效率也远高于直接教学。</p>
</blockquote>
<h3 id="第二阶段"><a href="#第二阶段" class="headerlink" title="第二阶段"></a>第二阶段</h3><hr>
<blockquote>
<p>问题二：我们第二阶段的初衷其实是将第一阶段的思想方面的东西落地。但是大量的工具和框架，这些干扰因素严重分散了学生的注意力，原本检验学生设计和创造能力的时间被极大地缩短了。</p>
<p>问题三：课程安排松散，迭代的目的不清则更为严重。这反映了郑大夜校本身就是不规范的，集中体现在讲师变动频繁、能力良莠不齐，授课内容临时起意，内部的目标不清不楚等。</p>
</blockquote>
<p>针对问题二，我们首先再次明确公司需要的是对技术有兴趣、有想法和自主学习的geek。所以建议不强制学生学习使用工具和框架，尽量选用简单的技术栈，重点检验设计能力。</p>
<p>问题三，这样的现象一直存在，而且涉及的问题有点多，我们慢慢剖析。</p>
<blockquote>
<p>第一，讲师变动频繁、能力良莠本身不应该是个问题，这点可以参考TWU的办学模式。关键还是如何标准化。</p>
<p>第二，授课内容不固定，典型反映在临时找的session上，涉及Agile演化、scrum workshop、业务、QA和Dev技能等各个方面。考虑时间限制和学生的接受能力，对于学前班的郑大夜校而言，这样的scope未免过于庞大。或许需要重新定义郑大夜校的scope，例如：将培养卓越的软件能力提到首位，而将P1和P3的侧重弱化，延迟到TWU和On Board Training上。</p>
<p>第三，相较于TWU，郑大夜校缺少了一个P2P feedback的环节，我们也不知道经过培训什么样的人就满足公司的期望。这就引出了量化指标，可想而知，量化指标不是绝对量，它应该是相对于以前能力模型的增长量。举个例子：从70分上升到80分和从10分上升到60分体现得是后者成长空间更大。量化指标需要根据夜校的scope，划分出能力象限，因为我们能考察的不应该越界。</p>
</blockquote>
<p>孔子曰：温故而知新，可以为师矣。我们做个recap。</p>
<h3 id="教学目的"><a href="#教学目的" class="headerlink" title="教学目的"></a>教学目的</h3><hr>
<ul>
<li>拓宽毕业生的软件开发的视野，明确自身能力</li>
<li>帮助公司尽早筛选可用之才</li>
</ul>
<h3 id="形式"><a href="#形式" class="headerlink" title="形式"></a>形式</h3><hr>
<ul>
<li>颠覆填鸭式教学，自学为主，解惑为辅</li>
<li>分组，轮换职责</li>
<li>入职前惩罚制度</li>
<li>制定标准的教学流程</li>
<li>限定夜校教学范围</li>
<li>制定量化指标</li>
</ul>
<h3 id="量化评估"><a href="#量化评估" class="headerlink" title="量化评估"></a>量化评估</h3><hr>
<ul>
<li>有待确定能力象限。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/07/18/transaction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lambeta">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="λ">
      <meta itemprop="description" content="Elegance and familiarity are orthogonal">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | λ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/07/18/transaction/" class="post-title-link" itemprop="url">Transaction</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-07-18 19:33:38" itemprop="dateCreated datePublished" datetime="2015-07-18T19:33:38+08:00">2015-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:40:57" itemprop="dateModified" datetime="2016-09-06T22:40:57+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="什么是事务"><a href="#什么是事务" class="headerlink" title="什么是事务"></a>什么是事务</h3><hr>
<h2 id="事务是一组不可分割的SQL-query语句，或者说是一个最小的工作单元。-事务与锁的关系"><a href="#事务是一组不可分割的SQL-query语句，或者说是一个最小的工作单元。-事务与锁的关系" class="headerlink" title="事务是一组不可分割的SQL query语句，或者说是一个最小的工作单元。### 事务与锁的关系"></a>事务是一组不可分割的SQL query语句，或者说是<strong>一个最小的工作单元</strong>。<br>### 事务与锁的关系</h2><h4 id="为什么提出这个问题"><a href="#为什么提出这个问题" class="headerlink" title="为什么提出这个问题"></a>为什么提出这个问题</h4><p>在阅读《Java虚拟机并发编程》(Programming Concurrency on the JVM - Materning Synchronization, STM and Actors)中STM(Software Transaction Memory)时，我看到transaction特征在concurrency中的神奇应用场景：</p>
<ul>
<li>原子性：涉及一组操作，这组操作具有原子特征，比如存款和取款的组合操作。这组操作内部的所有更改要么全部成功，要么全部失败。</li>
<li>一致性：所有并行的事务所造成的变更，从外部来看，都是一个接一个发生的。比如：存款，取款这两个独立事务。如果存款的过程中间，取款操作接入，那么取款读取的数据是旧的。待存款恢复并执行完毕，取款想要写回的数据必然无效。取款事务需要重做！所以外观来看这是存款到取款的序列，反之亦然。其实本质上，就是可见性的问题。</li>
<li>不需要显式地运用锁，不论是读锁还是写锁。这样就为程序员提供了比较好的抽象屏障(abstract barrier)。</li>
<li>隔离性：事务在未提交之前，所做的任何更改都不能被其他事务看到。</li>
</ul>
<p>我看到了很多STM的好处，但是看到处理写偏斜异常(Handling Write Skew Anomaly)（可以简单理解为两个事务修改的变量不是同一个，但是两个变量之间又有约束关系）一章时，作者使用<code>ensure</code>函数给约束变量加了读锁。加读锁的意义在于本事务之外，其他事务无法获得该变量的写锁，自然无法修改它的值。但是这里显式地使用了锁，所以可以明确事务不是锁无关的，而且这让我联想到了数据库事务隔离级别中的可重复读(REPEATABLE_READ)。可重复读也是使用在特定记录行上使用读锁，来防止外部事务修改了该条记录行。</p>
<h4 id="微妙的关系"><a href="#微妙的关系" class="headerlink" title="微妙的关系"></a>微妙的关系</h4><p>有趣的事情来了，事务原子性能确保数据的完整性，而事务的一致性和隔离性则侧重于数据的可见性。可见性的保证在并发当中绝对和锁相关。我刚说了，事务给锁提供了抽象屏障，而且事务的隔离级别依旧仰仗锁的粒度，所以不要将事务看做银弹，以为有了事务，锁就不值一提。</p>
<h3 id="数据库事务的隔离级别"><a href="#数据库事务的隔离级别" class="headerlink" title="数据库事务的隔离级别"></a>数据库事务的隔离级别</h3><hr>
<h4 id="为什么提出这个问题-1"><a href="#为什么提出这个问题-1" class="headerlink" title="为什么提出这个问题"></a>为什么提出这个问题</h4><p>一直被《高性能MySQL》里的解释弄得稀里糊涂，纠结于脏读、不可重复读和幻读之间的关系。而且某些解释看似合理，但完全没有指导价值。比如：阐述隔离级别，却没法从中得出我们如何结合应用场景选择合适的隔离级别。</p>
<h4 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h4><ul>
<li><p>Uncommited Read<br>一个事务未提交，另一个事务却能读到该事务所做的更改。因为有可能读到未提交到数据库里的脏数据，这一级别会导致脏读。适用于只读场景下。</p>
</li>
<li><p>Commited Read<br>未提交之前，事务之间是不可见的，所以可以阻止脏读。<br>但是会导致不可重复读问题，也就是在本事务内，读取一条记录，另一个事务修改了此条记录并提交，本事务再读取同一条记录时，发现得到记录和前一条不一致的场景。这一级别也被称为不可重复读级别。<br><strong>但上述场景没有半点指导意义！</strong><br>如果你的应用场景是这样的——你想查询的变量是通过本事务里只读但是对于外部事务可写的变量作为条件查询出来的，那么这个只读变量很可能不可重复读，导致这个事务会失效。举个例子：如果你的查询语句是这样的<code>SELECT USER.age into age FROM USERS name=&#39;YOU&#39;;</code><br>这时候外部事务修改了名字<code>UPDATE SET name=&#39;ME&#39; WHERE name=&#39;YOU&#39;;</code>并提交。那么这时候，<code>age</code>是无效的状态，你再拿来用就有问题了。这一级别适合于读多写少且写偏斜不存在的场景。</p>
</li>
<li><p>Repeatable Read （MySQL的默认隔离级别）<br>可重复读，可以理解给只读的记录行加了读锁。这样，外部事务无法获得写锁，本事务内部这条记录始终有效，待事务结束即可解锁。反之，外部事务先得写锁，那么本事务无法获取记录行的读锁，导致重试发生。显然，如果你的应用场景里，读多写少且读写操作同一条记录的可能性很大的时候适合。</p>
</li>
<li><p>幻读<br>可重复读级别无法防止幻读。幻读是这样一种场景，本事务读取一个<strong>范围内，范围内，范围内（重要的事情写三遍）</strong>的数据集，但是另一事务又向这个范围内插入一条记录，导致数据集发生变化了，像是出现了幻觉，所以称为幻读（我很痛恨一些奇葩的科学家起的不合理的名字，这就是其一。按着这种逻辑，不可重复读不也可以说是出现幻觉吗？）。那么为什么会出现这种情况，原因是新插入的记录以前不存在于数据库中，所以你没法为它加锁。而且可重复读只是为每行记录加锁，没有用到Range Lock，这一幻影插入操作总能成功。<br>不过MySQL中InnoDB存储引擎提供了MVCC（多版本并发控制）技术，为每条记录设置一个递增的事务编号，大于本次事务编号的记录，不准插入记录。<br>可重复读+MVCC即可解决并发中的大部分问题。</p>
</li>
<li><p>Serializable Read<br>顾名思义，串行读，事务之间是串行的，同步的。换言之，并发性剧减。</p>
</li>
</ul>
<h3 id="STM的隔离级别"><a href="#STM的隔离级别" class="headerlink" title="STM的隔离级别"></a>STM的隔离级别</h3><hr>
<ul>
<li>隔离级别处于提交读。</li>
</ul>
<h3 id="事务的级别"><a href="#事务的级别" class="headerlink" title="事务的级别"></a>事务的级别</h3><hr>
<p>描述的是事务本身的属性</p>
<ul>
<li>ReadOnly：所有的操作都是读取操作，不涉及任何产生副作用的操作。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/07/16/concurrency-in-action/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lambeta">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="λ">
      <meta itemprop="description" content="Elegance and familiarity are orthogonal">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | λ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/07/16/concurrency-in-action/" class="post-title-link" itemprop="url">Concurrency in action</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-07-16 08:25:58" itemprop="dateCreated datePublished" datetime="2015-07-16T08:25:58+08:00">2015-07-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:58:32" itemprop="dateModified" datetime="2016-09-06T22:58:32+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="什么是竞态条件？"><a href="#什么是竞态条件？" class="headerlink" title="什么是竞态条件？"></a>什么是竞态条件？</h3><hr>
<blockquote>
<p><strong>tips</strong>: The situation where two threads compete for the same resource, where the sequence in which the resource is accessed is significant, is called race conditions. A code section that leads to race conditions is called a critical section. In the below example the method add() is a critical section, leading to race conditions. Race conditions can be avoided by proper thread synchronization in critical sections.<br>两个线程竞争同一个资源，而该资源的访问顺序十分重要的情况就被称为竞态条件。导致竞态条件的代码区就被称为临界区。下面的例子中的add()方法就是一个导致竞态条件的临界区。临界区上合适的线程同步能避免竞态条件。<br>Race conditions arise in software when an application depends on the sequence or timing of processes or threads for it to operate properly.<br>race conditions often happen when the processes or threads depend on some shared state.<br>软件里的竞态条件发生在一个应用程序依赖进程或者线程的执行顺序和时间以确保该程序执行正确的时候。竞态条件总是发生在进程或线程依赖某些共享资源的时候。</p>
</blockquote>
<h4 id="一个临界区的例子："><a href="#一个临界区的例子：" class="headerlink" title="一个临界区的例子："></a>一个临界区的例子：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class Counter &#123;</span><br><span class="line">    protected long count = 0;</span><br><span class="line"></span><br><span class="line">    public void add(long value)&#123;</span><br><span class="line">        this.count = this.count + value;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="什么是线程安全？"><a href="#什么是线程安全？" class="headerlink" title="什么是线程安全？"></a>什么是线程安全？</h3><hr>
<blockquote>
<p><strong>tips</strong>: Code that is safe to call by multiple threads simultanously is called thread safe. If a piece of code is thread safe, then it contains no race conditions.<br>能被多个线程同时安全地调用的代码就是线程安全。如果一段代码是安全的，那么它就不存在竞态条件。</p>
</blockquote>
<ul>
<li>Thread safe: Implementation is guaranteed to be free of race conditions when accessed by multiple threads simultaneously.</li>
<li>Conditionally safe: Different threads can access different objects simultaneously, and access to shared data is protected from race conditions.</li>
<li>Not thread safe: Code should not be accessed simultaneously by different threads.<blockquote>
</blockquote>
</li>
<li>线程安全：实现以保证多个线程同时访问不存在竞态条件</li>
<li>条件安全：不同的线程可以同时访问不同的对象，且在访问共享资源时保护以免于竞态条件</li>
<li>非线程安全：代码不能被多个线程同时访问</li>
</ul>
<h3 id="可见性和竞态条件的关系？"><a href="#可见性和竞态条件的关系？" class="headerlink" title="可见性和竞态条件的关系？"></a>可见性和竞态条件的关系？</h3><hr>
<blockquote>
<p>如果存在竞态条件，那么就必须保证变量的可见性</p>
</blockquote>
<h3 id="可见性和线程安全的关系？"><a href="#可见性和线程安全的关系？" class="headerlink" title="可见性和线程安全的关系？"></a>可见性和线程安全的关系？</h3><hr>
<blockquote>
<p>严格意义上，线程安全其实是相对于非线程安全的，即包含了线程安全和条件安全两部分。</p>
</blockquote>
<p>Below we discuss two approaches for avoiding race conditions to achieve thread safety.</p>
<blockquote>
</blockquote>
<p>The first class of approaches focuses on avoiding shared state, and includes:<br>也就是纯粹的线程安全。</p>
<blockquote>
</blockquote>
<ul>
<li>Re-entrancy<br>  Writing code in such a way that it can be partially executed by a thread, reexecuted by the same thread or simultaneously executed by another thread and still correctly complete the original execution. This requires the saving of state information in variables local to each execution, usually on a stack, instead of in static or global variables or other non-local state. All non-local state must be accessed through atomic operations and the data-structures must also be reentrant.</li>
<li>Thread-local storage<br>  Variables are localized so that each thread has its own private copy. These variables retain their values across subroutine and other code boundaries, and are thread-safe since they are local to each thread, even though the code which accesses them might be executed simultaneously by another thread.<blockquote>
</blockquote>
The second class of approaches are synchronization-related, and are used in situations where shared state cannot be avoided:<br>也就是条件安全部分。<blockquote>
</blockquote>
</li>
<li>Mutual exclusion<br>  Access to shared data is serialized using mechanisms that ensure only one thread reads or writes to the shared data at any time. Incorporation of mutual exclusion needs to be well thought out, since improper usage can lead to side-effects like deadlocks, livelocks and resource starvation.</li>
<li>Atomic operations<br>  Shared data are accessed by using atomic operations which cannot be interrupted by other threads. This usually requires using special machine language instructions, which might be available in a runtime library. Since the operations are atomic, the shared data are always kept in a valid state, no matter how other threads access it. Atomic operations form the basis of many thread locking mechanisms, and are used to implement mutual exclusion primitives.</li>
<li>Immutable objects<br>  The state of an object cannot be changed after construction. This implies both that only read-only data is shared and that inherent thread safety is attained. Mutable (non-const) operations can then be implemented in such a way that they create new objects instead of modifying existing ones. This approach is used by the string implementations in Java, C# and Python.<blockquote>
<p>所以可见性只是针对于条件安全部分而言的。</p>
</blockquote>
</li>
</ul>
<h3 id="竞态条件和线程安全的关系？"><a href="#竞态条件和线程安全的关系？" class="headerlink" title="竞态条件和线程安全的关系？"></a>竞态条件和线程安全的关系？</h3><hr>
<blockquote>
<p>避免竞态条件以获得线程安全。换句话说，避免竞态条件是线程安全的充要条件。</p>
</blockquote>
<h3 id="为什么说跨越内存栅栏（可见性）和避免竞态条件是同步相关的两大主要问题？"><a href="#为什么说跨越内存栅栏（可见性）和避免竞态条件是同步相关的两大主要问题？" class="headerlink" title="为什么说跨越内存栅栏（可见性）和避免竞态条件是同步相关的两大主要问题？"></a>为什么说跨越内存栅栏（可见性）和避免竞态条件是同步相关的两大主要问题？</h3><hr>
<blockquote>
<p>跨越内存栅栏（可见性）是应对竞态条件的一种方式，出现竞态条件必须确保可见性。举个例子：一个写线程写完之后，要保证所做更改对其它线程可见，否则会让其它线程读到脏数据。<br>避免竞态条件的方式有很多种，包括上述的线程安全的各种手段。</p>
</blockquote>
<h3 id="相关术语"><a href="#相关术语" class="headerlink" title="相关术语"></a>相关术语</h3><hr>
<blockquote>
<ol>
<li>livelock（活锁）：请求一个锁的时候不断失败。</li>
<li>starvation（饿死）：无法定期访问共享资源来执行，发生在某个线程长期霸占共享资源的时候。</li>
</ol>
<ul>
<li>Starvation<br>Starvation describes a situation where a thread is unable to gain regular access to shared resources and is unable to make progress. This happens when shared resources are made unavailable for long periods by “greedy” threads. For example, suppose an object provides a synchronized method that often takes a long time to return. If one thread invokes this method frequently, other threads that also need frequent synchronized access to the same object will often be blocked.</li>
</ul>
</blockquote>
<ul>
<li>Livelock<br>A thread often acts in response to the action of another thread. If the other thread’s action is also a response to the action of another thread, then livelock may result. As with deadlock, livelocked threads are unable to make further progress. However, the threads are not blocked — they are simply too busy responding to each other to resume work. This is comparable to two people attempting to pass each other in a corridor: Alphonse moves to his left to let Gaston pass, while Gaston moves to his right to let Alphonse pass. Seeing that they are still blocking each other, Alphone moves to his right, while Gaston moves to his left. They’re still blocking each other, so…</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/06/21/you-said/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lambeta">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="λ">
      <meta itemprop="description" content="Elegance and familiarity are orthogonal">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | λ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/06/21/you-said/" class="post-title-link" itemprop="url">你说</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-06-21 12:23:25" itemprop="dateCreated datePublished" datetime="2015-06-21T12:23:25+08:00">2015-06-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-05-07 12:26:03" itemprop="dateModified" datetime="2018-05-07T12:26:03+08:00">2018-05-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%94%9F%E6%B4%BB/" itemprop="url" rel="index"><span itemprop="name">生活</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>你说，昨天。</p>
<p>有一片天地，</p>
<p>在氤氲的叹息里，</p>
<p>幻做纸张，</p>
<p>将我和你写入了泛黄。</p>
<p>你说，今天。</p>
<p>我只是一支尾音，</p>
<p>很小心地，</p>
<p>从你的心底淌出。</p>
<p>然后，</p>
<p>躲在雨水里——变轻。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/03/11/pit-and-trap-in-Java/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lambeta">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="λ">
      <meta itemprop="description" content="Elegance and familiarity are orthogonal">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | λ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/03/11/pit-and-trap-in-Java/" class="post-title-link" itemprop="url">Java陷阱和缺陷</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-03-11 23:16:08" itemprop="dateCreated datePublished" datetime="2015-03-11T23:16:08+08:00">2015-03-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:58:29" itemprop="dateModified" datetime="2016-09-06T22:58:29+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="String-valueOf"><a href="#String-valueOf" class="headerlink" title="String.valueOf"></a>String.valueOf</h4><hr>
<figure class="highlight java"><figcaption><span>example.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String.valueOf(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line">java.lang.NullPointerException</span><br></pre></td></tr></table></figure>
<p>why does it cause excepation? Java call the wrong method because type match!</p>
<figure class="highlight java"><figcaption><span>String.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">valueOf</span><span class="params">(<span class="type">char</span> data[])</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(data);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">String</span><span class="params">(<span class="type">char</span> value[])</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.value = Arrays.copyOf(value, value.length); <span class="comment">//=&gt; cause exception.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>how to correct?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String.valueOf((Object)<span class="literal">null</span>)</span><br><span class="line">-&gt;</span><br><span class="line"><span class="literal">null</span></span><br></pre></td></tr></table></figure>

<h4 id="Varargs-bug"><a href="#Varargs-bug" class="headerlink" title="Varargs bug"></a>Varargs bug</h4><hr>
<p>Changes in Most Specific Varargs Method Selection<br>Description: The overload resolution algorithm in the javac compiler has been fixed in how it selects the most specific varargs method when more than one method is applicable to a given call-site (see the JLS, Java SE 7 Edition, section 15.12.2.5). Because of a bug, both JDK 5.0 and JDK 6 compilers reject the following legal code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Test &#123;</span><br><span class="line">    void foo(int... i) &#123;&#125;</span><br><span class="line">    void foo(double... d) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    void test() &#123;</span><br><span class="line">       foo(1,2,3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In the above example, both methods are applicable (because you can pass an int where a double is expected). Since both methods are applicable, the compiler must select the so-called most-specific method, that is, the best candidate among the two. This is done by looking at the signatures of both methods; in this case, since one method (foo(double…)) is accepting an argument that is more general than the other (foo(int…)), the answer is straightforward: the most specific method is foo(int…).<br>While the javac compiler accepts more code than it did prior to JDK 7, this fix also results in a slight source incompatibility in the following case:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Test &#123;</span><br><span class="line">    void foo(int... i) &#123;&#125;</span><br><span class="line">    void foo(Object... o) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    void test() &#123;</span><br><span class="line">       foo(1,2,3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This code compiles in JDK 6 (the most specific method is foo(int…)). This code does not compile under JDK 7. As per 15.12.2.5, it is not possible to choose between foo(int…) and foo(Object…) as neither int is a subtype of Object, nor Object is a subtype of int. This program should be disallowed (in fact, it should never have been allowed in the first place).</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/02/03/Javascript-Promise/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lambeta">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="λ">
      <meta itemprop="description" content="Elegance and familiarity are orthogonal">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | λ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/02/03/Javascript-Promise/" class="post-title-link" itemprop="url">Javascript Promise</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-02-03 23:33:40" itemprop="dateCreated datePublished" datetime="2015-02-03T23:33:40+08:00">2015-02-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:58:25" itemprop="dateModified" datetime="2016-09-06T22:58:25+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Promise对象最早被C++工程师使用，接着以Deferred对象出现在Python中。随着NodeJS的兴起，Promise在javascript中的应用越来越广。</p>
<p>大凡技术成熟之后都会逐渐形成一个标准，Promise的标准定义在<a target="_blank" rel="noopener" href="http://wiki.commonjs.org/wiki/CommonJS">CommonJS</a>中，全称是<a target="_blank" rel="noopener" href="http://wiki.commonjs.org/wiki/Promises/A">Promise&#x2F;A</a>，不过新近出现了改良版的<a target="_blank" rel="noopener" href="https://promisesaplus.com/">Promise&#x2F;A+</a>，只不过它仅仅对原来的标准部分澄清，同时依据实践稍作扩展。</p>
<blockquote>
<p>The core Promises&#x2F;A+ specification does not deal with how to create, fulfill, or reject promises, choosing instead to focus on providing an interoperable(协作的) <strong>then</strong> method. Future work in companion specifications may touch on these subjects.</p>
</blockquote>
<p>但是使用Promise还是有些地方值得留意的。</p>
<h4 id="1-Then的Resovler-Function不返回任何值"><a href="#1-Then的Resovler-Function不返回任何值" class="headerlink" title="1. Then的Resovler Function不返回任何值"></a>1. Then的Resovler Function不返回任何值</h4><hr>
<p>举个例子，打印deferred数组的首个元素</p>
<figure class="highlight javascript"><figcaption><span>promise_sample.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">printFirstAndLast</span>(<span class="params">itemsDeferred</span>)&#123;</span><br><span class="line">    <span class="title function_">findFirst</span>(itemsDeferred).<span class="title function_">then</span>(util.<span class="property">puts</span>); <span class="comment">//=&gt; 0</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">last</span>(itemsDeferred).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">last</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> deferred = <span class="title function_">defer</span>();</span><br><span class="line">        deferred.<span class="title function_">resolve</span>(last);</span><br><span class="line">        <span class="title function_">findFirst</span>(deferred).<span class="title function_">then</span>(util.<span class="property">puts</span>) <span class="comment">//=&gt; 1</span></span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">result</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;result:&#x27;</span>, result); <span class="comment">//=&gt; 2</span></span><br><span class="line">    &#125;, <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;reason:&#x27;</span>, reason);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">last</span>(<span class="params">itemsDeferred</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> itemsDeferred.<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">items</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> items.<span class="title function_">slice</span>(<span class="number">1</span>, items.<span class="property">length</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">findFirst</span>(<span class="params">itemsDeferred</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> itemsDeferred.<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">items</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> items[<span class="number">0</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">---</span><br><span class="line"><span class="keyword">var</span> deferred = <span class="title function_">defer</span>();</span><br><span class="line">deferred.<span class="title function_">resolve</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line"><span class="title function_">printFirstAndLast</span>(deferred);</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="attr">result</span>: <span class="literal">undefined</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>从输出看，由于我故意没有返回1处的Promise对象，最后一个<em>then</em> 的2处代码先被执行，打印出undefined，然后才会执行完1处的代码，打印出数字2。</p>
<p>这样的现象有两处值得注意的地方</p>
<ul>
<li>执行顺序混乱</li>
<li>最后then的结果是undefined</li>
</ul>
<p>顺序混乱是由于标识为1处的resolve的时间较长，回调的时间较久，所以后执行。</p>
<p> 2处为undefined，是因为1处没有返回值，<strong>我们知道javascript的function始终会返回值且这两种方式：<code>return;</code>(返回void)和不显式写return语句都会返回undefined</strong>。所以将值为undefined的promise对象传给下一个<em>then</em>方法。</p>
<h4 id="2-Then的Rejector-Function不返回Reject-Promise"><a href="#2-Then的Rejector-Function不返回Reject-Promise" class="headerlink" title="2. Then的Rejector Function不返回Reject Promise"></a>2. Then的Rejector Function不返回Reject Promise</h4><hr>
<figure class="highlight javascript"><figcaption><span>reject.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">printFirstAndLast</span>(<span class="params">itemsDeferred</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> itemDeferred.<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;, <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">        util.<span class="title function_">puts</span>(<span class="string">&#x27;1:&#x27;</span>+reason);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;error-1&#x27;</span>;</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">result</span>)&#123;</span><br><span class="line">        util.<span class="title function_">puts</span>(<span class="string">&#x27;resolve 2:&#x27;</span>+result);</span><br><span class="line">    &#125;, <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">        util.<span class="title function_">puts</span>(<span class="string">&#x27;reject 2:&#x27;</span>+reason);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> deferred = <span class="title function_">defer</span>();</span><br><span class="line">deferred.<span class="title function_">reject</span>(<span class="string">&#x27;error-0&#x27;</span>);</span><br><span class="line"><span class="title function_">printFirstAndLast</span>(deferred);</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"><span class="number">1</span>: error-<span class="number">0</span></span><br><span class="line">resolve <span class="number">2</span>:error-<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>从输出看，如果reject function不返回reject promise，而只是<code>error-1</code>这样的值，那么调用then方法，执行的还是resolve方法。</p>
<p>从Promise&#x2F;A+参考描述可证明上述</p>
<blockquote>
<p>promise2 &#x3D; promise1.then(onFulfilled, onRejected);</p>
<p>If either onFulfilled or onRejected returns a value x, run the Promise Resolution Procedure [[Resolve]](promise2, x).</p>
<p>If x is a thenable, it attempts to make promise adopt the state of x, under the assumption that x behaves at least somewhat like a promise. Otherwise, it fulfills promise with the value x.</p>
</blockquote>
<h4 id="3-Then的Resolver-Function返回的是对象，而且包含then方法"><a href="#3-Then的Resolver-Function返回的是对象，而且包含then方法" class="headerlink" title="3. Then的Resolver Function返回的是对象，而且包含then方法"></a>3. Then的Resolver Function返回的是对象，而且包含then方法</h4><hr>
<figure class="highlight javascript"><figcaption><span>obj_then.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">then</span>: <span class="keyword">function</span>(<span class="params">resolver, reject</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">resolver</span>(<span class="string">&#x27;i am an obj.&#x27;</span>);</span><br><span class="line">&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printFirstAndLast</span>(<span class="params">itemsDeferred</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> itemDeferred.<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;, <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">        util.<span class="title function_">puts</span>(<span class="string">&#x27;1:&#x27;</span>+reason);</span><br><span class="line">        <span class="keyword">return</span> obj; 						<span class="comment">//=&gt; 1</span></span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">result</span>)&#123;</span><br><span class="line">        util.<span class="title function_">puts</span>(<span class="string">&#x27;resolve 2:&#x27;</span>+result);</span><br><span class="line">    &#125;, <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">        util.<span class="title function_">puts</span>(<span class="string">&#x27;reject 2:&#x27;</span>+reason);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> deferred = <span class="title function_">defer</span>();</span><br><span class="line">deferred.<span class="title function_">reject</span>(<span class="string">&#x27;error-0&#x27;</span>);</span><br><span class="line"><span class="title function_">printFirstAndLast</span>(deferred);</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"><span class="number">1</span>: error-<span class="number">0</span></span><br><span class="line">resolve <span class="number">2</span>:i am  an obj</span><br></pre></td></tr></table></figure>
<p>从结果看，obj这个含有then方法的对象，在1处被调用了then，同时将<code>resolver(&#39;i am an obj.&#39;)</code>作为Promise返回。</p>
<p>从Promise&#x2F;A+可知</p>
<blockquote>
<p>If then is a function, call it with x as this, first argument resolvePromise, and second argument rejectPromise, where:</p>
<p>If&#x2F;when resolvePromise is called with a value y, run [[Resolve]](promise, y)</p>
<p>If&#x2F;when rejectPromise is called with a reason r, reject promise with r</p>
</blockquote>
<p>那么如果是以下这些对象</p>
<ul>
<li>{then: ‘something’}</li>
<li>{then: function(){}}</li>
<li>{A: ‘A’}</li>
<li>{then: function(resolver, rejector){return rejector(“error”);}}</li>
</ul>
<p>结果会是</p>
<ul>
<li>resolve 2:[Object Object]</li>
<li>忽略</li>
<li>resolve 2:[Object Object]</li>
<li>reject 2: error</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/02/01/Testable-Javascript/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lambeta">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="λ">
      <meta itemprop="description" content="Elegance and familiarity are orthogonal">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | λ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/02/01/Testable-Javascript/" class="post-title-link" itemprop="url">Testable Javascript</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-02-01 15:56:47" itemprop="dateCreated datePublished" datetime="2015-02-01T15:56:47+08:00">2015-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:58:22" itemprop="dateModified" datetime="2016-09-06T22:58:22+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>singletons suffer state pollution between tests</p>
</blockquote>
<figure class="highlight javascript"><figcaption><span>singletons.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">	<span class="attr">counter</span>: <span class="number">0</span>,</span><br><span class="line">	<span class="attr">inc</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> ++<span class="variable language_">this</span>.<span class="property">counter</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> singleton = <span class="built_in">require</span>(<span class="string">&#x27;singletons&#x27;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">testCase</span>(&#123;</span><br><span class="line">    <span class="string">&quot;should equal one after calling inc&quot;</span>: <span class="keyword">function</span> (<span class="params">test</span>) &#123;</span><br><span class="line">        test.<span class="title function_">equal</span>(<span class="number">1</span>, singleton.<span class="title function_">inc</span>());</span><br><span class="line">        test.<span class="title function_">done</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;should get one after calling inc&quot;</span>: <span class="keyword">function</span>(<span class="params">test</span>) &#123;</span><br><span class="line">    	test.<span class="title function_">equal</span>(<span class="number">1</span>, singleton.<span class="title function_">inc</span>());</span><br><span class="line">    	test.<span class="title function_">done</span>();</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
<p>结果第二个测试会失败，但是从测试本身是看不出为什么第一个可以通过，而第二个则相反。当然，我们可以通过<code>setUp</code>或<code>tearDown</code>方法来重置对象的状态，但是这无疑增加了维护测试的成本，你得记着重置对象这件事本身就是负担。</p>
<p>下面就是解决方案</p>
<figure class="highlight javascript"><figcaption><span>singletons_impr.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> &#123;</span><br><span class="line">		<span class="attr">counter</span>: <span class="number">0</span>,</span><br><span class="line">		<span class="attr">inc</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> ++<span class="variable language_">this</span>.<span class="property">counter</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>再看我们的测试</p>
<figure class="highlight javascript"><figcaption><span>test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> singleton = <span class="built_in">require</span>(<span class="string">&#x27;singletons_impr&#x27;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">testCase</span>(&#123;</span><br><span class="line">    <span class="string">&quot;should equal one after calling inc&quot;</span>: <span class="keyword">function</span> (<span class="params">test</span>) &#123;</span><br><span class="line">        test.<span class="title function_">equal</span>(<span class="number">1</span>, <span class="title function_">singleton</span>().<span class="title function_">inc</span>());</span><br><span class="line">        test.<span class="title function_">done</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;should get one after calling inc&quot;</span>: <span class="keyword">function</span>(<span class="params">test</span>) &#123;</span><br><span class="line">    	test.<span class="title function_">equal</span>(<span class="number">1</span>, <span class="title function_">singleton</span>().<span class="title function_">inc</span>());</span><br><span class="line">    	test.<span class="title function_">done</span>();</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
<p>这样两次返回的对象都是全新的，测试通过。</p>
<p>不过，似乎这样让测试变得更加麻烦了，好处不明显。但是结合这篇文章<a target="_blank" rel="noopener" href="http://yanqian.me/2015/01/27/Javascript-Modularize-2nd/">[Javascript Modularize 2nd]</a>，就会巧妙地解决多个模块依赖某一个模块，某个模块修改被传染至其他模块的问题。因为每个被引入的模块都将被重新执行生成一遍，成为独立的对象。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><ul>
<li><code>module.exports</code>最好使用<code>function</code>方式导出。</li>
</ul>
<p>参考链接<br>[1]  <a target="_blank" rel="noopener" href="http://www.adequatelygood.com/Writing-Testable-JavaScript.html">Writing Testable JavaScript</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/01/30/Javascript-Scope/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lambeta">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="λ">
      <meta itemprop="description" content="Elegance and familiarity are orthogonal">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | λ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/01/30/Javascript-Scope/" class="post-title-link" itemprop="url">Javascript Scope</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-01-30 17:08:44" itemprop="dateCreated datePublished" datetime="2015-01-30T17:08:44+08:00">2015-01-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:58:19" itemprop="dateModified" datetime="2016-09-06T22:58:19+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>The extent of a scope refers to the lifetime of a variable (i.e., how long a variable holds a certain value)</p>
</blockquote>
<h3 id="Global-Scope"><a href="#Global-Scope" class="headerlink" title="Global Scope"></a>Global Scope</h3><p>Javascript中任意不使用var创建的变量具有全局作用域。</p>
<figure class="highlight javascript"><figcaption><span>global</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">globalVariable = <span class="string">&quot;global&quot;</span>;</span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(globalVariable);</span><br><span class="line">&#125;)()</span><br><span class="line"></span><br><span class="line">-&gt; <span class="variable language_">global</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> globalVariable;</span><br><span class="line"></span><br><span class="line">-&gt; <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>当然，任意定义在文件最顶层的变量，事实上，由于<a target="_blank" rel="noopener" href="http://yanqian.me/2015/01/27/Javascript-Hoisting/">Javascript Hositing</a>作用，所有定义在最外层的变量都会被提升至作用域首部，都具有全局作用域。</p>
<p>值得注意的是使用var定义的变量是不能delete的，它不是全局变量的属性：</p>
<figure class="highlight javascript"><figcaption><span>del_variable</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> globalVariable = <span class="string">&#x27;global&#x27;</span>;</span><br><span class="line"><span class="keyword">delete</span> globalVariable;</span><br><span class="line"></span><br><span class="line">-&gt; <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>除此之外，任意被暴露到最外层的变量，一旦被全局作用域捕获，其本身都会存在被随意修改的风险。</p>
<h3 id="Lexical-Scope"><a href="#Lexical-Scope" class="headerlink" title="Lexical Scope"></a>Lexical Scope</h3><blockquote>
<p>Lexical scope refers to the visibility of a variable and its value analogous to its textual representation.</p>
</blockquote>
<p>Javascript会从内向外寻找变量的绑定，所以变量的定义距离使用处最近，则该变量会被使用。</p>
<figure class="highlight javascript"><figcaption><span>lexical_scope</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">lexicalScope</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> lexicalVariable = <span class="string">&quot;outer&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">		<span class="keyword">var</span> lexicalVariable = <span class="string">&quot;inner&quot;</span>;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(lexicalVariable);</span><br><span class="line">		(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="keyword">var</span> lexicalVariable = <span class="string">&quot;innerMost&quot;</span>;</span><br><span class="line">			<span class="variable language_">console</span>.<span class="title function_">log</span>(lexicalVariable);</span><br><span class="line">		&#125;)();</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(lexicalVariable);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">lexicalScope</span>();</span><br><span class="line">-&gt; inner</span><br><span class="line">innerMost</span><br><span class="line">inner</span><br></pre></td></tr></table></figure>

<h3 id="Dynamic-Scope"><a href="#Dynamic-Scope" class="headerlink" title="Dynamic Scope"></a>Dynamic Scope</h3><blockquote>
<p>the value of any given binding cannot be known until the caller of any given function is known— which may be too late.</p>
</blockquote>
<figure class="highlight javascript"><figcaption><span>dynamic_scope</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">globalThis</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="variable language_">this</span>; &#125;</span><br><span class="line"><span class="title function_">globalThis</span>();</span><br><span class="line">-&gt; some <span class="variable language_">global</span> object, probably <span class="title class_">Window</span></span><br><span class="line">globalThis.<span class="title function_">call</span>(<span class="string">&#x27;barnabas&#x27;</span>);</span><br><span class="line">-&gt; <span class="string">&#x27;barnabas&#x27;</span></span><br><span class="line">globalThis.<span class="title function_">apply</span>(<span class="string">&#x27;orsulak&#x27;</span>, [])</span><br><span class="line">-&gt; <span class="string">&#x27;orsulak&#x27;</span></span><br></pre></td></tr></table></figure>
<p>在Javascript中，<em>this</em>所处的作用域就是动态作用域。也就是说，<em>globalThis()<em>返回值完全由调用方决定，</em>this</em>变量的对照表是不断改变的。更多参考<a target="_blank" rel="noopener" href="http://yanqian.me/2014/10/11/funcation-scope/">这里</a></p>
<h3 id="Function-Scope"><a href="#Function-Scope" class="headerlink" title="Function Scope"></a>Function Scope</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function strangerIdentity(n) &#123;</span><br><span class="line">	for(this[&#x27;i&#x27;] = 0; this[&#x27;i&#x27;] &lt; n; this[&#x27;i&#x27;]++);</span><br><span class="line">	return this[&#x27;i&#x27;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--- case 1</span><br><span class="line">strangerIdentity(100);</span><br><span class="line">-&gt; 100</span><br><span class="line">i</span><br><span class="line">-&gt; 100</span><br><span class="line"></span><br><span class="line">--- case 2</span><br><span class="line">var id = new strangerIdentity(100);</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line">-&gt; strangerIdentity &#123;i: 100&#125;</span><br><span class="line">id.i</span><br><span class="line">-&gt; 100</span><br><span class="line">i</span><br><span class="line">-&gt;  Uncaught ReferenceError: i is not defined</span><br></pre></td></tr></table></figure>
<p>在Javascript中，只有一个<strong>Function</strong>才会产生新的作用域。直接调用一个funcation，其内部的指针指向global对象。但当使用<em>new</em>后，其作用域绑定到一个<strong>Function Object</strong>上。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/01/28/Javascript-Reference/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lambeta">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="λ">
      <meta itemprop="description" content="Elegance and familiarity are orthogonal">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | λ">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/01/28/Javascript-Reference/" class="post-title-link" itemprop="url">Javascript Reference</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-01-28 23:23:14" itemprop="dateCreated datePublished" datetime="2015-01-28T23:23:14+08:00">2015-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:58:16" itemprop="dateModified" datetime="2016-09-06T22:58:16+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Javascript的赋值操作就是引用修改，举个例子：</p>
<figure class="highlight javascript"><figcaption><span>reference.js</span><a target="_blank" rel="noopener" href="https://github.com/heldr/grunt-properties">grunt-properties</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">splitKeys</span>(<span class="params">obj, splitter</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> keys, value, parent, result = &#123;&#125;;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">          keys = key.<span class="title function_">split</span>(splitter);</span><br><span class="line">          value = obj[key].<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>);</span><br><span class="line">          parent = result;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; keys.<span class="property">length</span>-<span class="number">1</span>; j++) &#123;</span><br><span class="line">              parent = parent[keys[j]] = parent[keys[j]] || &#123;&#125;;</span><br><span class="line">          &#125;</span><br><span class="line">          parent[keys[keys.<span class="property">length</span>-<span class="number">1</span>]] = value;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(result, <span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码将Java程序中的常见的Properties文件中的键值映射成了嵌套的JSON对象:</p>
<figure class="highlight javascript"><figcaption><span>test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;country.province.city&quot;</span>: <span class="string">&quot;Chengdu&quot;</span>&#125;;</span><br><span class="line"><span class="title function_">splitKeys</span>(obj, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">-&gt; <span class="string">&quot;&#123;</span></span><br><span class="line"><span class="string">  &quot;</span>country<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;</span>province<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;</span>city<span class="string">&quot;: &quot;</span><span class="title class_">Chengdu</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<p>我们从实现代码的这行开始看起<code>parent = result;</code>，很简单地把<code>parent</code>指向<code>result</code>这个空对象。</p>
<p>再看接下来的代码，也是最巧妙的地方：</p>
<figure class="highlight javascript"><figcaption><span>parts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; keys.<span class="property">length</span>-<span class="number">1</span>; j++) &#123;</span><br><span class="line">     parent = parent[keys[j]] = parent[keys[j]] || &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一次循环：<br>parent开始是空对象，<code>parent = parent[&#39;country&#39;] = parent[&#39;country&#39;] || &#123;&#125;;</code>，将会生成一个parent的country属性，该属性的值还是一个空对象。于此同时，parent会指向新生成的、也即它的country属性。</p>
<p>第二次循环：<br>parent指向了country，<code>parent = parent[&#39;province&#39;] = parent[&#39;province&#39;] || &#123;&#125;;</code>也即<code>parent = country[&#39;province&#39;] = country[&#39;province&#39;] || &#123;&#125;;</code>，此时，将会生成一个country的province属性，该属性的值还是一个空对象，而parent则指向了province对象。</p>
<p>所以<code> parent[keys[keys.length-1]] = value;</code>等价为<code>province[&#39;city&#39;] = &quot;Chengdu&quot;;</code></p>
<p>最后，<code>return JSON.stringify(result, null, 2);</code>，这最后的result就是具有嵌套效果的JSON对象了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">lambeta</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>






  <script src="/js/third-party/addtoany.js"></script>

  





</body>
</html>

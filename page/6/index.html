<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"qianyan.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Senior Consultant | DevOps Master | Blockchain &amp; Web3 Specialist">
<meta property="og:type" content="website">
<meta property="og:title" content="鄢倩">
<meta property="og:url" content="https://qianyan.github.io/page/6/index.html">
<meta property="og:site_name" content="鄢倩">
<meta property="og:description" content="Senior Consultant | DevOps Master | Blockchain &amp; Web3 Specialist">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Ryan Qian">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://qianyan.github.io/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>鄢倩</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">鄢倩</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">(conj clojurians me)</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ryan Qian</p>
  <div class="site-description" itemprop="description">Senior Consultant | DevOps Master | Blockchain & Web3 Specialist</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/qianyan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qianyan" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:qianyan.lambda@gmail.com" title="E-Mail → mailto:qianyan.lambda@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://weibo.com/3672207020" title="Weibo → http:&#x2F;&#x2F;weibo.com&#x2F;3672207020" rel="noopener me" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://x.com/_qian_yan" title="Twitter → https:&#x2F;&#x2F;x.com&#x2F;_qian_yan" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://lambdaisland.com/blog" title="https:&#x2F;&#x2F;lambdaisland.com&#x2F;blog" rel="noopener" target="_blank">Lambdaisland</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://www.youtube.com/@SystemCrafters" title="https:&#x2F;&#x2F;www.youtube.com&#x2F;@SystemCrafters" rel="noopener" target="_blank">System Crafters</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://aphyr.com/" title="https:&#x2F;&#x2F;aphyr.com" rel="noopener" target="_blank">Aphyr</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://bucharestfp.ro/" title="http:&#x2F;&#x2F;bucharestfp.ro" rel="noopener" target="_blank">Bucharest FP</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="http://blog.rlmflores.me/" title="http:&#x2F;&#x2F;blog.rlmflores.me&#x2F;" rel="noopener" target="_blank">Rodrigo Flores</a>
            </li>
            <li class="links-of-blogroll-item">
              <a href="https://seancorfield.github.io/" title="https:&#x2F;&#x2F;seancorfield.github.io&#x2F;" rel="noopener" target="_blank">Seancorfield</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/02/03/Javascript-Promise/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/02/03/Javascript-Promise/" class="post-title-link" itemprop="url">Javascript Promise</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-02-03 23:33:40" itemprop="dateCreated datePublished" datetime="2015-02-03T23:33:40+08:00">2015-02-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:58:25" itemprop="dateModified" datetime="2016-09-06T22:58:25+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Promise对象最早被C++工程师使用，接着以Deferred对象出现在Python中。随着NodeJS的兴起，Promise在javascript中的应用越来越广。</p>
<p>大凡技术成熟之后都会逐渐形成一个标准，Promise的标准定义在<a target="_blank" rel="noopener" href="http://wiki.commonjs.org/wiki/CommonJS">CommonJS</a>中，全称是<a target="_blank" rel="noopener" href="http://wiki.commonjs.org/wiki/Promises/A">Promise&#x2F;A</a>，不过新近出现了改良版的<a target="_blank" rel="noopener" href="https://promisesaplus.com/">Promise&#x2F;A+</a>，只不过它仅仅对原来的标准部分澄清，同时依据实践稍作扩展。</p>
<blockquote>
<p>The core Promises&#x2F;A+ specification does not deal with how to create, fulfill, or reject promises, choosing instead to focus on providing an interoperable(协作的) <strong>then</strong> method. Future work in companion specifications may touch on these subjects.</p>
</blockquote>
<p>但是使用Promise还是有些地方值得留意的。</p>
<h4 id="1-Then的Resovler-Function不返回任何值"><a href="#1-Then的Resovler-Function不返回任何值" class="headerlink" title="1. Then的Resovler Function不返回任何值"></a>1. Then的Resovler Function不返回任何值</h4><hr>
<p>举个例子，打印deferred数组的首个元素</p>
<figure class="highlight javascript"><figcaption><span>promise_sample.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">printFirstAndLast</span>(<span class="params">itemsDeferred</span>)&#123;</span><br><span class="line">    <span class="title function_">findFirst</span>(itemsDeferred).<span class="title function_">then</span>(util.<span class="property">puts</span>); <span class="comment">//=&gt; 0</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">last</span>(itemsDeferred).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">last</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> deferred = <span class="title function_">defer</span>();</span><br><span class="line">        deferred.<span class="title function_">resolve</span>(last);</span><br><span class="line">        <span class="title function_">findFirst</span>(deferred).<span class="title function_">then</span>(util.<span class="property">puts</span>) <span class="comment">//=&gt; 1</span></span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">result</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;result:&#x27;</span>, result); <span class="comment">//=&gt; 2</span></span><br><span class="line">    &#125;, <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;reason:&#x27;</span>, reason);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">last</span>(<span class="params">itemsDeferred</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> itemsDeferred.<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">items</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> items.<span class="title function_">slice</span>(<span class="number">1</span>, items.<span class="property">length</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">findFirst</span>(<span class="params">itemsDeferred</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> itemsDeferred.<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">items</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> items[<span class="number">0</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">---</span><br><span class="line"><span class="keyword">var</span> deferred = <span class="title function_">defer</span>();</span><br><span class="line">deferred.<span class="title function_">resolve</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line"><span class="title function_">printFirstAndLast</span>(deferred);</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="attr">result</span>: <span class="literal">undefined</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>从输出看，由于我故意没有返回1处的Promise对象，最后一个<em>then</em> 的2处代码先被执行，打印出undefined，然后才会执行完1处的代码，打印出数字2。</p>
<p>这样的现象有两处值得注意的地方</p>
<ul>
<li>执行顺序混乱</li>
<li>最后then的结果是undefined</li>
</ul>
<p>顺序混乱是由于标识为1处的resolve的时间较长，回调的时间较久，所以后执行。</p>
<p> 2处为undefined，是因为1处没有返回值，<strong>我们知道javascript的function始终会返回值且这两种方式：<code>return;</code>(返回void)和不显式写return语句都会返回undefined</strong>。所以将值为undefined的promise对象传给下一个<em>then</em>方法。</p>
<h4 id="2-Then的Rejector-Function不返回Reject-Promise"><a href="#2-Then的Rejector-Function不返回Reject-Promise" class="headerlink" title="2. Then的Rejector Function不返回Reject Promise"></a>2. Then的Rejector Function不返回Reject Promise</h4><hr>
<figure class="highlight javascript"><figcaption><span>reject.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">printFirstAndLast</span>(<span class="params">itemsDeferred</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> itemDeferred.<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;, <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">        util.<span class="title function_">puts</span>(<span class="string">&#x27;1:&#x27;</span>+reason);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;error-1&#x27;</span>;</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">result</span>)&#123;</span><br><span class="line">        util.<span class="title function_">puts</span>(<span class="string">&#x27;resolve 2:&#x27;</span>+result);</span><br><span class="line">    &#125;, <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">        util.<span class="title function_">puts</span>(<span class="string">&#x27;reject 2:&#x27;</span>+reason);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> deferred = <span class="title function_">defer</span>();</span><br><span class="line">deferred.<span class="title function_">reject</span>(<span class="string">&#x27;error-0&#x27;</span>);</span><br><span class="line"><span class="title function_">printFirstAndLast</span>(deferred);</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"><span class="number">1</span>: error-<span class="number">0</span></span><br><span class="line">resolve <span class="number">2</span>:error-<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>从输出看，如果reject function不返回reject promise，而只是<code>error-1</code>这样的值，那么调用then方法，执行的还是resolve方法。</p>
<p>从Promise&#x2F;A+参考描述可证明上述</p>
<blockquote>
<p>promise2 &#x3D; promise1.then(onFulfilled, onRejected);</p>
<p>If either onFulfilled or onRejected returns a value x, run the Promise Resolution Procedure [[Resolve]](promise2, x).</p>
<p>If x is a thenable, it attempts to make promise adopt the state of x, under the assumption that x behaves at least somewhat like a promise. Otherwise, it fulfills promise with the value x.</p>
</blockquote>
<h4 id="3-Then的Resolver-Function返回的是对象，而且包含then方法"><a href="#3-Then的Resolver-Function返回的是对象，而且包含then方法" class="headerlink" title="3. Then的Resolver Function返回的是对象，而且包含then方法"></a>3. Then的Resolver Function返回的是对象，而且包含then方法</h4><hr>
<figure class="highlight javascript"><figcaption><span>obj_then.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">then</span>: <span class="keyword">function</span>(<span class="params">resolver, reject</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">resolver</span>(<span class="string">&#x27;i am an obj.&#x27;</span>);</span><br><span class="line">&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printFirstAndLast</span>(<span class="params">itemsDeferred</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> itemDeferred.<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;, <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">        util.<span class="title function_">puts</span>(<span class="string">&#x27;1:&#x27;</span>+reason);</span><br><span class="line">        <span class="keyword">return</span> obj; 						<span class="comment">//=&gt; 1</span></span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">result</span>)&#123;</span><br><span class="line">        util.<span class="title function_">puts</span>(<span class="string">&#x27;resolve 2:&#x27;</span>+result);</span><br><span class="line">    &#125;, <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">        util.<span class="title function_">puts</span>(<span class="string">&#x27;reject 2:&#x27;</span>+reason);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> deferred = <span class="title function_">defer</span>();</span><br><span class="line">deferred.<span class="title function_">reject</span>(<span class="string">&#x27;error-0&#x27;</span>);</span><br><span class="line"><span class="title function_">printFirstAndLast</span>(deferred);</span><br><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"><span class="number">1</span>: error-<span class="number">0</span></span><br><span class="line">resolve <span class="number">2</span>:i am  an obj</span><br></pre></td></tr></table></figure>
<p>从结果看，obj这个含有then方法的对象，在1处被调用了then，同时将<code>resolver(&#39;i am an obj.&#39;)</code>作为Promise返回。</p>
<p>从Promise&#x2F;A+可知</p>
<blockquote>
<p>If then is a function, call it with x as this, first argument resolvePromise, and second argument rejectPromise, where:</p>
<p>If&#x2F;when resolvePromise is called with a value y, run [[Resolve]](promise, y)</p>
<p>If&#x2F;when rejectPromise is called with a reason r, reject promise with r</p>
</blockquote>
<p>那么如果是以下这些对象</p>
<ul>
<li>{then: ‘something’}</li>
<li>{then: function(){}}</li>
<li>{A: ‘A’}</li>
<li>{then: function(resolver, rejector){return rejector(“error”);}}</li>
</ul>
<p>结果会是</p>
<ul>
<li>resolve 2:[Object Object]</li>
<li>忽略</li>
<li>resolve 2:[Object Object]</li>
<li>reject 2: error</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/02/01/Testable-Javascript/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/02/01/Testable-Javascript/" class="post-title-link" itemprop="url">Testable Javascript</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-02-01 15:56:47" itemprop="dateCreated datePublished" datetime="2015-02-01T15:56:47+08:00">2015-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:58:22" itemprop="dateModified" datetime="2016-09-06T22:58:22+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>singletons suffer state pollution between tests</p>
</blockquote>
<figure class="highlight javascript"><figcaption><span>singletons.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">	<span class="attr">counter</span>: <span class="number">0</span>,</span><br><span class="line">	<span class="attr">inc</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> ++<span class="variable language_">this</span>.<span class="property">counter</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><figcaption><span>test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> singleton = <span class="built_in">require</span>(<span class="string">&#x27;singletons&#x27;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">testCase</span>(&#123;</span><br><span class="line">    <span class="string">&quot;should equal one after calling inc&quot;</span>: <span class="keyword">function</span> (<span class="params">test</span>) &#123;</span><br><span class="line">        test.<span class="title function_">equal</span>(<span class="number">1</span>, singleton.<span class="title function_">inc</span>());</span><br><span class="line">        test.<span class="title function_">done</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;should get one after calling inc&quot;</span>: <span class="keyword">function</span>(<span class="params">test</span>) &#123;</span><br><span class="line">    	test.<span class="title function_">equal</span>(<span class="number">1</span>, singleton.<span class="title function_">inc</span>());</span><br><span class="line">    	test.<span class="title function_">done</span>();</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
<p>结果第二个测试会失败，但是从测试本身是看不出为什么第一个可以通过，而第二个则相反。当然，我们可以通过<code>setUp</code>或<code>tearDown</code>方法来重置对象的状态，但是这无疑增加了维护测试的成本，你得记着重置对象这件事本身就是负担。</p>
<p>下面就是解决方案</p>
<figure class="highlight javascript"><figcaption><span>singletons_impr.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> &#123;</span><br><span class="line">		<span class="attr">counter</span>: <span class="number">0</span>,</span><br><span class="line">		<span class="attr">inc</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> ++<span class="variable language_">this</span>.<span class="property">counter</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>再看我们的测试</p>
<figure class="highlight javascript"><figcaption><span>test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> singleton = <span class="built_in">require</span>(<span class="string">&#x27;singletons_impr&#x27;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">testCase</span>(&#123;</span><br><span class="line">    <span class="string">&quot;should equal one after calling inc&quot;</span>: <span class="keyword">function</span> (<span class="params">test</span>) &#123;</span><br><span class="line">        test.<span class="title function_">equal</span>(<span class="number">1</span>, <span class="title function_">singleton</span>().<span class="title function_">inc</span>());</span><br><span class="line">        test.<span class="title function_">done</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;should get one after calling inc&quot;</span>: <span class="keyword">function</span>(<span class="params">test</span>) &#123;</span><br><span class="line">    	test.<span class="title function_">equal</span>(<span class="number">1</span>, <span class="title function_">singleton</span>().<span class="title function_">inc</span>());</span><br><span class="line">    	test.<span class="title function_">done</span>();</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
<p>这样两次返回的对象都是全新的，测试通过。</p>
<p>不过，似乎这样让测试变得更加麻烦了，好处不明显。但是结合这篇文章<a target="_blank" rel="noopener" href="http://yanqian.me/2015/01/27/Javascript-Modularize-2nd/">[Javascript Modularize 2nd]</a>，就会巧妙地解决多个模块依赖某一个模块，某个模块修改被传染至其他模块的问题。因为每个被引入的模块都将被重新执行生成一遍，成为独立的对象。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><ul>
<li><code>module.exports</code>最好使用<code>function</code>方式导出。</li>
</ul>
<p>参考链接<br>[1]  <a target="_blank" rel="noopener" href="http://www.adequatelygood.com/Writing-Testable-JavaScript.html">Writing Testable JavaScript</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/01/30/Javascript-Scope/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/01/30/Javascript-Scope/" class="post-title-link" itemprop="url">Javascript Scope</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-01-30 17:08:44" itemprop="dateCreated datePublished" datetime="2015-01-30T17:08:44+08:00">2015-01-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:58:19" itemprop="dateModified" datetime="2016-09-06T22:58:19+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>The extent of a scope refers to the lifetime of a variable (i.e., how long a variable holds a certain value)</p>
</blockquote>
<h3 id="Global-Scope"><a href="#Global-Scope" class="headerlink" title="Global Scope"></a>Global Scope</h3><p>Javascript中任意不使用var创建的变量具有全局作用域。</p>
<figure class="highlight javascript"><figcaption><span>global</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">globalVariable = <span class="string">&quot;global&quot;</span>;</span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(globalVariable);</span><br><span class="line">&#125;)()</span><br><span class="line"></span><br><span class="line">-&gt; <span class="variable language_">global</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> globalVariable;</span><br><span class="line"></span><br><span class="line">-&gt; <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>当然，任意定义在文件最顶层的变量，事实上，由于<a target="_blank" rel="noopener" href="http://yanqian.me/2015/01/27/Javascript-Hoisting/">Javascript Hositing</a>作用，所有定义在最外层的变量都会被提升至作用域首部，都具有全局作用域。</p>
<p>值得注意的是使用var定义的变量是不能delete的，它不是全局变量的属性：</p>
<figure class="highlight javascript"><figcaption><span>del_variable</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> globalVariable = <span class="string">&#x27;global&#x27;</span>;</span><br><span class="line"><span class="keyword">delete</span> globalVariable;</span><br><span class="line"></span><br><span class="line">-&gt; <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>除此之外，任意被暴露到最外层的变量，一旦被全局作用域捕获，其本身都会存在被随意修改的风险。</p>
<h3 id="Lexical-Scope"><a href="#Lexical-Scope" class="headerlink" title="Lexical Scope"></a>Lexical Scope</h3><blockquote>
<p>Lexical scope refers to the visibility of a variable and its value analogous to its textual representation.</p>
</blockquote>
<p>Javascript会从内向外寻找变量的绑定，所以变量的定义距离使用处最近，则该变量会被使用。</p>
<figure class="highlight javascript"><figcaption><span>lexical_scope</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">lexicalScope</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> lexicalVariable = <span class="string">&quot;outer&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">		<span class="keyword">var</span> lexicalVariable = <span class="string">&quot;inner&quot;</span>;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(lexicalVariable);</span><br><span class="line">		(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">			<span class="keyword">var</span> lexicalVariable = <span class="string">&quot;innerMost&quot;</span>;</span><br><span class="line">			<span class="variable language_">console</span>.<span class="title function_">log</span>(lexicalVariable);</span><br><span class="line">		&#125;)();</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(lexicalVariable);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">lexicalScope</span>();</span><br><span class="line">-&gt; inner</span><br><span class="line">innerMost</span><br><span class="line">inner</span><br></pre></td></tr></table></figure>

<h3 id="Dynamic-Scope"><a href="#Dynamic-Scope" class="headerlink" title="Dynamic Scope"></a>Dynamic Scope</h3><blockquote>
<p>the value of any given binding cannot be known until the caller of any given function is known— which may be too late.</p>
</blockquote>
<figure class="highlight javascript"><figcaption><span>dynamic_scope</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">globalThis</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="variable language_">this</span>; &#125;</span><br><span class="line"><span class="title function_">globalThis</span>();</span><br><span class="line">-&gt; some <span class="variable language_">global</span> object, probably <span class="title class_">Window</span></span><br><span class="line">globalThis.<span class="title function_">call</span>(<span class="string">&#x27;barnabas&#x27;</span>);</span><br><span class="line">-&gt; <span class="string">&#x27;barnabas&#x27;</span></span><br><span class="line">globalThis.<span class="title function_">apply</span>(<span class="string">&#x27;orsulak&#x27;</span>, [])</span><br><span class="line">-&gt; <span class="string">&#x27;orsulak&#x27;</span></span><br></pre></td></tr></table></figure>
<p>在Javascript中，<em>this</em>所处的作用域就是动态作用域。也就是说，<em>globalThis()<em>返回值完全由调用方决定，</em>this</em>变量的对照表是不断改变的。更多参考<a target="_blank" rel="noopener" href="http://yanqian.me/2014/10/11/funcation-scope/">这里</a></p>
<h3 id="Function-Scope"><a href="#Function-Scope" class="headerlink" title="Function Scope"></a>Function Scope</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function strangerIdentity(n) &#123;</span><br><span class="line">	for(this[&#x27;i&#x27;] = 0; this[&#x27;i&#x27;] &lt; n; this[&#x27;i&#x27;]++);</span><br><span class="line">	return this[&#x27;i&#x27;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--- case 1</span><br><span class="line">strangerIdentity(100);</span><br><span class="line">-&gt; 100</span><br><span class="line">i</span><br><span class="line">-&gt; 100</span><br><span class="line"></span><br><span class="line">--- case 2</span><br><span class="line">var id = new strangerIdentity(100);</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line">-&gt; strangerIdentity &#123;i: 100&#125;</span><br><span class="line">id.i</span><br><span class="line">-&gt; 100</span><br><span class="line">i</span><br><span class="line">-&gt;  Uncaught ReferenceError: i is not defined</span><br></pre></td></tr></table></figure>
<p>在Javascript中，只有一个<strong>Function</strong>才会产生新的作用域。直接调用一个funcation，其内部的指针指向global对象。但当使用<em>new</em>后，其作用域绑定到一个<strong>Function Object</strong>上。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/01/28/Javascript-Reference/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/01/28/Javascript-Reference/" class="post-title-link" itemprop="url">Javascript Reference</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-01-28 23:23:14" itemprop="dateCreated datePublished" datetime="2015-01-28T23:23:14+08:00">2015-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:58:16" itemprop="dateModified" datetime="2016-09-06T22:58:16+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Javascript的赋值操作就是引用修改，举个例子：</p>
<figure class="highlight javascript"><figcaption><span>reference.js</span><a target="_blank" rel="noopener" href="https://github.com/heldr/grunt-properties">grunt-properties</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">splitKeys</span>(<span class="params">obj, splitter</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> keys, value, parent, result = &#123;&#125;;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">          keys = key.<span class="title function_">split</span>(splitter);</span><br><span class="line">          value = obj[key].<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>);</span><br><span class="line">          parent = result;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; keys.<span class="property">length</span>-<span class="number">1</span>; j++) &#123;</span><br><span class="line">              parent = parent[keys[j]] = parent[keys[j]] || &#123;&#125;;</span><br><span class="line">          &#125;</span><br><span class="line">          parent[keys[keys.<span class="property">length</span>-<span class="number">1</span>]] = value;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(result, <span class="literal">null</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码将Java程序中的常见的Properties文件中的键值映射成了嵌套的JSON对象:</p>
<figure class="highlight javascript"><figcaption><span>test.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;country.province.city&quot;</span>: <span class="string">&quot;Chengdu&quot;</span>&#125;;</span><br><span class="line"><span class="title function_">splitKeys</span>(obj, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">-&gt; <span class="string">&quot;&#123;</span></span><br><span class="line"><span class="string">  &quot;</span>country<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;</span>province<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;</span>city<span class="string">&quot;: &quot;</span><span class="title class_">Chengdu</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<p>我们从实现代码的这行开始看起<code>parent = result;</code>，很简单地把<code>parent</code>指向<code>result</code>这个空对象。</p>
<p>再看接下来的代码，也是最巧妙的地方：</p>
<figure class="highlight javascript"><figcaption><span>parts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; keys.<span class="property">length</span>-<span class="number">1</span>; j++) &#123;</span><br><span class="line">     parent = parent[keys[j]] = parent[keys[j]] || &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一次循环：<br>parent开始是空对象，<code>parent = parent[&#39;country&#39;] = parent[&#39;country&#39;] || &#123;&#125;;</code>，将会生成一个parent的country属性，该属性的值还是一个空对象。于此同时，parent会指向新生成的、也即它的country属性。</p>
<p>第二次循环：<br>parent指向了country，<code>parent = parent[&#39;province&#39;] = parent[&#39;province&#39;] || &#123;&#125;;</code>也即<code>parent = country[&#39;province&#39;] = country[&#39;province&#39;] || &#123;&#125;;</code>，此时，将会生成一个country的province属性，该属性的值还是一个空对象，而parent则指向了province对象。</p>
<p>所以<code> parent[keys[keys.length-1]] = value;</code>等价为<code>province[&#39;city&#39;] = &quot;Chengdu&quot;;</code></p>
<p>最后，<code>return JSON.stringify(result, null, 2);</code>，这最后的result就是具有嵌套效果的JSON对象了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/01/27/Javascript-Hoisting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/01/27/Javascript-Hoisting/" class="post-title-link" itemprop="url">Javascript Hoisting</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-01-27 22:47:12" itemprop="dateCreated datePublished" datetime="2015-01-27T22:47:12+08:00">2015-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2017-10-23 19:35:24" itemprop="dateModified" datetime="2017-10-23T19:35:24+08:00">2017-10-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>编程过程中，别人谈到Javascript中的funcation是顺序执行的，所以书写的顺序要留心，不然会出未定义就执行的错误。当然，C语言出身的程序员不以为意，会认为理所当然，C语言就是这么干的。但Javascript并非如此！</p>
<figure class="highlight javascript"><figcaption><span>ints.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">ints</span>(<span class="params">arrOfNumberStr</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> arrOfNumberStr.<span class="title function_">map</span>(toInt);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">toInt</span>(<span class="params">str</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parseInt</span>(str, <span class="number">10</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">ints</span>([<span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;11&#x27;</span>]);</span><br><span class="line">-&gt; [<span class="number">11</span>, <span class="number">11</span>, <span class="number">11</span>]</span><br></pre></td></tr></table></figure>
<p>从执行结果上来看，先调用后执行时正确的。但是JS是解析执行的，如果没有预先定义，执行到调用处必然会失败，那么为什么这段代码可以工作呢？</p>
<p>先看一段略做修改之后的代码</p>
<figure class="highlight javascript"><figcaption><span>ints_fail.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">ints</span>(<span class="params">arrOfNumberStr</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> arrOfNumberStr.<span class="title function_">map</span>(toInt);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> toInt = <span class="keyword">function</span>(<span class="params">str</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parseInt</span>(str, <span class="number">10</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">ints</span>([<span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;11&#x27;</span>]);</span><br><span class="line">-&gt; <span class="title class_">TypeError</span>: <span class="literal">undefined</span> is not a <span class="keyword">function</span></span><br></pre></td></tr></table></figure>
<p>执行结果失败了。回头看这两段代码的定义，不难发现程序对于<code>toInt</code>的定义方式有差别，一种用常规的函数定义方式，一种使用<strong>var</strong>定义。</p>
<p>接着再看一段代码</p>
<figure class="highlight javascript"><figcaption><span>variables.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">loop</span>(<span class="params">n</span>) &#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;n; i++);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">loop</span>(<span class="number">10</span>);</span><br><span class="line">-&gt; <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>估计学习C语言的人开始惊讶了：这个<code>i</code>的作用域不是应该只在<code>for loop</code>中吗？</p>
<p>那么到底是什么原因造成的呢？这就是Javascript Hoisting！简单解释，声明提升到作用域的最前面。</p>
<p>接上面的<em>variable.js</em></p>
<figure class="highlight javascript"><figcaption><span>variables_hoisting.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">loop</span>(<span class="params">n</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;n; i++);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这和原来的写法是等价的，所以<code>i</code>的作用域在整个<code>function</code>中都是有效的。依次类推，<em>init_fail.js</em>中的<code>var toInt</code>这样的函数声明也会被提升到作用域的最上方，但是只是声明被提升了，真正赋值还是在后面，所以此时调用该函数，它还是<code>undefined</code>。</p>
<p>但是对于<em>init.js</em>而言，它的声明方式会将整个函数都提升，所以它是先于调用方赋值初始化的，所以能工作。</p>
<h3 id="‘use-strict’-可以防止-only-reference-hoisting"><a href="#‘use-strict’-可以防止-only-reference-hoisting" class="headerlink" title="‘use strict’ 可以防止 only reference hoisting?"></a>‘use strict’ 可以防止 only reference hoisting?</h3><hr>
<p>如果变量未声明，<strong>use strict</strong>模式下赋值会报错。</p>
<figure class="highlight javascript"><figcaption><span>use_strict.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> foo = <span class="number">123</span>;<span class="comment">//works fine</span></span><br><span class="line">    bar = <span class="number">345</span>;<span class="comment">//ReferenceError: bar is not defined</span></span><br><span class="line">&#125;());</span><br></pre></td></tr></table></figure>
<p>如果在以前例子中使用<strong>use strict</strong>，并不能提前报出<code>toInt</code>未赋值的错误。直到运行期间，才会发现<code>toInt</code>依然<code>undefined</code>。</p>
<figure class="highlight javascript"><figcaption><span>use_strict_for_hoisting.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span> <span class="title function_">ints</span>(<span class="params">arrOfNumberStr</span>) &#123;</span><br><span class="line">	<span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">	<span class="keyword">return</span> arrOfNumberStr.<span class="title function_">map</span>(toInt);</span><br><span class="line">	<span class="keyword">var</span> toInt = <span class="keyword">function</span>(<span class="params">str</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">parseInt</span>(str, <span class="number">10</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)([<span class="string">&#x27;11&#x27;</span>, <span class="string">&#x27;11&#x27;</span>]);</span><br><span class="line">-&gt; <span class="title class_">Uncaught</span> <span class="title class_">TypeError</span>: <span class="literal">undefined</span> is not a <span class="keyword">function</span>(<span class="params">…</span>)</span><br></pre></td></tr></table></figure>

<h3 id="优先使用function-declaration"><a href="#优先使用function-declaration" class="headerlink" title="优先使用function declaration"></a>优先使用function declaration</h3><hr>
<blockquote>
<p>Why? Function declarations are named, so they’re easier to identify in call stacks. Also, the whole body of a function declaration is hoisted, whereas only the reference of a function expression is hoisted. This rule makes it possible to always use Arrow Functions in place of function expressions. – from <a target="_blank" rel="noopener" href="https://github.com/airbnb/javascript#functions">javascript style guide</a></p>
</blockquote>
<p>下篇会记录Javascript的<a target="_blank" rel="noopener" href="http://lambeta.com/2015/01/30/Javascript-Scope/">作用域</a>，<code>Global Scope, Lexical Scope, Dynamic Scope, Function Scope</code></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/01/27/Javascript-Modularize-2nd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/01/27/Javascript-Modularize-2nd/" class="post-title-link" itemprop="url">Javascript Modularize 2nd</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-01-27 00:01:26" itemprop="dateCreated datePublished" datetime="2015-01-27T00:01:26+08:00">2015-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:39:55" itemprop="dateModified" datetime="2016-09-06T22:39:55+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="NodeJS-Module-require"><a href="#NodeJS-Module-require" class="headerlink" title="NodeJS Module require"></a>NodeJS Module require</h4><p>require实现了CommonJS标准，在Node中作为一个全局的函数来支持模块管理。<br>但是开发中遇到了一个有意思的场景：</p>
<p>假如ModuleA和ModuleB同时依赖一个第三方库，简单起见，设为<code>var Foo = &#123;request: &#39;foo&#39;&#125;</code></p>
<p>现在ModuleA引入Foo.js</p>
<figure class="highlight javascript"><figcaption><span>ModuleA</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Foo</span> = <span class="built_in">require</span>(<span class="string">&#x27;Foo&#x27;</span>);</span><br><span class="line"><span class="title class_">Foo</span>.<span class="property">request</span> = <span class="string">&#x27;bar&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>ModuleB中也引入Foo.js</p>
<figure class="highlight javascript"><figcaption><span>ModuleB</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Foo</span> = <span class="built_in">require</span>(<span class="string">&#x27;Foo&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Foo</span>.<span class="property">request</span>); <span class="comment">//bar</span></span><br></pre></td></tr></table></figure>
<p>结果是这个对象的属性被改变了！这不就相当于全局变量了吗？</p>
<p>不过，据此可以推测NodeJS是如何实现require的：</p>
<ol>
<li>内部把依赖的module用function包装了一遍，使得require的变量变成私有的；</li>
<li>内部使用缓存机制，防止重复加载相同的JS文件。</li>
</ol>
<figure class="highlight javascript"><figcaption><span>module.js</span><a target="_blank" rel="noopener" href="https://github.com/joyent/node/blob/069dd07a1732c6a752773aaed9e8c18ab472375f/lib/module.js#L354">NodeJs</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">require</span> = <span class="keyword">function</span>(<span class="params">path</span>) &#123;</span><br><span class="line">  <span class="title function_">assert</span>(util.<span class="title function_">isString</span>(path), <span class="string">&#x27;path must be a string&#x27;</span>);</span><br><span class="line">  <span class="title function_">assert</span>(path, <span class="string">&#x27;missing path&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Module</span>.<span class="title function_">_load</span>(path, <span class="variable language_">this</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面这段代码就是require源代码，直接进入_load：</p>
<figure class="highlight javascript"><figcaption><span>Module._load</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Module</span>.<span class="property">_load</span> = <span class="keyword">function</span>(<span class="params">request, parent, isMain</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (parent) &#123;</span><br><span class="line">    <span class="title function_">debug</span>(<span class="string">&#x27;Module._load REQUEST  &#x27;</span> + (request) + <span class="string">&#x27; parent: &#x27;</span> + parent.<span class="property">id</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> filename = <span class="title class_">Module</span>.<span class="title function_">_resolveFilename</span>(request, parent);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> cachedModule = <span class="title class_">Module</span>.<span class="property">_cache</span>[filename];</span><br><span class="line">  <span class="keyword">if</span> (cachedModule) &#123;</span><br><span class="line">    <span class="keyword">return</span> cachedModule.<span class="property">exports</span>;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="keyword">new</span> <span class="title class_">Module</span>(filename, parent);</span><br><span class="line">...</span><br><span class="line">  <span class="title class_">Module</span>.<span class="property">_cache</span>[filename] = <span class="variable language_">module</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> hadException = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable language_">module</span>.<span class="title function_">load</span>(filename); <span class="comment">//invoke extensions[&#x27;.js|json&#x27;] -&gt; _compile js</span></span><br><span class="line">    hadException = <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hadException) &#123;</span><br><span class="line">      <span class="keyword">delete</span> <span class="title class_">Module</span>.<span class="property">_cache</span>[filename];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">module</span>.<span class="property">exports</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我省略一些无关紧要的代码，仅从以上代码可以看出，确实有cache使用了，所以require到内存中的对象其实只有一个！</p>
<figure class="highlight plaintext"><figcaption><span>Module.prototype._compile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// create wrapper function</span><br><span class="line">  var wrapper = Module.wrap(content);</span><br><span class="line">  var compiledWrapper = runInThisContext(wrapper, &#123; filename: filename &#125;);</span><br><span class="line">...</span><br><span class="line">  var args = [self.exports, require, self, filename, dirname];</span><br><span class="line">  return compiledWrapper.apply(self.exports, args);</span><br></pre></td></tr></table></figure>
<p>上面是一小段compile的代码，执行到这里的顺序是_load -&gt; _extensions[‘.js’] -&gt; _compile.<br>可以看到确实进行了wrap操作，将js文件中的内容wrap成一个function, 最后传入self.exports (module.exports)，这样module.exports便继承了原JS执行的结果。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2015/01/25/Javascript-Modularize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/01/25/Javascript-Modularize/" class="post-title-link" itemprop="url">Javascript Modularize</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-01-25 17:28:40" itemprop="dateCreated datePublished" datetime="2015-01-25T17:28:40+08:00">2015-01-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:55:53" itemprop="dateModified" datetime="2016-09-06T22:55:53+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Closure"><a href="#Closure" class="headerlink" title="Closure"></a>Closure</h3><h4 id="什么是闭包？"><a href="#什么是闭包？" class="headerlink" title="什么是闭包？"></a>什么是闭包？</h4><blockquote>
<p>一个包含了自由变量的开发表达式，和该自由变量的约束环境组合之后，产生了一种封闭的状态。</p>
</blockquote>
<p>举个例子，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">inc</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> counter = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> counter++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//invoke</span></span><br><span class="line"><span class="keyword">var</span> id = <span class="title function_">inc</span>();</span><br><span class="line"><span class="title function_">id</span>(); <span class="comment">//0</span></span><br><span class="line"><span class="title function_">id</span>(); <span class="comment">//1</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>变量counter只在inc中可见，inc就是counter的约束环境，而内部的function就是开放的表达式，达到的封闭状态就是闭包。</p>
<h3 id="Javascript-Closure"><a href="#Javascript-Closure" class="headerlink" title="Javascript Closure"></a>Javascript Closure</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">window</span>);</span><br><span class="line">&#125;())</span><br><span class="line">or</span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">window</span>);</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<p>注意两种闭包的写法: **()**一个在内，另一个在外，两者是等价的。<br>这种写法有两个作用</p>
<ol>
<li>立即执行(Immediately-Invoked Function Expression, IIFE)</li>
<li>封装内部变量，使之对外不可见</li>
</ol>
<p><strong>NOTICE</strong><br><code>对外不可见，不代表闭包内部不能访问全局变量。闭包内部是可以访问外部变量的，如上面的例子所示</code></p>
<blockquote>
<p>JavaScript has a feature known as implied globals. Whenever a name is used, the interpreter walks the scope chain backwards looking for a var statement for that name. If none is found, that variable is assumed to be global. If it’s used in an assignment, the global is created if it doesn’t already exist. This means that using or creating global variables in an anonymous closure is easy. Unfortunately, this leads to hard-to-manage code, as it’s not obvious (to humans) which variables are global in a given file.</p>
</blockquote>
<p>以上就是理由。这种做法不好的地方有三个：</p>
<ol>
<li>代码不便管理，这是全局变量的弊病</li>
<li>依赖关系不明确</li>
<li>性能损失，因为需要向后查找变量声明</li>
</ol>
<p>正确的做法是导入作用域</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(function(window)&#123;</span><br><span class="line">	console.log(window);</span><br><span class="line">&#125;)(window)</span><br></pre></td></tr></table></figure>

<p>借助closure，我们可以简单实现JS的模块化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var module = (function()&#123;</span><br><span class="line">	var counter = 0;</span><br><span class="line">	return &#123;</span><br><span class="line">		inc: function() &#123;</span><br><span class="line">			return counter++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">//invoke</span><br><span class="line">module.counter //undefined</span><br><span class="line">module.inc(); //0</span><br><span class="line">module.inc(); //1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="Augmentation-mixin-trait-…"><a href="#Augmentation-mixin-trait-…" class="headerlink" title="Augmentation (mixin, trait …)"></a>Augmentation (mixin, trait …)</h3><p>模块化之后，如何扩展这部分的功能？</p>
<h4 id="Loose-augmentation"><a href="#Loose-augmentation" class="headerlink" title="Loose augmentation"></a>Loose augmentation</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var module = (function(self)&#123;</span><br><span class="line"></span><br><span class="line">	self.todo = function() &#123;</span><br><span class="line">		console.log(&#x27;cannot access counter&#x27;);</span><br><span class="line">	&#125;</span><br><span class="line">	return self;</span><br><span class="line">&#125;)(module || &#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>之所以称为宽松augmentation，是因为多个modules可以异步加载。如果变量没有声明，就会重新创建。与之对应的就是Tight augmentation</p>
<h4 id="Tight-augmentation"><a href="#Tight-augmentation" class="headerlink" title="Tight augmentation"></a>Tight augmentation</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var module = (function(self)&#123;</span><br><span class="line"></span><br><span class="line">	self.todo = function() &#123;</span><br><span class="line">		console.log(&#x27;cannot access counter&#x27;);</span><br><span class="line">	&#125;</span><br><span class="line">	return self;</span><br><span class="line">&#125;)(module)</span><br></pre></td></tr></table></figure>
<p>这样就要求严格的加载顺序了。</p>
<p>更多模式参考 <a target="_blank" rel="noopener" href="http://www.adequatelygood.com/JavaScript-Module-Pattern-In-Depth.html">JavaScript Module Pattern: In-Depth</a></p>
<p>通用的JS规范共有两种：CommonJS和AMD</p>
<h3 id="CommonJS"><a href="#CommonJS" class="headerlink" title="CommonJS"></a>CommonJS</h3><p>该标准中，有一个自由函数require，用于加载模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//math.js</span><br><span class="line">exports.add = function() &#123;</span><br><span class="line">    var sum = 0, i = 0, args = arguments, l = args.length;</span><br><span class="line">    while (i &lt; l) &#123;</span><br><span class="line">        sum += args[i++];</span><br><span class="line">    &#125;</span><br><span class="line">    return sum;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这样就可以在其他模块中引用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//increment.js</span><br><span class="line">var add = require(&#x27;math&#x27;).add;</span><br><span class="line">exports.increment = function(val) &#123;</span><br><span class="line">    return add(val,1);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>NOTICE</strong></p>
<p><code>任何require进来的模块，其变量都是私有的</code></p>
<p>举个例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//program.js</span><br><span class="line">var inc = require(&#x27;increment&#x27;).increment;</span><br><span class="line">var a = 1;</span><br><span class="line">inc(a); // 2</span><br><span class="line">inc.add //undefined</span><br><span class="line">module.id == &quot;program&quot;;</span><br></pre></td></tr></table></figure>
<p>这里的inc.add对于program.js是不可见的。</p>
<p>NodeJs的模块系统实现了改标准 <a target="_blank" rel="noopener" href="http://nodejs.org/docs/latest/api/modules.html">Nodejs Module</a></p>
<h3 id="AMD-Asynchronous-Module-Definition"><a href="#AMD-Asynchronous-Module-Definition" class="headerlink" title="AMD (Asynchronous Module Definition)"></a>AMD (Asynchronous Module Definition)</h3><p>对于浏览器环境，由于js文件在服务端，异步加载使得CommonJS不实用了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">define(&quot;alpha&quot;, [&quot;require&quot;, &quot;exports&quot;, &quot;beta&quot;],</span><br><span class="line">function (require, exports, beta) &#123;</span><br><span class="line">       exports.verb = function() &#123;</span><br><span class="line">           return beta.verb();</span><br><span class="line">           //Or:</span><br><span class="line">           return require(&quot;beta&quot;).verb();</span><br><span class="line">       &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这样，只有等到所有的模块加载成功后，才会调用回调函数。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2014/11/19/maven-in-action/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/11/19/maven-in-action/" class="post-title-link" itemprop="url">maven in action</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-11-19 22:20:49" itemprop="dateCreated datePublished" datetime="2014-11-19T22:20:49+08:00">2014-11-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-02-02 10:59:16" itemprop="dateModified" datetime="2018-02-02T10:59:16+08:00">2018-02-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="maven-phases-and-plugins-goal"><a href="#maven-phases-and-plugins-goal" class="headerlink" title="maven phases and plugins goal"></a>maven phases and plugins goal</h2><h3 id="three-built-in-Lifecycle"><a href="#three-built-in-Lifecycle" class="headerlink" title="three built-in Lifecycle"></a>three built-in Lifecycle</h3><ul>
<li>default</li>
<li>clean</li>
<li>site</li>
</ul>
<h3 id="built-in-Lifecycle-is-made-up-of-phases"><a href="#built-in-Lifecycle-is-made-up-of-phases" class="headerlink" title="built-in Lifecycle is made up of phases"></a>built-in Lifecycle is made up of phases</h3><ul>
<li>default<ul>
<li>validate - validate project is correct and all neccessary infomation is avaiable</li>
<li>compile</li>
<li>test</li>
<li>package</li>
<li>integration-test</li>
<li>verify - run and checks to verify the package is valid and meets quality criteria</li>
<li>install - install to local repository</li>
<li>deploy - copy the final package to the remote repository for sharing.</li>
</ul>
</li>
</ul>
<h3 id="a-build-phase-is-made-up-of-plugin-goals"><a href="#a-build-phase-is-made-up-of-plugin-goals" class="headerlink" title="a build phase is made up of plugin goals"></a>a build phase is made up of plugin goals</h3><ul>
<li>a plugin goal represents a specific task, and bound to those build phases.</li>
<li>it’s bound to zero or more build phases</li>
<li><code>mvn clean dependency:copy-dependencies package</code></li>
<li>a phase can also have zero or more goals bound to it. if a build phase has no goals bound to it, it cannot execute.</li>
</ul>
<p><code>编写插件的时候，我们会给每一个goal默认绑定一个phase，所以在对应的plugin中，我们或许不需要显式绑定两者</code></p>
<h3 id="maven-core-concept-coordinate-and-dependency"><a href="#maven-core-concept-coordinate-and-dependency" class="headerlink" title="maven core concept: coordinate and dependency"></a>maven core concept: coordinate and dependency</h3><h4 id="coordinate"><a href="#coordinate" class="headerlink" title="coordinate"></a>coordinate</h4><ul>
<li>groupId</li>
<li>artifactId</li>
<li>version</li>
<li>packaging - jar（default）, war</li>
<li>classfier - javadoc.jar, sources.jar. cannot defined directly</li>
</ul>
<h4 id="dependency"><a href="#dependency" class="headerlink" title="dependency"></a>dependency</h4><ul>
<li>dependency scope: (compile, test, provided, runtime, system, import), provided(servlet-api) system should with systemPath.</li>
<li>transitive dependency</li>
<li>dependency mediate (the shortest path, otherwise declartive order in pom)</li>
<li>execlusion dependency(groupId &amp; artifactId)</li>
</ul>
<p>How to look for dependency</p>
<p><code>mvn dependency:list mvn dependency:tree</code></p>
<p><code>mvn dependency:analyze</code> : 标注声明但未使用的依赖或者使用但未声明的依赖(传递依赖)</p>
<h4 id="dependency-management"><a href="#dependency-management" class="headerlink" title="dependency management"></a>dependency management</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">    ...</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/dependencyManagement&gt;</span><br></pre></td></tr></table></figure>
<p><code>防止subModules继承不必要的依赖，同时如果需要，只要在subModule中声明此依赖的groupId, artifactId，无需对应的versionId，因为这是可以继承自parentModule的</code></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2014/11/17/funny-q/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/11/17/funny-q/" class="post-title-link" itemprop="url">funny Q</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-11-17 23:27:44" itemprop="dateCreated datePublished" datetime="2014-11-17T23:27:44+08:00">2014-11-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:39:24" itemprop="dateModified" datetime="2016-09-06T22:39:24+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="funny-Q"><a href="#funny-Q" class="headerlink" title="funny Q"></a>funny Q</h2><h3 id="q"><a href="#q" class="headerlink" title="$q"></a>$q</h3><blockquote>
<p>$q can be used in two fashions — one which is more similar to Kris Kowal’s Q or jQuery’s Deferred implementations, and the other which resembles ES6 promises to some degree.</p>
</blockquote>
<h3 id="ES6-style"><a href="#ES6-style" class="headerlink" title="ES6 style"></a>ES6 style</h3><blockquote>
<p>The streamlined ES6 style promise is essentially just using $q as a constructor which takes a resolver function as the first argument. </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// assume that $q and $resource are available.</span><br><span class="line">function = asyncGo() &#123;</span><br><span class="line">    return $q( function(resolve, reject) &#123;</span><br><span class="line">        $resource(&quot;www.example.com&quot;, &#123;&#125;, &#123;&#125;)</span><br><span class="line">        .get(&#123;&#125;, function(result) &#123;</span><br><span class="line">            resolve(&quot;hello, &quot; + result);</span><br><span class="line">        &#125;, function(error) &#123;</span><br><span class="line">            reject(&quot;sorry, &quot; + error + &quot; is not allowed&quot;);</span><br><span class="line">        &#125;) </span><br><span class="line">        &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var promise = asyncGo();</span><br><span class="line">promise.then(function(greeting)&#123;</span><br><span class="line">    console.log(greeting);</span><br><span class="line">&#125;, function(err)&#123;</span><br><span class="line">    console.log(err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Deferred-style"><a href="#Deferred-style" class="headerlink" title="Deferred style"></a>Deferred style</h3><blockquote>
<p>The purpose of the deferred object is to expose the associated Promise instance as well as APIs that can be used for signaling the successful or unsuccessful completion, as well as the status of the task.</p>
</blockquote>
<ul>
<li><p>resolve(value) – resolves the derived promise with the value. If the value is a rejection constructed via $q.reject, the promise will be rejected instead.</p>
</li>
<li><p>reject(reason) – rejects the derived promise with the reason. This is equivalent to resolving it with a rejection constructed via $q.reject.</p>
</li>
<li><p>notify(value) - provides updates on the status of the promise’s execution. This may be called multiple times before the promise is either resolved or rejected.</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">promiseB = promiseA.then(function(result) &#123;</span><br><span class="line">  return result + 1;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// promiseB will be resolved immediately after promiseA is resolved and its value</span><br><span class="line">// will be the result of promiseA incremented by 1</span><br></pre></td></tr></table></figure>

<h3 id="q-vs-rootScope"><a href="#q-vs-rootScope" class="headerlink" title="$q vs. $rootScope"></a>$q vs. $rootScope</h3><h4 id="q-is-integrated-with-the-rootScope-Scope-Scope-model-observation-mechanism-in-angular"><a href="#q-is-integrated-with-the-rootScope-Scope-Scope-model-observation-mechanism-in-angular" class="headerlink" title="$q is integrated with the $rootScope.Scope Scope model observation mechanism in angular"></a>$q is integrated with the $rootScope.Scope Scope model observation mechanism in angular</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">it(&#x27;should simulate promise&#x27;, inject(function($q, $rootScope) &#123;</span><br><span class="line">  var deferred = $q.defer();</span><br><span class="line">  var promise = deferred.promise;</span><br><span class="line">  var resolvedValue;</span><br><span class="line"></span><br><span class="line">  promise.then(function(value) &#123; resolvedValue = value; &#125;);</span><br><span class="line">  expect(resolvedValue).toBeUndefined();</span><br><span class="line"></span><br><span class="line">  // Simulate resolving of promise</span><br><span class="line">  deferred.resolve(123);</span><br><span class="line">  // Note that the &#x27;then&#x27; function does not get called synchronously.</span><br><span class="line">  // This is because we want the promise API to always be async, whether or not</span><br><span class="line">  // it got called synchronously or asynchronously.</span><br><span class="line">  expect(resolvedValue).toBeUndefined();</span><br><span class="line"></span><br><span class="line">  // Propagate promise resolution to &#x27;then&#x27; functions using $apply().</span><br><span class="line">  $rootScope.$apply();</span><br><span class="line">  expect(resolvedValue).toEqual(123);</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<h3 id="then"><a href="#then" class="headerlink" title="then"></a>then</h3><p><code>then</code> that can accept three arguments(three callback types)–success, failure, progress.<br>for defer object, resolve will apply to success, reject apply to failure and notify apply to progress.</p>
<p>a defer object contains always, done, fail methods! so the always and done will trigger if resovle be called and return a promise object, which contains resolved result.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qianyan.github.io/2014/11/09/thinking-about-microservice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ryan Qian">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="鄢倩">
      <meta itemprop="description" content="Senior Consultant | DevOps Master | Blockchain & Web3 Specialist">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 鄢倩">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/11/09/thinking-about-microservice/" class="post-title-link" itemprop="url">Thinking about microservice</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-11-09 23:19:14" itemprop="dateCreated datePublished" datetime="2014-11-09T23:19:14+08:00">2014-11-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2016-09-06 22:39:18" itemprop="dateModified" datetime="2016-09-06T22:39:18+08:00">2016-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="谈谈我对microservice的理解"><a href="#谈谈我对microservice的理解" class="headerlink" title="谈谈我对microservice的理解"></a>谈谈我对microservice的理解</h2><h2 id="1-在比较中理解"><a href="#1-在比较中理解" class="headerlink" title="1. 在比较中理解"></a>1. 在比较中理解</h2><h3 id="功能上"><a href="#功能上" class="headerlink" title="功能上"></a>功能上</h3><h4 id="传统的service"><a href="#传统的service" class="headerlink" title="传统的service"></a>传统的service</h4><ul>
<li>功能全面，大而全；</li>
<li>系统内部耦合严重，数据服务部分互相依赖，逻辑错综复杂；</li>
<li>表现层和服务层耦合，解除耦合难以实现；</li>
<li>整个应用程序独立存在，完全不可以复用。</li>
</ul>
<h4 id="新型的microservice"><a href="#新型的microservice" class="headerlink" title="新型的microservice"></a>新型的microservice</h4><ul>
<li>多模块，每个模块功能单一；</li>
<li>采用统一的数据传输格式；</li>
<li>数据服务单独部署，可以互相依赖；</li>
<li>采用RESTful服务标准，表现层和服务层解耦；</li>
<li>分布式部署，服务可以冗余，容灾</li>
<li>采用分布式事务：BASE原则，1. Basiclly Available 2. Soft state 3.Eventually Consistent</li>
</ul>
<h3 id="开发中"><a href="#开发中" class="headerlink" title="开发中"></a>开发中</h3><h4 id="传统的service-1"><a href="#传统的service-1" class="headerlink" title="传统的service"></a>传统的service</h4><ul>
<li>代码组织结构和逻辑复杂，难以阅读；</li>
<li>功能性测试简单；</li>
<li>系统对外暴露较少，沟通成本较低。</li>
</ul>
<h4 id="新型的microservice-1"><a href="#新型的microservice-1" class="headerlink" title="新型的microservice"></a>新型的microservice</h4><ul>
<li>代码结构简单，易于阅读；</li>
<li>需要大量的mock service，以完成功能性测试；</li>
<li>web技术上可能存在跨域问题；</li>
<li>系统对外依赖较重，交互频繁；</li>
<li>人员沟通成本巨大。</li>
</ul>
<h2 id="Service-Dependency-Management"><a href="#Service-Dependency-Management" class="headerlink" title="Service Dependency Management"></a>Service Dependency Management</h2><blockquote>
<p>既然服务之间的依赖很困扰，那么为何不学习maven或者gradle，将服务依赖统一管理起来？<br>Taobao中configServer是一个独立的中央管理服务器，其作用无非让应用知晓其他应用，然后去调用；这就是依赖！<br>而且假设不同服务是有版本号的，事实上很多人已经这么做了，这个实在太类似jar的依赖管理了。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Ryan Qian</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>






  <script src="/js/third-party/addtoany.js"></script>

  





</body>
</html>
